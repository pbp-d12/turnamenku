{% extends 'base.html' %}
{% load static %}

{% block title %}{% block page_title %}{% endblock page_title %} | Turnamenku{% endblock title %}

{% block content %}
<nav class="bg-custom-blue-400 shadow-lg">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-3">

            <a href="{% url 'main:home' %}" class="text-2xl font-bold">
                <span class="text-white">TURNAMEN</span>
                <span class="text-custom-blue-100">KU</span>
            </a>

            <ul class="hidden md:flex items-center space-x-6">
                <!-- test forums app: Hillary -->
                <li><a href="{% url 'forums:forum_index' %}" class="text-custom-blue-50 hover:text-white font-medium">Forums</a></li>
                <!-- end test forums app -->
                <!-- test predictions app: Rasyid -->
                <li><a href="{% url 'predictions:predictions_index' %}" class="text-custom-blue-50 hover:text-white font-medium">Predictions</a></li>
                <!-- end test predictions app -->
                <li><a href="{% url 'teams:show_main_teams' %}" class="text-custom-blue-50 hover:text-white font-medium">Teams</a></li>
                <li><a href="{% url 'tournaments:tournament_home' %}" class="text-custom-blue-50 hover:text-white font-medium">Tournaments</a></li>
            </ul>

            <div class="flex items-center space-x-3">
                {% if user.is_authenticated %}
                <div class="relative">
                    <button id="profile-menu-button" class="flex items-center space-x-2 group focus:outline-none">
                        <span class="text-white font-medium group-hover:text-custom-blue-100">
                            {{ user.username }}
                        </span>
                        <img class="w-9 h-9 rounded-full border-2 border-custom-blue-100 group-hover:border-white object-cover"
                            src="{{ user.profile.profile_picture_url_or_default }}"
                            data-default-src="{% static 'images/default_avatar.png' %}"
                            onerror="this.onerror=null; this.src=this.dataset.defaultSrc;"
                            alt="{{ user.username }} profile picture">
                    </button>

                    <div id="profile-menu-dropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 ring-1 ring-black ring-opacity-5">
                        <a href="{% url 'main:profile' username=user.username %}"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-custom-blue-50 hover:text-custom-blue-400">
                            Profil Saya
                        </a>
                        <a href="{% url 'main:edit_my_profile' %}"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-custom-blue-50 hover:text-custom-blue-400">
                            Edit Profil
                        </a>
                        <a href="{% url 'main:change_password' %}"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-custom-blue-50 hover:text-custom-blue-400">
                            Ganti Password
                        </a>
                        <div class="border-t border-gray-100 my-1"></div>
                        <button id="logout-button" data-logout-url="{% url 'main:logout' %}"
                            data-csrf="{{ csrf_token }}"
                            class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700">
                            Logout
                        </button>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'main:login' %}"
                    class="text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-custom-blue-300">
                    Login
                </a>
                <a href="{% url 'main:register' %}"
                    class="bg-white text-custom-blue-400 px-3 py-1.5 rounded-md text-sm font-bold hover:bg-custom-blue-50">
                    Register
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<main class="container mx-auto mt-8 p-4">
    {% if messages %}
    <script id="django-messages" type="application/json">
      [
        {% for message in messages %}
          {
            "message": "{{ message|escapejs }}",
            "tags": "{{ message.tags|escapejs }}"
          }
          {% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const messagesDataElement = document.getElementById('django-messages');
            if (messagesDataElement) {
                const messages = JSON.parse(messagesDataElement.textContent);
                messages.forEach(function (message) {
                    let type = message.tags;
                    if (type === 'warning') type = 'error';
                    if (typeof showToast === 'function') {
                        showToast(message.message, type);
                    }
                });
            }
        });
    </script>
    {% endif %}

    {% block main_content %}
    {% endblock main_content %}
</main>

{% endblock content %}
{% block javascript %}

<script>
    // ... (script logout kamu) ...
    document.addEventListener('DOMContentLoaded', function() {
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', async function () {
                const url = logoutButton.dataset.logoutUrl;
                const csrfToken = logoutButton.dataset.csrf;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        if (typeof showToast === 'function') showToast(data.message, 'success');
                        setTimeout(() => { window.location.href = data.redirect_url; }, 1000);
                    } else {
                        if (typeof showToast === 'function') showToast('Logout gagal.', 'error');
                    }
                } catch (error) {
                    if (typeof showToast === 'function') showToast('Terjadi kesalahan saat logout.', 'error');
                }
            });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const menuButton = document.getElementById('profile-menu-button');
        const dropdownMenu = document.getElementById('profile-menu-dropdown');

        if (menuButton && dropdownMenu) {
            menuButton.addEventListener('click', function (event) {
                event.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            window.addEventListener('click', function (event) {
                if (!menuButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }
    });
</script>

{% endblock javascript %}