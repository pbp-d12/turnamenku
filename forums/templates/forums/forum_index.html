{% extends 'layout_navbar.html' %}
{% load static %}
{% block page_title %}Pilih Forum{% endblock page_title %}

{% block main_content %}
<div class="max-w-6xl mx-auto p-4 md:p-8">
    
    <h1 class="text-3xl font-bold text-custom-blue-400 mb-6">
        Pilih Forum Turnamen
    </h1>

    <div class="mb-6">
        <input type="text" 
               id="search-tournaments" 
               placeholder="Cari turnamen..." 
               class="w-full px-4 py-3 border border-custom-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-custom-blue-300 focus:border-transparent transition-all duration-300 text-custom-blue-400 placeholder-custom-blue-200">
    </div>

    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
        <div class="p-8 text-center text-custom-blue-300" id="loading-state">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-custom-blue-400 mx-auto"></div>
            <p class="text-custom-blue-300 mt-4">Memuat turnamen...</p>
        </div>

        <div class="divide-y divide-custom-blue-50" id="tournaments-container">
            </div>
    </div>

    <nav id="pagination-container" class="mt-6 flex justify-center items-center space-x-1 hidden">
        </nav>
    
</div>
{% endblock main_content %}

{% block javascript %}
{{ block.super }} 
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('tournaments-container');
    const loadingState = document.getElementById('loading-state');
    const searchInput = document.getElementById('search-tournaments');
    const paginationContainer = document.getElementById('pagination-container');
    
    let currentPage = 1;
    let currentQuery = '';
    let isLoading = false;
    let totalPages = 1;

    function showLoading(message = 'Memuat turnamen...') {
        if (loadingState) loadingState.style.display = 'block';
    }

    function hideLoading() {
        if (loadingState) loadingState.style.display = 'none';
    }

    async function fetchTournaments(page = 1, query = '', isNewSearch = false) {
        if (isLoading) return;
        isLoading = true;

        showLoading();
        container.innerHTML = '';
        paginationContainer.classList.add('hidden'); 

        try {
            let apiUrl = `{% url 'forums:search_tournaments' %}?page=${page}`;
            if (query) {
                apiUrl += `&q=${encodeURIComponent(query)}`;
            }

            const response = await fetch(apiUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Gagal memuat data');

            const data = await response.json();
            const tournaments = data.tournaments;
            const pagination = data.pagination;
            hideLoading();

            if (tournaments && tournaments.length > 0) {
                tournaments.forEach(tournament => {
                    const tournamentHtml = createTournamentCard(tournament);
                    container.insertAdjacentHTML('beforeend', tournamentHtml);
                });

                currentPage = pagination.current_page;
                totalPages = pagination.total_pages;

                renderPagination(currentPage, totalPages);
                paginationContainer.classList.remove('hidden');

            } else if (page === 1) {
                container.innerHTML = `
                <div class="p-8 text-center text-custom-blue-300">
                    <p class="text-lg">${query ? 'Tidak ada turnamen yang sesuai dengan pencarian.' : 'Belum ada turnamen yang dibuat.'}</p>
                </div>
                `;
                paginationContainer.classList.add('hidden');
            }

        } catch (error) {
            console.error('Error:', error);
            hideLoading();

            if (page === 1) {
                container.innerHTML = `
                <div class="p-6 text-center text-red-500">
                    <p class="text-lg">Terjadi kesalahan saat memuat data.</p>
                    <button onclick="location.reload()" class="mt-4 bg-custom-blue-400 text-white px-4 py-2 rounded hover:bg-custom-blue-300">
                        Muat Ulang Halaman
                    </button>
                </div>
                `;
            } else {
                if (typeof showToast === 'function') {
                    showToast('Gagal memuat halaman baru.', 'error');
                }
                renderPagination(currentPage, totalPages);
                paginationContainer.classList.remove('hidden');
            }
            paginationContainer.classList.add('hidden');
        } finally {
            isLoading = false;
        }
    }
    
    function createTournamentCard(tournament) {
        const description = tournament.description || 'Tidak ada deskripsi';
        const startDate = tournament.start_date || 'Belum ditentukan';
        const endDate = tournament.end_date || 'Belum ditentukan';
        const organizer = tournament.organizer_username || 'Tidak diketahui';
        const participantCount = tournament.participant_count || 0;

        return `
        <a href="${tournament.url}" class="block p-6 hover:bg-custom-blue-50 transition-colors duration-150">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0 w-16 h-16 bg-custom-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-8 h-8 text-custom-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                
                <div class="flex-grow">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                        <h3 class="font-semibold text-xl text-custom-blue-400 hover:underline flex-grow">${tournament.name}</h3>
                        <span class="bg-custom-blue-400 text-white text-sm font-medium px-3 py-1 rounded-full whitespace-nowrap">
                            ${participantCount} Pemain
                        </span>
                    </div>
                    
                    <p class="text-custom-blue-300 mb-4 line-clamp-2">${description}</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm text-custom-blue-300">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="truncate">By ${organizer}</span>
                        </div>
                        
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span class="truncate">Mulai: ${startDate}</span>
                        </div>
                        
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span class="truncate">Selesai: ${endDate}</span>
                        </div>
                        
                        <div class="flex items-center justify-end sm:justify-start">
                            <span class="text-custom-blue-400 font-medium">Lihat Forum &rarr;</span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        `;
    }

    function createPageButton(page, text, isDisabled = false, isActive = false) {
        let classes = 'px-4 py-2 mx-0.5 rounded-lg transition-colors duration-150 text-sm font-medium ';
        
        if (isDisabled) {
            return `<span class="${classes} text-custom-blue-200 cursor-not-allowed">${text}</span>`;
        }
        if (isActive) {
            classes += 'bg-custom-blue-400 text-white cursor-default';
            return `<span class="${classes}">${text}</span>`;
        }
        classes += 'bg-white text-custom-blue-400 border border-custom-blue-200 hover:bg-custom-blue-50';
        return `<button data-page="${page}" class="${classes}">${text}</button>`;
    }

    function renderPagination(currentPage, totalPages) {
        paginationContainer.innerHTML = ''; 

        if (totalPages <= 1) {
            paginationContainer.classList.add('hidden');
            return;
        }

        let html = '';

        html += createPageButton(currentPage - 1, '&laquo; Prev', currentPage === 1);

        let pagesToShow = new Set();
        pagesToShow.add(1); 

        for (let i = -2; i <= 2; i++) {
            const page = currentPage + i;
            if (page > 1 && page < totalPages) {
                pagesToShow.add(page);
            }
        }
        pagesToShow.add(currentPage);
        
        pagesToShow.add(totalPages); 

        const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);
        
        let lastPage = 0;
        for (const page of sortedPages) {

            if (lastPage !== 0 && page > lastPage + 1) {
                html += `<span class="px-2 py-2 text-custom-blue-300">...</span>`;
            }
            html += createPageButton(page, page, false, page === currentPage);
            lastPage = page;
        }

        html += createPageButton(currentPage + 1, 'Next &raquo;', currentPage === totalPages);

        paginationContainer.innerHTML = html;
        paginationContainer.classList.remove('hidden'); 
    }

    function handlePaginationClick(e) {
        const target = e.target.closest('button[data-page]');
        if (!target) return; 

        target.disabled = true;

        const page = parseInt(target.dataset.page);
        if (page !== currentPage) {
            fetchTournaments(page, currentQuery);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentQuery = e.target.value.trim();
                currentPage = 1; 
                fetchTournaments(1, currentQuery, true);
            }, 500);
        });
    }

    paginationContainer.addEventListener('click', handlePaginationClick);
    
    fetchTournaments(1, '');
});
</script>
{% endblock javascript %}