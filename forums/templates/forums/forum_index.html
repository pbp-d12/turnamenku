{% extends 'layout_navbar.html' %}
{% load static %}
{% block page_title %}Pilih Forum{% endblock page_title %}

{% block main_content %}
<div class="max-w-6xl mx-auto p-4 md:p-8">

    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-custom-blue-400">
            Pilih Forum Turnamen
        </h1>
        {# Removed the misplaced Create Thread button #}
    </div>

    <div class="mb-4 relative">
        <label for="search-tournaments" class="sr-only">Cari Turnamen</label>
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
             <svg class="h-5 w-5 text-custom-blue-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
             </svg>
        </div>
        <input type="text"
               id="search-tournaments"
               placeholder="Cari nama atau deskripsi turnamen..."
               class="filter-input w-full pl-10 pr-4 py-3 border border-custom-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-custom-blue-300 focus:border-transparent transition-all duration-300 text-custom-blue-400 placeholder-custom-blue-200">
    </div>

    <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <button id="filter-modal-button" class="w-full sm:w-auto px-5 py-2 border border-custom-blue-300 text-custom-blue-400 font-medium rounded-lg hover:bg-custom-blue-50 transition-colors duration-200 flex items-center justify-center">
             <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
             Filter
             <span id="active-filter-count" class="ml-2 bg-custom-blue-400 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
        </button>

        <div class="w-full sm:w-auto flex items-center gap-2">
            <label for="sort-direction" class="text-sm font-medium text-custom-blue-300 whitespace-nowrap">Urutkan:</label>
             <select id="sort-direction" class="sort-input w-full sm:w-auto px-3 py-2 border border-custom-blue-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-custom-blue-300 text-sm bg-white appearance-none pr-8">
                 <option value="asc">Ascending (A-Z / Lama / Sedikit)</option>
                 <option value="desc">Descending (Z-A / Baru / Banyak)</option>
             </select>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-xl overflow-hidden min-h-[300px]">
        <div class="p-8 text-center text-custom-blue-300" id="loading-state">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-custom-blue-400 mx-auto"></div>
            <p class="text-custom-blue-300 mt-4">Memuat turnamen...</p>
        </div>
        <div class="divide-y divide-custom-blue-50" id="tournaments-container"></div>
    </div>

    <nav id="pagination-container" class="mt-6 flex justify-center items-center space-x-1 hidden"></nav>

    <div id="filter-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 ease-out opacity-0" data-state="closed">
      <div class="relative bg-white w-full max-w-lg mx-auto rounded-lg shadow-xl transform transition-transform duration-300 ease-out scale-95" data-state="closed">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6 pb-3 border-b border-custom-blue-100">
            <h3 class="text-xl font-semibold text-custom-blue-400">Filter Turnamen</h3>
            <button id="close-modal-button" class="text-custom-blue-300 hover:text-red-500 text-3xl leading-none focus:outline-none">&times;</button>
          </div>
          <div class="space-y-4">
            <div>
              <label for="modal-filter-organizer" class="block text-sm font-medium text-custom-blue-400 mb-1">Penyelenggara</label>
              <input type="text" id="modal-filter-organizer" placeholder="Username penyelenggara..." class="modal-input w-full px-3 py-2 border border-custom-blue-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-custom-blue-300 text-sm">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="modal-filter-start-date-after" class="block text-sm font-medium text-custom-blue-400 mb-1">Mulai Setelah Tgl</label>
                  <input type="date" id="modal-filter-start-date-after" class="modal-input w-full px-3 py-2 border border-custom-blue-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-custom-blue-300 text-sm text-custom-blue-400">
                </div>
                <div>
                  <label for="modal-filter-end-date-before" class="block text-sm font-medium text-custom-blue-400 mb-1">Selesai Sebelum Tgl</label>
                  <input type="date" id="modal-filter-end-date-before" class="modal-input w-full px-3 py-2 border border-custom-blue-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-custom-blue-300 text-sm text-custom-blue-400">
                </div>
            </div>
            <div>
              <label for="modal-filter-participants" class="block text-sm font-medium text-custom-blue-400 mb-1">Jumlah Pemain (Tepat)</label>
              <input type="number" id="modal-filter-participants" min="0" placeholder="Jumlah..." class="modal-input w-full px-3 py-2 border border-custom-blue-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-custom-blue-300 text-sm">
            </div>
             <div>
                 <label for="modal-primary-sort" class="block text-sm font-medium text-custom-blue-400 mb-1">Sortir Utama Saat Filter Aktif</label>
                 <select id="modal-primary-sort" class="modal-input w-full px-3 py-2 border border-custom-blue-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-custom-blue-300 text-sm bg-white">
                      <option value="name" selected>Nama Turnamen</option>
                      <option value="start_date">Tanggal Mulai</option>
                      <option value="participants">Jumlah Pemain</option>
                      <option value="organizer">Penyelenggara</option>
                 </select>
                 <p class="text-xs text-custom-blue-300 mt-1">Menentukan field mana yang diurutkan jika hanya 1 filter (selain search) aktif.</p>
             </div>
          </div>
          <div class="mt-6 pt-4 border-t border-custom-blue-100 flex justify-between items-center">
            <button id="clear-filters-button" class="px-4 py-2 border border-custom-blue-300 text-custom-blue-400 font-medium rounded-lg hover:bg-custom-blue-50 text-sm">Reset Filter</button>
            <button id="apply-filters-button" class="px-6 py-2 bg-custom-blue-400 text-white font-semibold rounded-lg hover:bg-custom-blue-300 text-sm">Terapkan Filter</button>
          </div>
        </div>
      </div>
    </div>

</div>
{% endblock main_content %}

{% block javascript %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('tournaments-container');
    const loadingState = document.getElementById('loading-state');
    const paginationContainer = document.getElementById('pagination-container');
    const searchInput = document.getElementById('search-tournaments');

    const filterModal = document.getElementById('filter-modal');
    const modalContent = filterModal.querySelector('.relative');
    const openModalButton = document.getElementById('filter-modal-button');
    const closeModalButton = document.getElementById('close-modal-button');
    const applyFiltersButton = document.getElementById('apply-filters-button');
    const clearFiltersButton = document.getElementById('clear-filters-button');
    const activeFilterCountBadge = document.getElementById('active-filter-count');

    const organizerInput = document.getElementById('modal-filter-organizer');
    const startDateAfterInput = document.getElementById('modal-filter-start-date-after');
    const endDateBeforeInput = document.getElementById('modal-filter-end-date-before');
    const participantsInput = document.getElementById('modal-filter-participants');
    const modalPrimarySortSelect = document.getElementById('modal-primary-sort');

    const sortDirectionSelect = document.getElementById('sort-direction');

    let currentPage = 1;
    let currentQuery = '';
    let currentOrganizer = '';
    let currentStartDateAfter = '';
    let currentEndDateBefore = '';
    let currentParticipants = '';
    let currentPrimarySortField = 'name';
    let currentSortDirection = 'asc';
    let isLoading = false;
    let totalPages = 1;
    let fetchTimeout;

    function openModal() {
        filterModal.classList.remove('hidden');
        filterModal.dataset.state = 'opening';
        requestAnimationFrame(() => {
             filterModal.style.opacity = '1';
             modalContent.style.transform = 'scale(1)';
             modalContent.dataset.state = 'open';
             filterModal.dataset.state = 'open';
        });
    }
    function closeModal() {
        filterModal.dataset.state = 'closing';
        modalContent.dataset.state = 'closing';
        filterModal.style.opacity = '0';
        modalContent.style.transform = 'scale(0.95)';
        setTimeout(() => {
            if (filterModal.dataset.state === 'closing') {
                 filterModal.classList.add('hidden');
                 filterModal.dataset.state = 'closed';
                 modalContent.dataset.state = 'closed';
            }
        }, 300);
    }
    openModalButton.addEventListener('click', openModal);
    closeModalButton.addEventListener('click', closeModal);
    filterModal.addEventListener('click', (e) => { if (e.target === filterModal) closeModal(); });

    function updateActiveFilterCount() {
         let count = 0;
         if (organizerInput.value.trim()) count++;
         if (startDateAfterInput.value) count++;
         if (endDateBeforeInput.value) count++;
         if (participantsInput.value.trim()) count++;

         activeFilterCountBadge.textContent = count;
         activeFilterCountBadge.classList.toggle('hidden', count === 0);
         return count;
    }

    applyFiltersButton.addEventListener('click', () => {
        currentPrimarySortField = modalPrimarySortSelect.value;
        updateActiveFilterCount();
        closeModal();
        triggerFetchWithDebounce(true);
    });

    clearFiltersButton.addEventListener('click', () => {
         organizerInput.value = '';
         startDateAfterInput.value = '';
         endDateBeforeInput.value = '';
         participantsInput.value = '';
         modalPrimarySortSelect.value = 'name';
         currentPrimarySortField = 'name';
         updateActiveFilterCount();
         closeModal();
         triggerFetchWithDebounce(true);
    });

    function showLoading() { if (loadingState) loadingState.style.display = 'block'; }
    function hideLoading() { if (loadingState) loadingState.style.display = 'none'; }

    async function fetchTournaments(page = 1, isNewFilterOrSort = false) {
        if (isLoading) return;
        isLoading = true;

        showLoading();
        if (isNewFilterOrSort || page === 1) { container.innerHTML = ''; }
        paginationContainer.classList.add('hidden');

        currentQuery = searchInput.value.trim();
        currentOrganizer = organizerInput.value.trim();
        currentStartDateAfter = startDateAfterInput.value;
        currentEndDateBefore = endDateBeforeInput.value;
        currentParticipants = participantsInput.value.trim();
        currentSortDirection = sortDirectionSelect.value;

        const activeFilterCount = updateActiveFilterCount();

        let finalSortParam;
        const sortPrefix = currentSortDirection === 'desc' ? '-' : '';

        if (activeFilterCount > 1) {
             finalSortParam = sortPrefix + 'name';
        } else if (activeFilterCount === 1) {
             let activeFilterFieldKey = 'name';
             if(currentOrganizer) activeFilterFieldKey = 'organizer';
             else if(currentStartDateAfter || currentEndDateBefore) activeFilterFieldKey = 'start_date';
             else if(currentParticipants) activeFilterFieldKey = 'participants';

             if (currentPrimarySortField === activeFilterFieldKey) {
                 finalSortParam = sortPrefix + currentPrimarySortField;
             } else if (currentPrimarySortField === 'name') {
                  finalSortParam = sortPrefix + 'name'; 
             }
             else {
                 finalSortParam = sortPrefix + 'name';
             }
        } else {
             finalSortParam = sortPrefix + 'name'; 
        }


        currentPage = page;

        try {
            const params = new URLSearchParams({ page: currentPage, sort: finalSortParam, primary_sort: currentPrimarySortField });
            if (currentQuery) params.append('q', currentQuery);
            if (currentOrganizer) params.append('organizer', currentOrganizer);
            if (currentStartDateAfter) params.append('start_date_after', currentStartDateAfter);
            if (currentEndDateBefore) params.append('end_date_before', currentEndDateBefore);
            if (currentParticipants) params.append('participants', currentParticipants);

            let apiUrl = `{% url 'forums:search_tournaments' %}?${params.toString()}`;

            const response = await fetch(apiUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error(`Gagal memuat data (${response.status})`);

            const data = await response.json();
            const tournaments = data.tournaments;
            const pagination = data.pagination;
            hideLoading();

            if (tournaments && tournaments.length > 0) {
                tournaments.forEach(tournament => {
                    container.insertAdjacentHTML('beforeend', createTournamentCard(tournament));
                });
                totalPages = pagination.total_pages;
                renderPagination(pagination.current_page, totalPages);
                paginationContainer.classList.remove('hidden');
            } else if (page === 1) {
                container.innerHTML = `<div class="p-8 text-center text-custom-blue-300"><p class="text-lg">Tidak ada turnamen yang sesuai.</p></div>`;
                paginationContainer.classList.add('hidden');
            } else {
                 paginationContainer.classList.add('hidden');
            }

        } catch (error) {
            console.error('Error fetching tournaments:', error);
            hideLoading();
            if (page === 1) {
                container.innerHTML = `<div class="p-6 text-center text-red-500"><p class="text-lg">Terjadi kesalahan: ${error.message}. Coba muat ulang.</p><button onclick="location.reload()" class="mt-4 bg-custom-blue-400 text-white px-4 py-2 rounded hover:bg-custom-blue-300">Muat Ulang</button></div>`;
            } else {
                if (typeof showToast === 'function') showToast(`Gagal memuat halaman ${page}.`, 'error');
                renderPagination(currentPage, totalPages);
                paginationContainer.classList.remove('hidden');
            }
        } finally {
            isLoading = false;
        }
    }

    function createTournamentCard(tournament) {
        const description = tournament.description || 'Tidak ada deskripsi';
        const startDate = tournament.start_date || 'Belum ditentukan';
        const endDate = tournament.end_date || 'Belum ditentukan';
        const organizer = tournament.organizer_username || 'Tidak diketahui';
        const participantCount = tournament.participant_count ?? '?';

        return `
        <a href="${tournament.url}" class="block p-6 hover:bg-custom-blue-50 transition-colors duration-150">
            <div class="flex flex-col md:flex-row items-start gap-x-6">
                <div class="flex-shrink-0 w-16 h-16 bg-custom-blue-100 rounded-lg flex items-center justify-center mb-4 md:mb-0">
                    <svg class="w-8 h-8 text-custom-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
                <div class="flex-grow">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                        <h3 class="font-semibold text-xl text-custom-blue-400 hover:underline flex-grow">${tournament.name}</h3>
                        <span class="bg-custom-blue-400 text-white text-sm font-medium px-3 py-1 rounded-full whitespace-nowrap">${participantCount} Pemain</span>
                    </div>
                    <p class="text-custom-blue-300 mb-4 line-clamp-2">${description}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm text-custom-blue-300">
                        <div class="flex items-center"><svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span class="truncate">Oleh ${organizer}</span></div>
                        <div class="flex items-center"><svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="truncate">Mulai: ${startDate}</span></div>
                        <div class="flex items-center"><svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="truncate">Selesai: ${endDate}</span></div>
                        <div class="flex items-center justify-end sm:justify-start"><span class="text-custom-blue-400 font-medium">Lihat Forum &rarr;</span></div>
                    </div>
                </div>
            </div>
        </a>`;
    }

    function createPageButton(page, text, isDisabled = false, isActive = false) {
        let classes = 'px-4 py-2 mx-0.5 rounded-lg transition-colors duration-150 text-sm font-medium ';
        if (isDisabled) return `<span class="${classes} text-custom-blue-200 cursor-not-allowed">${text}</span>`;
        if (isActive) { classes += 'bg-custom-blue-400 text-white cursor-default'; return `<span class="${classes}">${text}</span>`; }
        classes += 'bg-white text-custom-blue-400 border border-custom-blue-200 hover:bg-custom-blue-50';
        return `<button data-page="${page}" class="${classes}">${text}</button>`;
    }
    function renderPagination(page, total) {
        paginationContainer.innerHTML = '';
        if (total <= 1) { paginationContainer.classList.add('hidden'); return; }
        let html = '';
        html += createPageButton(page - 1, '&laquo; Prev', page === 1);
        let pagesToShow = new Set([1, total, page]);
        for (let i = -2; i <= 2; i++) { const p = page + i; if (p > 1 && p < total) pagesToShow.add(p); }
        const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);
        let lastPage = 0;
        for (const p of sortedPages) {
            if (lastPage !== 0 && p > lastPage + 1) html += `<span class="px-2 py-2 text-custom-blue-300">...</span>`;
            html += createPageButton(p, p, false, p === page);
            lastPage = p;
        }
        html += createPageButton(page + 1, 'Next &raquo;', page === total);
        paginationContainer.innerHTML = html;
        paginationContainer.classList.remove('hidden');
    }
    function handlePaginationClick(e) {
        const target = e.target.closest('button[data-page]');
        if (!target) return;
        target.disabled = true;
        const page = parseInt(target.dataset.page);
        if (page !== currentPage) {
            fetchTournaments(page, false);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
             target.disabled = false;
        }
    }

    function triggerFetchWithDebounce(isNewSearch = true) {
         clearTimeout(fetchTimeout);
         fetchTimeout = setTimeout(() => {
              fetchTournaments(1, isNewSearch);
         }, 400);
    }

    searchInput.addEventListener('input', () => triggerFetchWithDebounce());
    sortDirectionSelect.addEventListener('change', () => triggerFetchWithDebounce());

    paginationContainer.addEventListener('click', handlePaginationClick);

    updateActiveFilterCount();
    fetchTournaments(1, true);
});
</script>
{% endblock javascript %}