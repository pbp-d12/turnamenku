<div id="modal-join" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl relative">
    <div class="flex justify-between items-center pb-3 border-b border-gray-200">
      <h2 class="text-xl font-bold text-gray-800">Cari Tim untuk Bergabung</h2>
      <button onclick="closeModal('modal-join')"
        class="text-gray-500 hover:text-gray-900 focus:outline-none text-2xl transition">&times;</button>
    </div>

    <div class="py-4">
      <div class="relative mb-4">
        <input type="text" id="search-input" placeholder="Cari nama tim atau kapten..." onkeyup="searchJoinTeams(1)"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue-300 text-gray-900" />
      </div>
      <div id="teams-container" class="min-h-[200px] max-h-[60vh] overflow-y-auto space-y-3">
        <p class="text-gray-500 text-center py-5">Memuat tim...</p>
      </div>
      <div id="join-pagination" class="pagination flex justify-center space-x-3 pt-4"></div>
    </div>
  </div>
</div>

<div id="join-confirm-modal"
  class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white p-6 rounded-xl shadow-lg text-center w-full max-w-xs">
    <h3 id="join-modal-title" class="text-lg font-semibold text-gray-800 mb-4">Gabung ke tim ini?</h3>
    <div class="flex justify-center gap-4">
      <button id="join-confirm-btn"
        class="bg-custom-blue-400 text-white font-bold px-4 py-2 rounded-md hover:bg-custom-blue-300 transition w-full">Yoi</button>
      <button id="join-cancel-btn"
        class="bg-gray-300 text-gray-700 font-medium px-4 py-2 rounded-md hover:bg-gray-400 transition w-full">Ga</button>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById("search-input");
    // Debounce untuk onkeyup (opsional tapi bagus)
    let searchTimeout;
    if (searchInput) {
      searchInput.addEventListener('keyup', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchJoinTeams(1);
        }, 300); // Tunggu 300ms setelah user berhenti ngetik
      });
    }
  });

  async function searchJoinTeams(page = 1) {
    const query = document.getElementById("search-input")?.value.trim() || "";
    const container = document.getElementById("teams-container");
    const pagination = document.getElementById("join-pagination");

    if (!container || !pagination) return; // Pastikan elemen ada

    container.innerHTML = `<p class="text-gray-500 text-center py-5">Memuat...</p>`;
    pagination.innerHTML = "";

    try {
      const response = await fetch(`/teams/search/?mode=join&q=${encodeURIComponent(query)}&page=${page}`);
      const data = await response.json();

      if (data.status !== "success" || !data.results || data.results.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center py-5">Tidak ada tim yang ditemukan.</p>`;
        return;
      }

      // === render hasil tim ===
      container.innerHTML = data.results
        .map(
          (team) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl shadow-sm border border-gray-100" data-team-id="${team.id}">
            <div class="flex items-center space-x-3 overflow-hidden">
                <img src="${team.logo || DEFAULT_TEAM_LOGO}" alt="${team.name}" class="flex-shrink-0 w-10 h-10 rounded-full object-cover border border-gray-200">
                <div class="text-sm overflow-hidden">
                    <h3 class="font-semibold text-gray-800 truncate" title="${team.name}">${team.name}</h3>
                    <p class="text-gray-600 truncate">Kapten: ${team.captain || "N/A"}</p>
                    <p class="text-gray-500 text-xs">Anggota: ${team.members_count}</p>
                </div>
            </div>
            <div class="flex flex-col gap-2 flex-shrink-0 ml-2">
                <button class="bg-custom-blue-400 text-white text-xs px-3 py-1 rounded-md hover:bg-custom-blue-300 transition" onclick="joinTeam(${team.id}, '${team.name.replace(/'/g, "\\'")}')">Join</button>
            </div>
        </div>`
        )
        .join("");

      // === render pagination ===
      const p = data.pagination;
      let paginationHTML = "";
      if (p.has_previous)
        paginationHTML += `<button class="text-custom-blue-400 hover:text-custom-blue-300 font-semibold" onclick="searchJoinTeams(${p.current_page - 1})">&laquo; Prev</button>`;
      paginationHTML += `<span class="text-gray-600 text-sm"> Halaman ${p.current_page} dari ${p.total_pages} </span>`;
      if (p.has_next)
        paginationHTML += `<button class="text-custom-blue-400 hover:text-custom-blue-300 font-semibold" onclick="searchJoinTeams(${p.current_page + 1})">Next &raquo;</button>`;
      pagination.innerHTML = paginationHTML;

    } catch (error) {
      console.error(error);
      container.innerHTML = `<p class="text-red-500 text-center py-5">Error memuat tim.</p>`;
    }
  }

async function joinTeam(teamId, teamName) {
    const modal = document.getElementById("join-confirm-modal");
    if (!modal) return;

    modal.querySelector('#join-modal-title').textContent = `Gabung ke ${teamName}?`;

    const confirmBtn = document.getElementById("join-confirm-btn");
    const cancelBtn = document.getElementById("join-cancel-btn");

    modal.classList.remove('hidden');
    modal.classList.add('flex');

    cancelBtn.onclick = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
      newConfirmBtn.disabled = true;
      newConfirmBtn.textContent = "Joining...";

      try {
        // PERBAIKAN DI SINI: Tambah Content-Type application/json
        // Biar Django tau ini request API dan balikin JSON, bukan redirect HTML
        const response = await fetch(`${teamId}/join/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json", // <--- PENTING!
            "X-CSRFToken": getCSRFToken(),
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify({}) // Body kosong tapi format JSON valid
        });

        const data = await response.json();

        if (data.status === "success") {
          if (typeof showToast === 'function') showToast("Selamat anda sudah join!", "success");
          
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          
          if (typeof searchJoinTeams === 'function') searchJoinTeams(1);
          if (typeof searchMeetTeams === 'function') searchMeetTeams(1); 
        } else {
          const msg = data.message || "Gagal join";
          if (typeof showToast === 'function') showToast(msg, "error");
        }
      } catch (err) {
        console.error(err);
        if (typeof showToast === 'function') showToast("Error saat join tim.", "error");
      } finally {
        newConfirmBtn.disabled = false;
        newConfirmBtn.textContent = "Yoi";
      }
    };
  }
</script>