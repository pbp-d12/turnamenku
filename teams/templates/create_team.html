<div id="modal-create-team"
  class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative">

    <button onclick="closeModal('modal-create-team')"
      class="absolute right-3 top-3 text-gray-500 hover:text-gray-900 focus:outline-none transition text-2xl font-bold">&times;</button>

    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4 text-center">Buat Tim Baru</h2>

    <div id="create-team-error-container" class="mb-3"></div>

    <form id="create-team-form" method="POST" class="flex flex-col gap-4">
      {% csrf_token %}

      <label class="font-semibold text-sm text-gray-700">Nama Tim
        <input type="text" id="team-name" name="name" required placeholder="Masukkan nama tim"
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-blue-200 focus:border-custom-blue-300 transition text-gray-900">
        <div id="error-name" class="text-red-500 text-xs mt-1"></div>
      </label>

      <label class="font-semibold text-sm text-gray-700">URL Logo Tim (Opsional)
        <input type="url" id="team-logo" name="logo" placeholder="Masukkan URL logo (misal: https://...)"
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-blue-200 focus:border-custom-blue-300 transition text-gray-900">
        <div id="error-logo" class="text-red-500 text-xs mt-1"></div>
      </label>

      <div class="flex justify-center">
        <img id="logo-preview" src="" class="hidden w-20 h-20 object-cover mt-2 rounded-lg border border-gray-200">
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="closeModal('modal-create-team')"
          class="bg-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg hover:bg-gray-300 transition">Batal</button>
        <button type="submit" id="submit-create-team"
          class="bg-custom-blue-400 text-white font-bold px-4 py-2 rounded-lg hover:bg-custom-blue-300 transition">Buat</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const formCreateTeam = document.getElementById('create-team-form');
    const logoInput = document.getElementById('team-logo');
    const nameInput = document.getElementById('team-name');
    const previewImg = document.getElementById('logo-preview');

    if (logoInput) {
      logoInput.addEventListener('input', (e) => {
        const url = e.target.value.trim();
        if (url) {
          previewImg.src = url;
          previewImg.classList.remove('hidden');
          // Tambah error handling untuk preview
          previewImg.onerror = () => {
            previewImg.src = ''; // Hapus src jika error
            previewImg.classList.add('hidden'); // Sembunyikan jika error
          };
        } else {
          previewImg.src = '';
          previewImg.classList.add('hidden');
        }
      });
    }

    if (formCreateTeam) {
      formCreateTeam.addEventListener('submit', async function (ev) {
        ev.preventDefault();

        const submitBtn = document.getElementById('submit-create-team');
        const originalText = submitBtn.textContent;
        const errorContainer = document.getElementById('create-team-error-container');

        // Reset error state
        errorContainer.innerHTML = '';
        document.querySelectorAll('#create-team-form input').forEach(input => {
          input.classList.remove('border-red-500', 'focus:ring-red-500');
          const errorDiv = document.getElementById(`error-${input.name}`);
          if (errorDiv) errorDiv.textContent = '';
        });

        submitBtn.disabled = true;
        submitBtn.textContent = 'Membuat...';

        try {
          const csrf = document.querySelector('#create-team-form input[name="csrfmiddlewaretoken"]').value;

          // Kirim sebagai FORM-URLENCODED agar request.POST di Django bisa baca
          const payload = new URLSearchParams();
          payload.append('name', nameInput.value.trim());
          payload.append('logo', logoInput.value.trim());

          const resp = await fetch("create/", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrf,
              "X-Requested-With": "XMLHttpRequest"
            },
            body: payload.toString() // Kirim sebagai string
          });

          const data = await resp.json();

          if (resp.ok && data.status === 'success') {
            if (typeof showToast === 'function') showToast(data.message || 'Tim berhasil dibentuk!', 'success');
            formCreateTeam.reset();
            previewImg.src = '';
            previewImg.classList.add('hidden');
            if (typeof closeModal === 'function') closeModal('modal-create-team');

            // Refresh daftar tim di modal lain (jika fungsi ada)
            if (typeof searchJoinTeams === 'function') searchJoinTeams(1);
            if (typeof searchManageTeams === 'function') searchManageTeams(1);
            if (typeof searchMeetTeams === 'function') searchMeetTeams(1);
          }
          else if (!resp.ok || data.status === 'error') {
            const message = data && data.message ? data.message : 'Gagal membuat tim.';

            if (typeof showToast === 'function') showToast(message, 'error');

            // Tampilkan error spesifik per field
            if (data.errors && typeof data.errors === 'object') {
              Object.keys(data.errors).forEach(fieldName => {
                const fieldErrorDiv = document.getElementById(`error-${fieldName}`);
                const inputElement = document.getElementById(`team-${fieldName}`);

                if (inputElement) {
                  inputElement.classList.add('border-red-500', 'focus:ring-red-500');
                  inputElement.focus();
                }
                if (fieldErrorDiv && data.errors[fieldName].length > 0) {
                  fieldErrorDiv.textContent = data.errors[fieldName][0].message; // Ambil pesan error pertama
                }
              });
            }
          }
        } catch (err) {
          console.error('Create team error:', err);
          if (typeof showToast === 'function') showToast('Terjadi kesalahan jaringan atau server (500).', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
  });
</script>
