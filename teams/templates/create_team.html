<div id="modal-create-team"
  class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative">

    <button onclick="closeModal('modal-create-team')"
      class="absolute right-3 top-3 text-gray-500 hover:text-gray-900 focus:outline-none transition text-2xl font-bold">&times;</button>

    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4 text-center">Buat Tim Baru</h2>

    <div id="create-team-error-container" class="mb-3"></div>

    <form id="create-team-form" method="POST" class="flex flex-col gap-4">
      {% csrf_token %}

      <label class="font-semibold text-sm text-gray-700">Nama Tim
        <input type="text" id="team-name" name="name" required placeholder="Masukkan nama tim"
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-blue-200 focus:border-custom-blue-300 transition text-gray-900">
        <div id="error-name" class="text-red-500 text-xs mt-1"></div>
      </label>

      <label class="font-semibold text-sm text-gray-700">URL Logo Tim (Opsional)
        <input type="url" id="team-logo" name="logo" placeholder="Masukkan URL logo (misal: https://...)"
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-blue-200 focus:border-custom-blue-300 transition text-gray-900">
        <div id="error-logo" class="text-red-500 text-xs mt-1"></div>
      </label>

      <div class="flex justify-center">
        <img id="logo-preview" src="" class="hidden w-20 h-20 object-cover mt-2 rounded-lg border border-gray-200">
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="closeModal('modal-create-team')"
          class="bg-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg hover:bg-gray-300 transition">Batal</button>
        <button type="submit" id="submit-create-team"
          class="bg-custom-blue-400 text-white font-bold px-4 py-2 rounded-lg hover:bg-custom-blue-300 transition">Buat</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const formCreateTeam = document.getElementById('create-team-form');
    const logoInput = document.getElementById('team-logo');
    const nameInput = document.getElementById('team-name');
    const previewImg = document.getElementById('logo-preview');

    // Logic Preview Gambar
    if (logoInput) {
      logoInput.addEventListener('input', (e) => {
        const url = e.target.value.trim();
        if (url) {
          previewImg.src = url;
          previewImg.classList.remove('hidden');
          previewImg.onerror = () => {
            previewImg.src = ''; 
            previewImg.classList.add('hidden'); 
          };
        } else {
          previewImg.src = '';
          previewImg.classList.add('hidden');
        }
      });
    }

    // Logic Submit Form
    if (formCreateTeam) {
      formCreateTeam.addEventListener('submit', async function (ev) {
        ev.preventDefault(); // Stop reload bawaan form

        const submitBtn = document.getElementById('submit-create-team');
        const originalText = submitBtn.textContent;
        const errorContainer = document.getElementById('create-team-error-container');

        // Reset error styling
        errorContainer.innerHTML = '';
        document.querySelectorAll('#create-team-form input').forEach(input => {
          input.classList.remove('border-red-500', 'focus:ring-red-500');
          const errorDiv = document.getElementById(`error-${input.name}`);
          if (errorDiv) errorDiv.textContent = '';
        });

        submitBtn.disabled = true;
        submitBtn.textContent = 'Membuat...';

        try {
          const csrf = document.querySelector('#create-team-form input[name="csrfmiddlewaretoken"]').value;
          
          // --- PERUBAHAN UTAMA DI SINI ---
          // Kita kirim sebagai JSON, bukan Form Data.
          // Ini biar Django view balikin JsonResponse, bukan Redirect HTML.
          const payload = {
            name: nameInput.value.trim(),
            logo: logoInput.value.trim()
          };

          const resp = await fetch("{% url 'teams:team_flutter_api' %}", { // Arahkan ke endpoint API yang sama
            method: "POST",
            headers: {
              "Content-Type": "application/json", // Header JSON
              "X-CSRFToken": csrf,
              "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify(payload) // Body JSON String
          });

          // Sekarang responsenya pasti JSON, jadi aman di-decode
          const data = await resp.json();

          if (resp.ok && data.status === 'success') {
            // 1. Tampilkan Toast Sukses
            if (typeof showToast === 'function') {
                showToast(data.message || 'Tim berhasil dibentuk!', 'success');
            } else {
                alert("Tim berhasil dibentuk!"); // Fallback kalau ga ada fungsi toast
            }

            // 2. Reset Form
            formCreateTeam.reset();
            previewImg.src = '';
            previewImg.classList.add('hidden');

            // 3. Tutup Modal
            if (typeof closeModal === 'function') {
                closeModal('modal-create-team');
            }

            // 4. Refresh List di Modal Lain (Join/Manage) tanpa reload halaman utama
            if (typeof searchJoinTeams === 'function') searchJoinTeams(1);
            if (typeof searchManageTeams === 'function') searchManageTeams(1);
            if (typeof searchMeetTeams === 'function') searchMeetTeams(1);
            
            // Catatan: List utama di halaman (background) tidak akan berubah 
            // sampai di-reload manual, karena kita request "No Reload".
          } 
          else {
            // Handle Error
            const message = data.message || 'Gagal membuat tim.';
            if (typeof showToast === 'function') showToast(message, 'error');

            if (data.errors) {
               // Tampilkan error field (jika ada struktur error detail)
            }
          }

        } catch (err) {
          console.error('Create team error:', err);
          if (typeof showToast === 'function') showToast('Terjadi kesalahan sistem.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
  });
</script>
