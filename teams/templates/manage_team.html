<div id="modal-manage" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl relative">
    <div class="flex justify-between items-center pb-3 border-b border-gray-200">
      <h2 class="text-xl font-bold text-gray-800">Kelola Tim Kamu</h2>
      <button onclick="closeModal('modal-manage')"
        class="text-gray-500 hover:text-gray-900 focus:outline-none text-2xl transition">&times;</button>
    </div>
    <div class="py-4">
      <div class="relative mb-4">
        <input type="text" id="manage-search-input" placeholder="Cari tim yang kamu kapteni..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue-300 text-gray-900" />
      </div>
      <div id="manage-teams-container" class="min-h-[200px] max-h-[60vh] overflow-y-auto space-y-3">
        <p class="text-gray-500 text-center py-5">Memuat tim...</p>
      </div>
      <div class="pagination flex justify-center space-x-3 pt-4" id="manage-pagination"></div>
    </div>
  </div>
</div>

<div id="modal-configure" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-md rounded-xl p-6 shadow-2xl relative">
    <button onclick="closeModal('modal-configure')"
      class="absolute right-3 top-3 text-gray-500 hover:text-gray-900 focus:outline-none text-2xl transition">&times;</button>
    <h2 class="text-2xl font-bold text-custom-blue-400 mb-4 text-center">Konfigurasi Tim</h2>

    <input type="hidden" id="config-team-id" />
    <input type="hidden" id="config-team-name-original" />

    <div class="space-y-4">
      <label class="block font-semibold text-sm text-gray-700">Nama Tim:
        <input type="text" id="config-team-name"
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue-300 text-gray-900">
      </label>

      <label class="block font-semibold text-sm text-gray-700">URL Logo Tim:
        <input type="url" id="config-team-logo" placeholder="https://..."
          class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue-300 text-gray-900">
      </label>

      <h3 class="text-lg font-semibold text-gray-800 pt-3 border-t border-gray-200">Anggota</h3>
      <div id="members-list" class="max-h-48 overflow-y-auto border border-gray-200 p-3 rounded-lg space-y-2">
        <p class="text-gray-500 italic">Memuat anggota...</p>
      </div>
    </div>

    <div class="mt-6 flex flex-col sm:flex-row justify-between gap-3">
      <button id="save-config-btn" onclick="saveTeamConfig()"
        class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Simpan</button>
      <button onclick="closeModal('modal-configure')"
        class="w-full bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 transition order-last sm:order-none">Tutup</button>
      <button id="delete-team-btn" onclick="deleteTeamConfirm()"
        class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Hapus
        Tim</button>
    </div>
  </div>
</div>

<div id="modal-delete-confirm"
  class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[10000] flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative text-center">
    <h2 class="text-2xl font-bold text-red-600 mb-4">Peringatan!</h2>
    <p class="text-gray-700 mb-6">
      Yakin ingin menghapus tim <strong id="delete-confirm-team-name" class="text-gray-900"></strong>?
      <br>
      <span class="font-semibold">Aksi ini tidak bisa dibatalkan.</span>
    </p>
    <div class="flex justify-center gap-4">
      <button id="delete-confirm-yes"
        class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
        Ya, Hapus
      </button>
      <button id="delete-confirm-no"
        class="w-full bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 transition">
        Batal
      </button>
    </div>
  </div>
</div>


<div id="modal-kick-confirm" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[10000] flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative text-center">
    <h2 class="text-2xl font-bold text-red-600 mb-4">Kick Member?</h2>
    <p class="text-gray-700 mb-6">
      Yakin ingin mengeluarkan <strong id="kick-confirm-member-name" class="text-gray-900"></strong> dari tim?
    </p>
    <div class="flex justify-center gap-4">
      <button id="kick-confirm-yes" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
        Ya, Kick
      </button>
      <button id="kick-confirm-no" class="w-full bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 transition">
        Batal
      </button>
    </div>
  </div>
</div>

<script>
  // --- FUNGSI HELPER JSON FETCH ---
  // Kita bungkus fetch biar otomatis pake header JSON & handle response
  async function fetchJson(url, options = {}) {
    const defaultHeaders = {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken(),
      "X-Requested-With": "XMLHttpRequest"
    };

    options.headers = { ...defaultHeaders, ...options.headers };
    
    // Pastikan body dikirim sebagai string JSON
    if (options.body && typeof options.body === 'object') {
      options.body = JSON.stringify(options.body);
    }

    const resp = await fetch(url, options);
    return await resp.json(); // Backend kita sekarang pasti balikin JSON
  }

  // --- LOGIKA UTAMA ---
  document.addEventListener('DOMContentLoaded', function () {
    const manageSearchInput = document.getElementById("manage-search-input");
    let manageSearchTimeout;
    if (manageSearchInput) {
      manageSearchInput.addEventListener('keyup', () => {
        clearTimeout(manageSearchTimeout);
        manageSearchTimeout = setTimeout(() => {
          searchManageTeams(1);
        }, 300);
      });
    }
  });

  // --- SEARCH MANAGE ---
  async function searchManageTeams(page = 1) {
    const input = document.getElementById("manage-search-input");
    const container = document.getElementById("manage-teams-container");
    const pagination = document.getElementById("manage-pagination");

    const query = input?.value.trim() || "";
    if (!container || !pagination) return;
    
    // Jangan hapus loading kalau search bar kosong
    // container.innerHTML = `<p class="text-gray-500 text-center py-5">Memuat...</p>`;
    // pagination.innerHTML = "";

    try {
      // Pake fetch biasa (GET) karena ini search
      const response = await fetch(`/teams/search/?mode=manage&q=${encodeURIComponent(query)}&page=${page}`);
      const data = await response.json();

      if (data.status !== "success" || !data.results || data.results.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center py-5">Kamu bukan kapten dari tim manapun.</p>`;
        pagination.innerHTML = "";
        return;
      }

      container.innerHTML = data.results.map((team) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl shadow-sm border border-gray-100" data-team-id="${team.id}">
            <div class="flex items-center space-x-3 overflow-hidden">
                <img src="${team.logo || DEFAULT_TEAM_LOGO}" alt="${team.name}" class="flex-shrink-0 w-10 h-10 rounded-full object-cover border border-gray-200">
                <div class="text-sm overflow-hidden">
                    <h3 class="font-semibold text-gray-800 truncate" title="${team.name}">${team.name}</h3>
                    <p class="text-gray-500 text-xs">Anggota: ${team.members_count}</p>
                </div>
            </div>
            <button class="bg-custom-blue-400 text-white text-xs px-3 py-1 rounded-md hover:bg-custom-blue-300 transition" 
                    onclick="openModal('modal-configure', ${team.id})">Kelola</button>
        </div>`
      ).join("");

      // Pagination render (sama kayak sebelumnya)
      const p = data.pagination;
      let paginationHTML = "";
      if (p.has_previous) paginationHTML += `<button class="text-custom-blue-400 font-bold" onclick="searchManageTeams(${p.current_page - 1})">&laquo;</button>`;
      paginationHTML += `<span class="text-gray-600 text-sm mx-2">Hal ${p.current_page}</span>`;
      if (p.has_next) paginationHTML += `<button class="text-custom-blue-400 font-bold" onclick="searchManageTeams(${p.current_page + 1})">&raquo;</button>`;
      pagination.innerHTML = paginationHTML;

    } catch (error) {
      console.error(error);
      container.innerHTML = `<p class="text-red-500 text-center py-5">Error memuat tim.</p>`;
    }
  }

  // --- OPEN MODAL CONFIGURE ---
  async function openConfigureModal(teamId) {
    document.getElementById("config-team-id").value = teamId;
    const membersList = document.getElementById("members-list");
    membersList.innerHTML = `<p class="text-gray-500 italic">Memuat anggota...</p>`;

    try {
      const response = await fetch(`/teams/json/${teamId}/`);
      const team = await response.json();

      document.getElementById("config-team-name").value = team.name;
      document.getElementById("config-team-name-original").value = team.name;
      document.getElementById("config-team-logo").value = team.logo || '';

      renderMembers(team.members, teamId);
    } catch (error) {
      console.error(error);
      membersList.innerHTML = `<p class="text-red-500 italic">Gagal memuat tim.</p>`;
    }
  }

  // --- RENDER MEMBER LIST ---
  function renderMembers(members, teamId) {
    const container = document.getElementById("members-list");
    if (!members || members.length === 0) {
      container.innerHTML = `<p class="text-gray-500 italic">Belum ada anggota.</p>`;
      return;
    }
    // Escape string biar aman kalau nama member ada kutip
    container.innerHTML = members.map((memberUsername) => {
        const safeUsername = memberUsername.replace(/'/g, "\\'"); 
        return `
          <div class="flex justify-between items-center py-1.5 border-b border-gray-100 last:border-b-0">
              <span class="text-gray-800">${memberUsername}</span>
              <button class="text-red-500 hover:text-red-700 text-sm font-semibold focus:outline-none" 
                      onclick="kickMemberConfirm(${teamId}, '${safeUsername}')">Kick</button>
          </div>`;
    }).join("");
  }

  // --- SAVE EDIT (FIXED TOAST & JSON) ---
  async function saveTeamConfig() {
    const teamId = document.getElementById("config-team-id").value;
    const name = document.getElementById("config-team-name").value.trim();
    const logo = document.getElementById("config-team-logo").value.trim();
    const btn = document.getElementById("save-config-btn");

    if (!name) {
      if (typeof showToast === 'function') showToast('Nama tim tidak boleh kosong', 'error');
      return;
    }

    btn.disabled = true;
    btn.textContent = "Menyimpan...";

    try {
      // Pake JSON Payload
      const data = await fetchJson(`/teams/${teamId}/edit/`, {
        method: "POST",
        body: { name: name, logo: logo }
      });

      if (data.status === "success") {
        if (typeof showToast === 'function') showToast("Tim berhasil diperbarui!", "success");
        if (typeof closeModal === 'function') closeModal("modal-configure");
        if (typeof searchManageTeams === 'function') searchManageTeams(1);
      } else {
        if (typeof showToast === 'function') showToast(data.message || "Gagal menyimpan", "error");
      }
    } catch (error) {
      console.error(error);
      if (typeof showToast === 'function') showToast("Error saat menyimpan.", "error");
    } finally {
      btn.disabled = false;
      btn.textContent = "Simpan";
    }
  }

  // --- KICK MEMBER (FIXED MODAL & JSON) ---
  function kickMemberConfirm(teamId, memberUsername) {
    const modal = document.getElementById("modal-kick-confirm");
    const nameSpan = document.getElementById("kick-confirm-member-name");
    const btnYes = document.getElementById("kick-confirm-yes");
    const btnNo = document.getElementById("kick-confirm-no");

    if (!modal) return; // Safety check

    nameSpan.textContent = memberUsername;
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    btnNo.onclick = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    // Clone button to remove old listeners
    const newBtnYes = btnYes.cloneNode(true);
    btnYes.parentNode.replaceChild(newBtnYes, btnYes);

    newBtnYes.onclick = async () => {
        newBtnYes.disabled = true;
        newBtnYes.textContent = "Kicking...";

        try {
            const data = await fetchJson(`/teams/${teamId}/member/${memberUsername}/delete/`, {
                method: "POST",
                body: {} // Empty JSON body
            });

            if (data.status === "success") {
                if (typeof showToast === 'function') showToast("Anggota berhasil dikeluarkan", "success");
                // Refresh list member di modal config (bukan tutup modal)
                // Kita perlu fetch ulang detail tim buat dapet list member terbaru
                openConfigureModal(teamId); 
            } else {
                if (typeof showToast === 'function') showToast(data.message || "Gagal kick", "error");
            }
        } catch (error) {
            console.error("Kick error:", error);
            if (typeof showToast === 'function') showToast("Error koneksi.", "error");
        } finally {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            newBtnYes.disabled = false;
            newBtnYes.textContent = "Ya, Kick";
        }
    };
  }

  // --- DELETE TEAM (FIXED JSON) ---
  async function deleteTeamConfirm() {
    const teamId = document.getElementById("config-team-id").value;
    const teamName = document.getElementById("config-team-name").value;
    const btn = document.getElementById("delete-team-btn");

    const modalDelete = document.getElementById("modal-delete-confirm");
    const modalDeleteName = document.getElementById("delete-confirm-team-name");
    const btnYes = document.getElementById("delete-confirm-yes");
    const btnNo = document.getElementById("delete-confirm-no");

    modalDeleteName.textContent = `"${teamName}"`;
    modalDelete.classList.remove('hidden');
    modalDelete.classList.add('flex');

    btnNo.onclick = () => {
      modalDelete.classList.add('hidden');
      modalDelete.classList.remove('flex');
    };

    const newBtnYes = btnYes.cloneNode(true);
    btnYes.parentNode.replaceChild(newBtnYes, btnYes);

    newBtnYes.onclick = async () => {
      btn.disabled = true;
      newBtnYes.disabled = true;
      newBtnYes.textContent = "Menghapus...";

      try {
        const data = await fetchJson(`/teams/${teamId}/delete/`, {
            method: "POST",
            body: {}
        });

        if (data.status === "success") {
          if (typeof showToast === 'function') showToast("Tim berhasil dihapus", "success");
          if (typeof closeModal === 'function') closeModal("modal-configure"); 
          if (typeof searchManageTeams === 'function') searchManageTeams(1); 
        } else {
          if (typeof showToast === 'function') showToast(data.message || "Gagal menghapus", "error");
        }
      } catch (error) {
        console.error(error);
        if (typeof showToast === 'function') showToast("Error saat menghapus.", "error");
      } finally {
        modalDelete.classList.add('hidden');
        modalDelete.classList.remove('flex');
        btn.disabled = false;
        newBtnYes.disabled = false;
        newBtnYes.textContent = "Ya, Hapus";
      }
    }; 
  }
</script>