<div id="modal-manage" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Manage Your Teams</h2>
      <button onclick="closeModal('modal-manage')">&times;</button>
    </div>

    <div class="modal-body">
      <div class="search-bar">
        <input
          type="text"
          id="manage-search-input"
          placeholder="Search your teams..."
          onkeyup="searchManageTeams(1)"
        />
      </div>

      <div id="manage-teams-container"></div>
      <div class="pagination" id="manage-pagination"></div>
    </div>
  </div>
</div>

<div id="modal-configure" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Configure Team</h2>
      <button onclick="closeModal('modal-configure')">&times;</button>
    </div>

    <div class="modal-body">
      <form id="configure-form" onsubmit="event.preventDefault(); saveTeamConfig();">
        <input type="hidden" id="config-team-id" />

        <div class="form-group">
          <label>Team Name</label>
          <input type="text" id="config-team-name" required />
        </div>

        <div class="form-group">
          <label>Team Logo</label>
          <input type="file" id="config-team-logo" accept="image/*" />
        </div>

        <h3>Team Members</h3>
        <div id="members-list"></div>

        <div class="form-actions">
          <button type="submit" class="action-btn">Save Changes</button>
          <button
            type="button"
            class="action-btn"
            style="background: #f44336;"
            onclick="deleteTeamConfirm()"
          >
            Delete Team
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
async function searchManageTeams(page = 1) {
  const input = document.getElementById("manage-search-input");
  const container = document.getElementById("manage-teams-container");
  const pagination = document.getElementById("manage-pagination");

  const query = input?.value.trim() || "";
  container.innerHTML = `<p class="loading">Loading...</p>`;
  pagination.innerHTML = "";

  try {
    const response = await fetch(`/teams/search/?mode=manage&q=${encodeURIComponent(query)}&page=${page}`);
    const data = await response.json();

    if (data.status !== "success" || data.results.length === 0) {
      container.innerHTML = `<p class="loading">Your not a captain.</p>`;
      return;
    }

    container.innerHTML = data.results
      .map(
        (team) => `
        <div class="team-card">
          <div class="team-info">
            ${
              team.logo
                ? `<img src="${team.logo}" class="team-avatar" alt="${team.name}">`
                : `<div class="team-avatar"></div>`
            }
            <div class="team-text">
              <h3>${team.name}</h3>
              <p>Members: ${team.members_count}</p>
            </div>
          </div>
          <div class="team-actions">
            <button class="action-btn" onclick="openConfigureModal(${team.id})">Configure</button>
          </div>
        </div>`
      )
      .join("");

    // Pagination
    const p = data.pagination;
    let paginationHTML = "";
    if (p.has_previous)
      paginationHTML += `<button onclick="searchManageTeams(${p.current_page - 1})">&laquo; Prev</button>`;
    paginationHTML += `<span> Page ${p.current_page} of ${p.total_pages} </span>`;
    if (p.has_next)
      paginationHTML += `<button onclick="searchManageTeams(${p.current_page + 1})">Next &raquo;</button>`;
    pagination.innerHTML = paginationHTML;
  } catch (error) {
    console.error(error);
    container.innerHTML = `<p class="loading">Error loading teams.</p>`;
  }
}


async function openConfigureModal(teamId) {
  openModal("modal-configure");
  document.getElementById("config-team-id").value = teamId;
  document.getElementById("members-list").innerHTML = `<p class="loading">Loading members...</p>`;

  try {
    const response = await fetch(`/teams/${teamId}/json/`);
    const team = await response.json();

    document.getElementById("config-team-name").value = team.name;

    const membersHTML = team.members
      .map(
        (m) => `
        <div class="member-item">
          <span>${m}</span>
          <button onclick="removeMember(${team.id}, '${m}')">Remove</button>
        </div>`
      )
      .join("");
    document.getElementById("members-list").innerHTML = membersHTML || "<p>No members yet.</p>";
  } catch (error) {
    console.error(error);
    document.getElementById("members-list").innerHTML = `<p>Error loading team.</p>`;
  }
}

async function saveTeamConfig() {
  const teamId = document.getElementById("config-team-id").value;
  const name = document.getElementById("config-team-name").value;
  const logo = document.getElementById("config-team-logo").files[0];

  const formData = new FormData();
  formData.append("name", name);
  if (logo) formData.append("logo", logo);

  try {
    const response = await fetch(`/teams/${teamId}/edit/`, {
      method: "POST",
      body: formData,
      headers: { "X-CSRFToken": getCSRFToken() },
    });
    const data = await response.json();
    if (data.status === "success") {
      alert("Team updated!");
      closeModal("modal-configure");
      searchTeams(1, "manage");
    } else {
      alert("Failed to save changes.");
    }
  } catch (error) {
    console.error(error);
    alert("Error saving team.");
  }
}

async function deleteTeamConfirm() {
  const teamId = document.getElementById("config-team-id").value;
  if (!confirm("Are you sure you want to delete this team?")) return;

  try {
    const response = await fetch(`/teams/${teamId}/delete/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRFToken() },
    });
    const data = await response.json();
    if (data.status === "success") {
      alert("Team deleted.");
      closeModal("modal-configure");
      searchTeams(1, "manage");
    } else {
      alert("Delete failed.");
    }
  } catch (error) {
    console.error(error);
    alert("Error deleting team.");
  }
}

function getCSRFToken() {
  const cookieValue = document.cookie
    .split("; ")
    .find((row) => row.startsWith("csrftoken="))
    ?.split("=")[1];
  return cookieValue || "";
}
</script>
