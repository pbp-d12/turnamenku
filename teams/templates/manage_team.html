<div id="modal-manage" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Manage Your Teams</h2>
      <button onclick="closeModal('modal-manage')">&times;</button>
    </div>

    <div class="modal-body">
      <div class="search-bar">
        <input
          type="text"
          id="manage-search-input"
          placeholder="Search your teams..."
          onkeyup="searchTeams(1, 'manage')"
        />
      </div>

      <div id="manage-teams-container"></div>
      <div class="pagination" id="manage-pagination"></div>
    </div>
  </div>
</div>

<div id="modal-configure" 
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); 
            z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; width:420px; padding:20px; border-radius:12px; 
              box-shadow:0 4px 20px rgba(0,0,0,0.3); position:relative;">
    <h2 style="margin-top:0; font-size:20px; text-align:center;">Configure Team</h2>

    <input type="hidden" id="config-team-id" />

    <label style="display:block; margin-top:12px;">Team Name:</label>
    <input type="text" id="config-team-name" 
           style="width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:6px;">

    <label style="display:block; margin-top:12px;">Team Logo:</label>
    <input type="file" id="config-team-logo" 
           style="width:100%; margin-top:4px; border-radius:6px;">

    <h3 style="margin-top:16px;">Members</h3>
    <div id="members-list" 
         style="max-height:180px; overflow-y:auto; margin-top:6px;">
      <p style="color:#777; font-size:14px;">Loading...</p>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:space-between;">
      <button onclick="saveTeamConfig()" 
              style="background:#4CAF50; color:white; border:none; padding:8px 16px; 
                     border-radius:6px; cursor:pointer;">Save</button>
      <button onclick="deleteTeamConfirm()" 
              style="background:#f44336; color:white; border:none; padding:8px 16px; 
                     border-radius:6px; cursor:pointer;">Delete</button>
      <button onclick="closeModal('modal-configure')" 
              style="background:#888; color:white; border:none; padding:8px 16px; 
                     border-radius:6px; cursor:pointer;">Close</button>
    </div>
  </div>
</div>


<script>
async function searchManageTeams(page = 1) {
  const input = document.getElementById("manage-search-input");
  const container = document.getElementById("manage-teams-container");
  const pagination = document.getElementById("manage-pagination");

  const query = input?.value.trim() || "";
  container.innerHTML = `<p class="loading">Loading...</p>`;
  pagination.innerHTML = "";

  try {
    const response = await fetch(`/teams/search/?mode=manage&q=${encodeURIComponent(query)}&page=${page}`);
    const data = await response.json();

    if (data.status !== "success" || data.results.length === 0) {
      container.innerHTML = `<p class="loading">You're not a captain.</p>`;
      return;
    }

    container.innerHTML = data.results
      .map(
        (team) => `
        <div class="team-card">
          <div class="team-info">
            ${
              team.logo
                ? `<img src="${team.logo || 'https://img.icons8.com/?size=100&id=uMMzE4KzgxCO&format=png&color=000000'}" class="team-avatar" alt="${team.name}">`
                : `<img src="${team.logo || 'https://img.icons8.com/?size=100&id=uMMzE4KzgxCO&format=png&color=000000'}" class="team-avatar" alt="${team.name}">`
            }
            <div class="team-text">
              <h3>${team.name}</h3>
              <p>Members: ${team.members_count}</p>
            </div>
          </div>
          <div class="team-actions">
            <button class="action-btn" onclick="openModal('modal-configure', ${team.id})">Configure</button>
          </div>
        </div>`
      )
      .join("");

    const p = data.pagination;
    let paginationHTML = "";
    if (p.has_previous)
      paginationHTML += `<button onclick="searchManageTeams(${p.current_page - 1})">&laquo; Prev</button>`;
    paginationHTML += `<span> Page ${p.current_page} of ${p.total_pages} </span>`;
    if (p.has_next)
      paginationHTML += `<button onclick="searchManageTeams(${p.current_page + 1})">Next &raquo;</button>`;
    pagination.innerHTML = paginationHTML;
  } catch (error) {
    console.error(error);
    container.innerHTML = `<p class="loading">Error loading teams.</p>`;
  }
}

async function openConfigureModal(teamId) {
  document.getElementById("config-team-id").value = teamId;
  document.getElementById("members-list").innerHTML = `<p class="loading">Loading members...</p>`;

  try {
    const response = await fetch(`json/${teamId}/`);
    const team = await response.json();
    console.log(team);

    document.getElementById("config-team-name").value = team.name;

    const membersHTML = team.members
      .map(
        (m) => `
        <div class="member-item flex justify-between items-center py-1 border-b">
          <span>${m}</span>
          <button style="text-color:red" onclick="kickMember(${team.id}, '${m}')">Kick</button>
        </div>`
      )
      .join("");
    document.getElementById("members-list").innerHTML = membersHTML || "<p>No members yet.</p>";
  } catch (error) {
    console.error(error);
    document.getElementById("members-list").innerHTML = `<p>Error loading team.</p>`;
  }
}

function renderMembers(members, teamId) {
  const container = document.getElementById("members-list");
  if (!members || members.length === 0) {
    container.innerHTML = `<p style="color:#777;">No members yet.</p>`;
    return;
  }

  container.innerHTML = members
    .map(
      (m) => `
      <div style="display:flex; justify-content:space-between; align-items:center; 
                  padding:4px 0; border-bottom:1px solid #eee;">
        <span style="font-size:15px;">${m.name || m}</span>
        <span onclick="kickMember('${teamId}', '${m.id || m}')"
              style="color:#f44336; cursor:pointer; font-weight:500;">Kick</span>
      </div>`
    )
    .join("");
}

async function kickMember(teamId, memberUsername) {
  try {
    const response = await fetch(`/teams/${teamId}/member/${memberUsername}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest",
      },
    });

    const data = await response.json();
    if (data.status === "success") {
      showToast("Hore dia pergi!", "success");
      renderMembers(data.members, teamId);
    } else {
      showToast(data.message || "Gagal mengeluarkan dia", "error");
    }
  } catch (error) {
    console.error(error);
    showToast("Gagal mengeluarkan dia", "error");
  }
}


async function saveTeamConfig() {
  const teamId = document.getElementById("config-team-id").value;
  const name = document.getElementById("config-team-name").value;
  const logo = document.getElementById("config-team-logo").files[0];

  const formData = new FormData();
  formData.append("name", name);
  if (logo) formData.append("logo", logo);

  try {
    const response = await fetch(`/teams/${teamId}/edit/`, {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": getCSRFToken(),
        // jangan tambahkan Content-Type manual! biar FormData atur boundary-nya
      },
    });

    const data = await response.json();

    if (data.status === "success") {
      showToast("Nice dah mantap nih!", "success");
      closeModal("modal-configure");
      searchManageTeams(1);
    } else {
      showToast("Gagal ganti ni: " + (data.message || "Unknown error"), "error");
    }
  } catch (error) {
    console.error(error);
    showToast("Error saving team.", "error");
  }
}

async function deleteTeamConfirm() {
  const teamId = document.getElementById("config-team-id").value;
  if (!confirm("Are you sure you want to delete this team?")) return;

  try {
    const response = await fetch(`/teams/${teamId}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ confirm: true }),
    });

    const data = await response.json();

    if (data.status === "success") {
      showToast("Selamat tinggal teman-teman", "success");
      closeModal("modal-configure");
      searchManageTeams(1);
    } else {
      showToast("Lohee gagal: " + (data.message || ""), "error");
    }
  } catch (error) {
    console.error(error);
    showToast("Error deleting team.", "error");
  }
}

function getCSRFToken() {
  const match = document.cookie.match(/csrftoken=([^;]+)/);
  return match ? match[1] : "";
}
</script>
