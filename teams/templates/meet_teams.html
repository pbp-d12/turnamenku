<div id="modal-meet" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl relative">
    <div class="flex justify-between items-center pb-3 border-b border-gray-200">
      <h2 class="text-xl font-bold text-gray-800">Tim yang Kamu Ikuti</h2>
      <button onclick="closeModal('modal-meet')"
        class="text-gray-500 hover:text-gray-900 focus:outline-none text-2xl transition">&times;</button>
    </div>
    <div class="py-4">
      <div class="relative mb-4">
        <input type="text" id="meet-search-input" placeholder="Cari timmu..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue-300 text-gray-900" />
      </div>
      <div id="meet-teams-container" class="min-h-[200px] max-h-[60vh] overflow-y-auto space-y-3">
        <p class="text-gray-500 text-center py-5">Memuat tim...</p>
      </div>
      <div class="pagination flex justify-center space-x-3 pt-4" id="meet-pagination"></div>
    </div>
  </div>
</div>

<div id="modal-meet-detail"
  class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center hidden">
  <div class="bg-white w-full max-w-md rounded-xl p-6 shadow-2xl relative text-center">

    <button id="close-meet-detail-btn"
      class="absolute right-3 top-3 text-gray-500 hover:text-gray-900 focus:outline-none text-2xl transition">&times;</button>

    <div id="meet-detail-content">
      <h2 class="text-xl font-bold text-gray-800">Memuat Detail Tim...</h2>
    </div>

    <button id="leave-team-btn"
      class="mt-6 w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition hidden">
      Keluar dari Tim
    </button>

    <div id="leave-confirm-overlay"
      class="absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl text-gray-800 border border-gray-200">
        <p class="mb-4 text-lg font-semibold">Yakin ingin keluar dari tim <strong
            id="leave-confirm-team-name"></strong>?</p>
        <div class="mt-4 flex justify-center gap-3">
          <button id="confirmLeaveYes"
            class="bg-red-600 text-white font-bold px-5 py-2 rounded-md hover:bg-red-700 transition">Ya, Keluar</button>
          <button id="confirmLeaveNo"
            class="bg-gray-300 text-gray-700 font-medium px-5 py-2 rounded-md hover:bg-gray-400 transition">Batal</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const meetSearchInput = document.getElementById("meet-search-input");
    let meetSearchTimeout;
    if (meetSearchInput) {
      meetSearchInput.addEventListener('keyup', () => {
        clearTimeout(meetSearchTimeout);
        meetSearchTimeout = setTimeout(() => {
          searchMeetTeams(1);
        }, 300);
      });
    }

    const modal = document.getElementById("modal-meet-detail");
    const closeBtn = document.getElementById("close-meet-detail-btn");
    if (modal && closeBtn) {
      closeBtn.onclick = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      };
    }
  });

  async function searchMeetTeams(page = 1) {
    const query = document.getElementById("meet-search-input")?.value.trim() || "";
    const container = document.getElementById("meet-teams-container");
    const pagination = document.getElementById("meet-pagination");

    if (!container || !pagination) return;
    container.innerHTML = `<p class="text-gray-500 text-center py-5">Memuat tim...</p>`;
    pagination.innerHTML = "";

    try {
      const response = await fetch(`/teams/search/?mode=meet&q=${encodeURIComponent(query)}&page=${page}`);
      const data = await response.json();

      if (data.status !== "success" || !data.results || data.results.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center py-5">Kamu belum bergabung di tim manapun.</p>`;
        return;
      }

      container.innerHTML = data.results.map((team) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl shadow-sm border border-gray-100" data-team-id="${team.id}">
                <div class="flex items-center space-x-3 overflow-hidden">
                    <img src="${team.logo || DEFAULT_TEAM_LOGO}" alt="${team.name}" class="flex-shrink-0 w-10 h-10 rounded-full object-cover border border-gray-200">
                    <div class="text-sm overflow-hidden">
                        <h3 class="font-semibold text-gray-800 truncate" title="${team.name}">${team.name}</h3>
                        <p class="text-gray-600 truncate">Kapten: ${team.captain || "-"}</p>
                    </div>
                </div>
                <button class="bg-custom-blue-400 text-white text-xs px-3 py-1 rounded-md hover:bg-custom-blue-300 transition" onclick="showMeetTeamDetail(${team.id})">Detail</button>
            </div>
        `).join("");

      const p = data.pagination;
      let paginationHTML = "";
      if (p.has_previous)
        paginationHTML += `<button class="text-custom-blue-400 hover:text-custom-blue-300 font-semibold" onclick="searchMeetTeams(${p.current_page - 1})">&laquo; Prev</button>`;
      paginationHTML += `<span class="text-gray-600 text-sm"> Halaman ${p.current_page} dari ${p.total_pages} </span>`;
      if (p.has_next)
        paginationHTML += `<button class="text-custom-blue-400 hover:text-custom-blue-300 font-semibold" onclick="searchMeetTeams(${p.current_page + 1})">Next &raquo;</button>`;
      pagination.innerHTML = paginationHTML;

    } catch (error) {
      console.error("Search error:", error);
      container.innerHTML = `<p class="text-red-500 text-center py-5">Error memuat tim Anda.</p>`;
    }
  }

  async function showMeetTeamDetail(teamId) {
    const modal = document.getElementById("modal-meet-detail");
    const content = document.getElementById("meet-detail-content");
    const leaveBtn = document.getElementById("leave-team-btn");

    if (!modal || !content || !leaveBtn) return;

    content.innerHTML = `<h2 class="text-xl font-bold text-gray-500 mt-4">Memuat detail tim...</h2>`;
    leaveBtn.classList.add('hidden');
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    try {
      const response = await fetch(`/teams/json/${teamId}/`);
      const team = await response.json();

      if (!team || team.status === "error" || !team.name) {
        content.innerHTML = `<h2 class="text-xl font-bold text-red-500 mt-4">Tim tidak ditemukan atau error.</h2>`;
        return;
      }

      const logoSrc = team.logo || DEFAULT_TEAM_LOGO;

      content.innerHTML = `
            <div class="flex justify-center mb-4">
                <img src="${logoSrc}" alt="${team.name}" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100">
            </div> Â 
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2">${team.name}</h2>
            <p class="text-gray-600 mb-4"><strong>Kapten:</strong> <span class="font-semibold">${team.captain || "-"}</span></p>
            <h3 class="text-lg font-bold text-left text-custom-blue-400 mt-6 mb-2">Anggota (${team.members.length})</h3>
            <div class="max-h-48 overflow-y-auto text-left border border-gray-200 p-3 rounded-lg">
                <ul class="list-disc list-inside space-y-1 text-gray-800">
                    ${team.members.map((m) => `<li class="border-b border-gray-100 last:border-b-0 py-1">${m}</li>`).join("") || '<li class="text-gray-500 italic">Belum ada anggota.</li>'}
                </ul>
            </div>
        `;

      leaveBtn.classList.remove('hidden');
      // Pastikan fungsi leaveTeamConfirm ada di scope global (dari teams.html)
      leaveBtn.onclick = () => {
        if (typeof leaveTeamConfirm === 'function') {
          leaveTeamConfirm(teamId, team.name);
        } else {
          console.error('Fungsi leaveTeamConfirm tidak ditemukan.');
        }
      };

    } catch (error) {
      console.error("Detail error:", error);
      content.innerHTML = `<h2 class="text-xl font-bold text-red-500 mt-4">Gagal memuat detail tim.</h2>`;
      if (typeof showToast === 'function') showToast("Gagal memuat detail tim.", "error");
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById("modal-meet-detail");
    const closeBtn = document.getElementById("close-meet-detail-btn");

    if (modal && closeBtn) {
      closeBtn.onclick = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      };
    }

    const confirmOverlay = document.getElementById("leave-confirm-overlay");
    const confirmName = document.getElementById("leave-confirm-team-name");
    const confirmYes = document.getElementById("confirmLeaveYes");
    const confirmNo = document.getElementById("confirmLeaveNo");

    // Fungsi global agar bisa dipanggil dari onclick
    window.leaveTeamConfirm = (teamId, teamName) => {
      if (!confirmOverlay || !confirmName || !confirmYes || !confirmNo) {
        console.error('Elemen konfirmasi leave tidak ditemukan');
        return;
      }

      confirmName.textContent = teamName;
      confirmOverlay.classList.remove('hidden');
      confirmOverlay.classList.add('flex'); // Tampilkan overlay

      // Ganti listener agar tidak duplikat
      const newConfirmYes = confirmYes.cloneNode(true);
      confirmYes.parentNode.replaceChild(newConfirmYes, confirmYes);
      const newConfirmNo = confirmNo.cloneNode(true);
      confirmNo.parentNode.replaceChild(newConfirmNo, confirmNo);

      newConfirmNo.onclick = () => {
        confirmOverlay.classList.add('hidden');
        confirmOverlay.classList.remove('flex');
      };

      newConfirmYes.onclick = async () => {
        try {
          const response = await fetch(`/teams/${teamId}/leave/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCSRFToken(), "X-Requested-With": "XMLHttpRequest" },
          });
          const data = await response.json();
          if (data.status === "success") {
            if (typeof showToast === 'function') showToast("Kamu berhasil kabur dari tim", "success");
            if (modal) {
              modal.classList.add('hidden');
              modal.classList.remove('flex');
            }
            confirmOverlay.classList.add('hidden');
            confirmOverlay.classList.remove('flex');
            if (typeof searchMeetTeams === 'function') searchMeetTeams(1);
          } else {
            if (typeof showToast === 'function') showToast(data.message || "Gagal keluar dari tim", "error");
            confirmOverlay.classList.add('hidden');
            confirmOverlay.classList.remove('flex');
          }
        } catch (error) {
          if (typeof showToast === 'function') showToast("Terjadi kesalahan saat keluar tim", "error");
          confirmOverlay.classList.add('hidden');
          confirmOverlay.classList.remove('flex');
        }
      };
    };
  });
</script>