<div id="modal-meet" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Meet Your Teams</h2>
      <button onclick="closeModal('modal-meet')">&times;</button>
    </div>

    <div class="modal-body">
      <div class="search-bar">
        <input
          type="text"
          id="meet-search-input"
          placeholder="Search your teams..."
          onkeyup="searchTeams(1, 'meet')"
        />
      </div>

      <div id="meet-teams-container"></div>

      <div class="pagination" id="meet-pagination"></div>
    </div>
  </div>
</div>

<div id="modal-meet-detail" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 id="detail-team-name">Team Detail</h2>
      <button onclick="closeModal('modal-meet-detail')">&times;</button>
    </div>

    <div class="modal-body">
      <div id="detail-team-logo"></div>
      <p><strong>Captain:</strong> <span id="detail-captain"></span></p>
      <p><strong>Members (<span id="detail-members-count"></span>):</strong></p>
      <div id="detail-members-list"></div>
      <br>
      <button class="action-btn" style="background: #f44336;" onclick="leaveTeamConfirm()">Leave Team</button>
    </div>
  </div>
</div>

<script>
  async function searchMeetTeams(page = 1) {
    const query = document.getElementById("meet-search-input").value.trim();
    const container = document.getElementById("meet-teams-container");
    const pagination = document.getElementById("meet-pagination");

    container.innerHTML = `<p class="loading">Loading your teams...</p>`;
    pagination.innerHTML = "";

    try {
      const response = await fetch(`/teams/search/?mode=meet&q=${encodeURIComponent(query)}&page=${page}`);
      const data = await response.json();

      if (data.status !== "success" || !data.results || data.results.length === 0) {
        container.innerHTML = `<p>You're not in any team yet.</p>`;
        return;
      }

      // Render daftar tim
      container.innerHTML = data.results
        .map(
          (team) => `
          <div class="team-card" data-team-id="${team.id}">
            <div class="team-info">
              ${
                team.logo
                  ? `<img src=${team.logo || "https://img.icons8.com/?size=100&id=uMMzE4KzgxCO&format=png&color=000000"} alt="${team.name}" class="team-avatar">`
                  : `<img src="https://img.icons8.com/?size=100&id=uMMzE4KzgxCO&format=png&color=000000" alt="${team.name}" class="team-avatar">`
              }
              <div class="team-text">
                <h3>${team.name}</h3>
                <p>Captain: ${team.captain || "-"}</p>
              </div>
            </div>
            <button class="action-btn" onclick="showMeetTeamDetail(${team.id})">Detail</button>
          </div>
        `
        )
        .join("");

      const p = data.pagination;
      let paginationHTML = "";
      if (p.has_previous)
        paginationHTML += `<button onclick="searchMeetTeams(${p.current_page - 1})">&laquo; Prev</button>`;
      paginationHTML += `<span> Page ${p.current_page} of ${p.total_pages} </span>`;
      if (p.has_next)
        paginationHTML += `<button onclick="searchMeetTeams(${p.current_page + 1})">Next &raquo;</button>`;
      pagination.innerHTML = paginationHTML;
    } catch (error) {
      console.error("Search error:", error);
      container.innerHTML = `<p>Error loading your teams.</p>`;
    }
  }

async function showMeetTeamDetail(teamId) {
  try {
    const response = await fetch(`/teams/json/${teamId}/`);
    const team = await response.json();

    if (!team || team.status === "error") {
      alert("Team not found");
      return;
    }

    // Hapus modal lama kalau ada
    const oldModal = document.getElementById("team-detail-modal");
    if (oldModal) oldModal.remove();

    // Buat elemen modal baru
    const modal = document.createElement("div");
    modal.id = "team-detail-modal";
    modal.style = `
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;

    modal.innerHTML = `
      <div style="
        background: white;
        padding: 32px;
        border-radius: 16px;
        width: 400px;
        max-height: 85vh;
        overflow-y: auto;
        text-align: center;
        position: relative;
      ">
        <button onclick="document.getElementById('team-detail-modal').remove()" 
          style="position:absolute; top:10px; right:16px; background:none; border:none; font-size:20px; cursor:pointer;">&times;
        </button>

        <div style="item-align:center; justify-content:center; display:flex; margin-bottom:16px;">
        ${
          team.logo
            ? `<img src="${team.logo || "https://img.icons8.com/?size=100&id=uMMzE4KzgxCO&format=png&color=000000"}" alt="${team.name}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px;"">`
        : `<img src="${team.logo || "https://img.icons8.com/?size=100&id=uMMzE4KzgxCO&format=png&color=000000"}" alt="${team.name}" class="team-avatar">`
        }
        </div>

        <h2 style="margin-bottom:8px;">${team.name}</h2>
        <p style="margin-bottom:16px;"><strong>Captain:</strong> ${team.captain || "-"}</p>

        <h3 style="text-align:left; margin-top:8px;">Members (${team.members.length})</h3>
        <div style="max-height:180px; overflow-y:auto; text-align:left; margin-top:6px; padding-left:10px;">
          <ul style="margin:0; padding-left:16px;">
            ${team.members.map((m) => `<li>${m}</li>`).join("")}
          </ul>
        </div>

        <button onclick="leaveTeamConfirm(${teamId}, '${team.name.replace(/'/g, "\\'")}')" 
          style="
            background:#f44336;
            color:white;
            border:none;
            padding:10px 20px;
            margin-top:20px;
            border-radius:8px;
            cursor:pointer;
          ">
          Leave Team
        </button>
      </div>
    `;

    document.body.appendChild(modal);
  } catch (error) {
    console.error("Detail error:", error);
    alert("Failed to load team details.");
  }
}

async function leaveTeamConfirm(teamId, teamName) {
  const modal = document.getElementById("team-detail-modal");
  if (!modal) return;

  modal.innerHTML += `
    <div id="leave-confirm-overlay" style="
      position:absolute; inset:0;
      background:rgba(0,0,0,0.7);
      display:flex; align-items:center; justify-content:center;
      z-index:10000;
    ">
      <div style="background:white; padding:24px; border-radius:12px; text-align:center;">
        <p>Are you sure you want to leave <strong>${teamName}</strong>?</p>
        <div style="margin-top:16px;">
          <button id="confirmLeaveYes" style="background:#f44336; color:white; border:none; padding:8px 16px; border-radius:6px; margin-right:8px; cursor:pointer;">Yes</button>
          <button id="confirmLeaveNo" style="background:#ccc; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById("confirmLeaveNo").onclick = () => {
    document.getElementById("leave-confirm-overlay").remove();
  };

  document.getElementById("confirmLeaveYes").onclick = async () => {
    try {
      const response = await fetch(`/teams/${teamId}/leave/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await response.json();
      if (data.status === "success") {
        showToast("Kamu berhasil kabur dari tim", "success");
        document.getElementById("team-detail-modal").remove();
        searchMeetTeams(1);
      } else {
        alert(data.message || "Failed to leave team");
      }
    } catch (error) {
      console.error("Leave error:", error);
      alert("Failed to leave team");
    }
  };
}

function getCSRFToken() {
  return document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";
}


</script>
