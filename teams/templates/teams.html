{% extends 'base.html' %}
{% load static %}
{% block title %}Teams | Turnamenku{% endblock title %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/stylesteams.css' %}">
    <style>
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .btn-loading {
        opacity: 0.7;
        cursor: not-allowed;
        pointer-events: none;
      }
    </style>
{% endblock %}
{% block content %}
  {% include 'layout_navbar.html' %}
  <div class="teams">
    <div class="frames-container">
      <div class="frame">
        <div class="flex justify-center items-center">
          <img src="{% static 'images/Superman Night 1 Streamline UX Line.png' %}" alt="team leadership" />
        </div>
        <div class="text-wrapper-2">Meet Your Team</div>
        <p class="p">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt.</p>
        <button onclick="openModal('modal-meet')" class="text-wrapper">Let's meet em!</button>
      </div>

      <div class="frame">
        <div class="flex justify-center items-center">
          <img src="{% static 'images/Friends Wave Streamline UX Line.png' %}" alt="joining team" />
        </div>  
        <div class="text-wrapper-2">I Need A Team</div>
        <p class="p">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt.</p>
        <button onclick="openModal('modal-join')" class="text-wrapper">I'm a human too</button>
      </div>

      <div class="frame">
        <div class="flex justify-center items-center">
          <img src="{% static 'images/Comment Rating Streamline UX Line.png' %}" alt="manage team" />
        </div>
        <div class="text-wrapper-2">Manage Your Team</div>
        <p class="p">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt.</p>
        <button onclick="openModal('modal-manage')" class="text-wrapper">I am the boss!!</button>
      </div>
    </div>
  </div>

{% include 'meet_teams.html' %}
{% include 'manage_team.html' %}
{% include 'join_teams.html' %}

<script>
  const BASE_URL = '/teams'; // ganti sesuai path kamu, misal '/teams' atau '/app/teams'

  function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
    // Load teams when modal is opened
    if (modalId === 'modal-join') {
      searchTeams(1);
    } else if (modalId === 'modal-manage') {
      searchManagedTeams(1);
    } else if (modalId === 'modal-meet') {
      searchMeetTeams(1);
    }
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
  }
  
  // ====== FETCH FUNCTIONS ======
  function searchTeams(page = 1) {
    const containerId = 'modal-join';
    showLoading(containerId);
    
    const query = document.getElementById('join-search')?.value || '';
    fetch(`${BASE_URL}/search/?q=${encodeURIComponent(query)}&page=${page}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (data.status === 'success') {
          renderTeamsList(containerId, data.results, 'join');
        } else {
          showError(containerId, 'No teams found.');
        }
      })
      .catch(err => showError(containerId, `Error fetching data: ${err.message}`));
  }

  function searchManagedTeams(page = 1) {
    const containerId = 'modal-manage';
    showLoading(containerId);
    
    const query = document.getElementById('manage-search')?.value || '';
    fetch(`${BASE_URL}/search-managed/?q=${encodeURIComponent(query)}&page=${page}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (data.status === 'success') {
          renderTeamsList(containerId, data.results, 'manage');
        } else {
          showError(containerId, 'No managed teams found.');
        }
      })
      .catch(err => showError(containerId, `Error fetching data: ${err.message}`));
  }

  function searchMeetTeams(page = 1) {
    const containerId = 'modal-meet';
    showLoading(containerId);
    
    const query = document.getElementById('meet-search')?.value || '';
    fetch(`${BASE_URL}/search-meet/?q=${encodeURIComponent(query)}&page=${page}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (data.status === 'success') {
          renderTeamsList(containerId, data.results, 'meet');
        } else {
          showError(containerId, 'No joined teams found.');
        }
      })
      .catch(err => showError(containerId, `Error fetching data: ${err.message}`));
  }

  // ====== RENDERER ======
  function renderTeamsList(containerId, teams, mode) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (!teams || teams.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:gray;">No teams found.</p>';
      return;
    }

    container.innerHTML = teams.map(team => `
      <div class="team-card">
        <img src="${team.logo || '/static/images/default_team.png'}" alt="${team.name}" class="team-logo">
        <h4>${team.name}</h4>
        <p>Captain: ${team.captain}</p>
        <p>Members: ${team.members_count}</p>
        ${mode === 'join' ? `<button onclick="joinTeam(${team.id}, this)">Join</button>` : ''}
        ${mode === 'manage' ? `<button onclick="deleteTeam(${team.id}, this)">Delete</button>` : ''}
      </div>
    `).join('');
  }

  // ====== ACTIONS ======

  function joinTeam(teamId, btn) {
    setButtonLoading(btn, true);
    fetch(`${BASE_URL}/join/${teamId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          showToast('Joined team successfully!');
          searchTeams();
        } else {
          showToast(data.message || 'Failed to join.', 'error');
        }
      })
      .catch(err => showToast(err.message, 'error'))
      .finally(() => setButtonLoading(btn, false));
  }

  function deleteTeam(teamId, btn) {
    if (!confirm('Are you sure you want to delete this team?')) return;
    setButtonLoading(btn, true);
    
    fetch(`${BASE_URL}/delete/${teamId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          showToast('Team deleted successfully');
          searchManagedTeams();
        } else {
          showToast(data.message || 'Delete failed', 'error');
        }
      })
      .catch(err => showToast(err.message, 'error'))
      .finally(() => setButtonLoading(btn, false));
  }
</script>
{% endblock content %}