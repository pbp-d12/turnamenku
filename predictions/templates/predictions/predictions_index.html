{% extends 'layout_navbar.html' %}
{% block page_title %}Predictions{% endblock page_title %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
  <h1 class="text-4xl font-bold mb-8 text-center text-custom-blue-400">Prediksi Pertandingan</h1>

  <!-- Bagian atas: Leaderboard (kiri), Filter (tengah), Tambah Match (kanan) -->
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
    <!-- Kiri: Leaderboard -->
    <a href="{% url 'predictions:leaderboard' %}"
       class="bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-6 py-2 rounded-lg font-semibold shadow-md transition duration-300">
       üèÜ Leaderboard
    </a>

    <!-- Tengah: Filter Turnamen -->
    <form method="get" id="filterForm" class="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2">
      <select name="tournament" class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-custom-blue-200">
        <option value="">Semua Turnamen</option>
        {% for t in tournaments %}
        <option value="{{ t.id }}" {% if request.GET.tournament == t.id|stringformat:"s" %}selected{% endif %}>
          {{ t.name }}
        </option>
        {% endfor %}
      </select>
      <button type="submit"
        class="bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition duration-300">
        Filter
      </button>
    </form>

    <!-- Kanan: Tambah Match -->
    {% if user.is_authenticated and user.profile.role in "PENYELENGGARA,ADMIN" %}
    <button id="openAddMatchModal"
      class="w-full sm:w-auto bg-custom-blue-400 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-custom-blue-300 transition-colors duration-300">
      + Tambah Match
    </button>
    {% endif %}
  </div>

  <!-- Pertandingan Berlangsung (Ongoing) -->
  {% if ongoing_matches %}
  <h2 class="text-2xl font-bold mb-4 text-gray-800">Pertandingan Berlangsung</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for match in ongoing_matches %}
    <div class="bg-white shadow-md hover:shadow-xl rounded-2xl p-6 transition duration-300 flex flex-col justify-between">
      <div>
        <h2 class="text-2xl font-semibold text-center text-gray-800 mb-3 break-words">
          {{ match.home_team.name }} vs {{ match.away_team.name }}
        </h2>
        <p class="text-sm text-center text-gray-500 mb-2">{{ match.match_date }}</p>
        <p class="text-sm text-center text-custom-blue-400 font-medium mb-5">{{ match.tournament.name }}</p>
        <p class="funText text-center text-lg font-semibold animate-wiggle text-gray-700 mb-8"></p>
      </div>

      <div class="flex flex-col sm:flex-row justify-center items-center gap-3">
        <button
          class="team-btn bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-xl font-medium shadow-sm transition duration-200 w-full sm:w-[45%] truncate"
          data-match-id="{{ match.id }}" data-team-id="{{ match.home_team.id }}">
          {{ match.home_team.name }}
        </button>
        <button
          class="team-btn bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-xl font-medium shadow-sm transition duration-200 w-full sm:w-[45%] truncate"
          data-match-id="{{ match.id }}" data-team-id="{{ match.away_team.id }}">
          {{ match.away_team.name }}
        </button>
        {% if user.is_authenticated and user.profile.role == "PENYELENGGARA" %}
        <button class="edit-score-btn bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition duration-200 mt-3"
          data-match-id="{{ match.id }}">
          Edit Skor
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Pertandingan Selesai (Finished) -->
  {% if finished_matches %}
  <h2 class="text-2xl font-bold mb-4 mt-10 text-gray-600">Pertandingan Selesai</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for match in finished_matches %}
    <div class="bg-gray-100 shadow rounded-2xl p-6 flex flex-col justify-between opacity-80">
      <div>
        <h2 class="text-2xl font-semibold text-center text-gray-700 mb-3 break-words">
          {{ match.home_team.name }} vs {{ match.away_team.name }}
        </h2>
        <p class="text-sm text-center text-gray-500 mb-2">{{ match.match_date }}</p>
        <p class="text-sm text-center text-gray-400 font-medium mb-5">{{ match.tournament.name }}</p>
        <p class="text-center text-lg font-semibold text-gray-800 mb-2">
          Skor: {{ match.home_score }} - {{ match.away_score }}
        </p>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Modal Tambah Match -->
<div id="addMatchModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-lg relative">
    <h2 class="text-2xl font-bold mb-4 text-center text-custom-blue-400">Tambah Match</h2>
    <form id="addMatchForm">
      {% csrf_token %}
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Turnamen</label>
        <select name="tournament" required class="w-full border rounded-lg p-2">
          {% for t in tournaments %}
          <option value="{{ t.id }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Tim Home</label>
        <select name="home_team" required class="w-full border rounded-lg p-2">
          {% for team in teams %}
          <option value="{{ team.id }}">{{ team.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Tim Away</label>
        <select name="away_team" required class="w-full border rounded-lg p-2">
          {% for team in teams %}
          <option value="{{ team.id }}">{{ team.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Tanggal Pertandingan</label>
        <input type="datetime-local" name="match_date" required class="w-full border rounded-lg p-2">
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="cancelAddMatch"
          class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg">Batal</button>
        <button type="submit"
          class="bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Skor -->
<div id="editScoreModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md relative">
    <h2 class="text-2xl font-bold mb-4 text-center text-custom-blue-400">Edit Skor</h2>
    <form id="editScoreForm">
      {% csrf_token %}
      <input type="hidden" name="match_id" id="editMatchId">
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Skor Home</label>
        <input type="number" name="home_score" id="editHomeScore" class="w-full border rounded-lg p-2" min="0" required>
      </div>
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Skor Away</label>
        <input type="number" name="away_score" id="editAwayScore" class="w-full border rounded-lg p-2" min="0" required>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="cancelEditScore"
          class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg">Batal</button>
        <button type="submit"
          class="bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button>
      </div>
    </form>
  </div>
</div>
{% endblock main_content %}

{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {

  // Tombol prediksi
  document.querySelectorAll('.team-btn').forEach(btn => {
    btn.addEventListener('click', async function () {
      const matchId = this.dataset.matchId;
      const teamId = this.dataset.teamId;
      const csrfToken = '{{ csrf_token }}';
      const response = await fetch("{% url 'predictions:submit_prediction' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ match_id: matchId, team_id: teamId })
      });
      const data = await response.json();
      if (data.success) showToast(data.message, 'success');
      else showToast(data.message, 'error');
    });
  });

  // Fun messages
  const funMessages = [
    "Tebak siapa yang bakal jadi juara kali ini! ‚öΩüî•",
    "Prediksi sekarang, buktikan nanti! üß†üèÜ",
    "Siapa jago prediksi di sini? üí™üéØ",
    "Buktikan insting sepak bolamu! ‚öîÔ∏è",
    "Ayo ikut seru-seruan bareng! üòé‚öΩ"
  ];
  document.querySelectorAll(".funText").forEach(el => {
    el.textContent = funMessages[Math.floor(Math.random() * funMessages.length)];
  });

  // Modal tambah match
  const addModal = document.getElementById("addMatchModal");
  const openAddBtn = document.getElementById("openAddMatchModal");
  const cancelAddBtn = document.getElementById("cancelAddMatch");
  const addForm = document.getElementById("addMatchForm");

  openAddBtn?.addEventListener("click", () => addModal.classList.remove("hidden"));
  cancelAddBtn?.addEventListener("click", () => addModal.classList.add("hidden"));

  addForm.addEventListener("submit", async e => {
    e.preventDefault();
    const csrfToken = '{{ csrf_token }}';
    const formData = new FormData(addForm);

    const response = await fetch("{% url 'predictions:add_match' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: formData
    });
    const data = await response.json();

    if (data.success) {
      showToast(data.message, 'success');
      addModal.classList.add("hidden");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  });

  // Modal edit skor
  const editModal = document.getElementById("editScoreModal");
  const editForm = document.getElementById("editScoreForm");
  const cancelEditBtn = document.getElementById("cancelEditScore");

  document.querySelectorAll(".edit-score-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const matchId = btn.dataset.matchId;

      // Ambil data skor saat ini dari server
      const response = await fetch(`/predictions/get_match_scores/${matchId}/`);
      const data = await response.json();

      document.getElementById("editMatchId").value = matchId;
      document.getElementById("editHomeScore").value = data.home_score ?? 0;
      document.getElementById("editAwayScore").value = data.away_score ?? 0;

      editModal.classList.remove("hidden");
    });
  });

  cancelEditBtn.addEventListener("click", () => editModal.classList.add("hidden"));

  editForm.addEventListener("submit", async e => {
    e.preventDefault();
    const csrfToken = '{{ csrf_token }}';
    const formData = new FormData(editForm);

    const response = await fetch("{% url 'predictions:edit_match_score' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: formData
    });

    const data = await response.json();
    if (data.success) {
      showToast(data.message, 'success');
      editModal.classList.add("hidden");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  });

}); 
</script>
{% endblock javascript %}
