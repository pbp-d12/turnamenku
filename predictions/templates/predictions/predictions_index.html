{% extends 'layout_navbar.html' %}
{% block page_title %}Predictions{% endblock page_title %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
  <h1 class="text-4xl font-bold mb-8 text-center text-custom-blue-400">Prediksi Pertandingan</h1>

  <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
    
    <a href="{% url 'predictions:leaderboard' %}"
       class="order-2 sm:order-none w-full sm:w-auto text-center bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-6 py-2 rounded-lg font-semibold shadow-md transition duration-300">
       üèÜ Leaderboard
    </a>

    <form method="get" id="filterForm"
          class="order-1 sm:order-none w-full sm:w-auto flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
      <select name="tournament" class="w-full sm:w-auto border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-custom-blue-200">
        <option value="">Semua Turnamen</option>
        {% for t in tournaments %}
        <option value="{{ t.id }}" {% if request.GET.tournament == t.id|stringformat:"s" %}selected{% endif %}>
          {{ t.name }}
        </option>
        {% endfor %}
      </select>
      <button type="submit"
        class="w-full sm:w-auto bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition duration-300">
        Filter
      </button>
    </form>

    {% if user.is_authenticated and user.profile.role in "PENYELENGGARA,ADMIN" %}
    <button id="openAddMatchModal"
      class="order-3 sm:order-none w-full sm:w-auto bg-custom-blue-400 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-custom-blue-300 transition-colors duration-300">
      + Tambah Match
    </button>
    {% endif %}
  </div>


  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mt-16">

    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 text-center flex flex-col animate-on-scroll">
      <div class="flex justify-center items-center h-24">
        <img src="https://img.icons8.com/?size=100&id=11370&format=png&color=000000" alt="Ongoing Match"
          class="h-20 w-20" />
      </div>
      <h2 class="text-xl font-bold text-gray-800 mt-4 mb-2">Pertandingan Berlangsung</h2>
      <p class="text-gray-600 text-sm mb-4 flex-grow">
        Lihat pertandingan yang sedang berlangsung dan buat prediksimu. Buktikan insting sepak bolamu!
      </p>
      <button onclick="openMatchesModal('ongoing')"
        class="w-full bg-custom-blue-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-300 transition duration-150 ease-in-out">
        Lihat Pertandingan
      </button>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 text-center flex flex-col animate-on-scroll">
      <div class="flex justify-center items-center h-24">
        <img src="https://img.icons8.com/?size=100&id=12143&format=png&color=000000" alt="Finished Match"
          class="h-20 w-20" />
      </div>
      <h2 class="text-xl font-bold text-gray-800 mt-4 mb-2">Pertandingan Selesai</h2>
      <p class="text-gray-600 text-sm mb-4 flex-grow">
        Cek riwayat pertandingan yang telah selesai dan lihat skor akhirnya.
      </p>
      <button onclick="openMatchesModal('finished')"
        class="w-full bg-custom-blue-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-300 transition duration-150 ease-in-out">
        Lihat Riwayat
      </button>
    </div>
  </div>
</div>

<div id="matchesModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center z-40 p-4">
  <div class="bg-gray-50 rounded-2xl shadow-lg p-6 w-full max-w-7xl h-[90vh] flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 id="matchesModalTitle" class="text-2xl font-bold text-custom-blue-400">Daftar Pertandingan</h2>
      <button id="closeMatchesModal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div id="matchesModalContent" class="flex-grow overflow-y-auto pr-2">
      <div id="matchesLoadingSpinner" class="text-center py-20">
        <p class="text-lg text-gray-600">Memuat data...</p>
      </div>
    </div>
  </div>
</div>

<div id="addMatchModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-lg relative">
    <h2 class="text-2xl font-bold mb-4 text-center text-custom-blue-400">Tambah Match</h2>
    <form id="addMatchForm">
      {% csrf_token %}
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Turnamen</label>
        <select name="tournament" required class="w-full border rounded-lg p-2" id="addMatchTournamentSelect">
          <option value="" disabled selected>Pilih Turnamen</option> {% for t in tournaments %}
          <option value="{{ t.id }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Tim Home</label>
        <select name="home_team" required class="w-full border rounded-lg p-2" id="addMatchHomeTeamSelect" disabled>
          <option value="" disabled selected>Pilih turnamen dulu</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Tim Away</label>
        <select name="away_team" required class="w-full border rounded-lg p-2" id="addMatchAwayTeamSelect" disabled>
          <option value="" disabled selected>Pilih turnamen dulu</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Tanggal Pertandingan</label>
        <input type="datetime-local" name="match_date" required class="w-full border rounded-lg p-2">
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="cancelAddMatch"
          class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg">Batal</button>
        <button type="submit"
          class="bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button>
      </div>
    </form>
  </div>
</div>

<div id="editScoreModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md relative">
    <h2 class="text-2xl font-bold mb-4 text-center text-custom-blue-400">Edit Skor</h2>
    <form id="editScoreForm">
      {% csrf_token %}
      <input type="hidden" name="match_id" id="editMatchId">
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Skor Home</label>
        <input type="number" name="home_score" id="editHomeScore" class="w-full border rounded-lg p-2" min="0" required>
      </div>
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">Skor Away</label>
        <input type="number" name="away_score" id="editAwayScore" class="w-full border rounded-lg p-2" min="0" required>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="cancelEditScore"
          class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg">Batal</button>
        <button type="submit"
          class="bg-custom-blue-100 hover:bg-custom-blue-300 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button>
      </div>
    </form>
  </div>
</div>

<div id="deletePredictionModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md relative">
    <h2 class="text-2xl font-bold mb-4 text-center text-red-500">Hapus Prediksi?</h2>
    <p class="text-center text-gray-700 mb-6">Apakah kamu yakin ingin menghapus prediksi ini? Tindakan ini tidak bisa dibatalkan.</p>
    <div class="flex justify-end gap-3">
      <button id="cancelDeletePrediction" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg">Batal</button>
      <button id="confirmDeletePrediction" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Hapus</button>
    </div>
  </div>
</div>
{% endblock main_content %}

{% block javascript %}
{{ block.super }}
<script>
  const funMessages = [
    "Tebak siapa yang bakal jadi juara kali ini! ‚öΩüî•",
    "Prediksi sekarang, buktikan nanti! üß†üèÜ",
    "Siapa jago prediksi di sini? üí™üéØ",
    "Buktikan insting sepak bolamu! ‚öîÔ∏è",
    "Ayo ikut seru-seruan bareng! üòé‚öΩ"
  ];

  const CURRENT_TOURNAMENT_ID = "{{ current_tournament_id|escapejs }}";
  const CSRF_TOKEN = '{{ csrf_token }}';
  

  const TOURNAMENT_TEAMS_MAP = {{ tournaments_with_teams_json }};


  function applyFunMessages(containerSelector = document) {
    containerSelector.querySelectorAll(".funText").forEach(el => {
      el.textContent = funMessages[Math.floor(Math.random() * funMessages.length)];
    });
  }


  async function openMatchesModal(type) {
    const modal = document.getElementById("matchesModal");
    const titleEl = document.getElementById("matchesModalTitle");
    const contentEl = document.getElementById("matchesModalContent");
    

    const spinnerHtml = `
      <div id="matchesLoadingSpinner" class="text-center py-20">
        <p class="text-lg text-gray-600">Memuat data...</p>
      </div>
    `;
    
    if (!modal || !contentEl) {
      console.error("Elemen modal (#matchesModal atau #matchesModalContent) tidak ditemukan.");
      showToast("Gagal membuka modal.", "error");
      return;
    }
    
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    
    contentEl.innerHTML = spinnerHtml; 

    let url = "";
    if (type === 'ongoing') {
      titleEl.textContent = "Pertandingan Berlangsung";
      url = `{% url 'predictions:get_ongoing_matches' %}?tournament=${CURRENT_TOURNAMENT_ID}`;
    } else {
      titleEl.textContent = "Pertandingan Selesai";
      url = `{% url 'predictions:get_finished_matches' %}?tournament=${CURRENT_TOURNAMENT_ID}`;
    }

    try {
      const response = await fetch(url);
      const html = await response.text();
      contentEl.innerHTML = html; 
      applyFunMessages(contentEl); 
    } catch (error) {
      contentEl.innerHTML = `<p class="text-center text-red-500">Gagal memuat data. Coba lagi.</p>`;
      console.error("Fetch error:", error);
    }
  }


  function updateAddMatchTeamDropdowns(tournamentId, homeSelect, awaySelect) {
    const teams = TOURNAMENT_TEAMS_MAP[tournamentId] || [];
    
    homeSelect.innerHTML = '';
    awaySelect.innerHTML = '';

    if (teams.length > 0) {
      homeSelect.disabled = false;
      awaySelect.disabled = false;
      
      homeSelect.add(new Option('Pilih Tim Home', ''));
      awaySelect.add(new Option('Pilih Tim Away', ''));

   
      teams.forEach(team => {
        homeSelect.add(new Option(team.name, team.id));
        awaySelect.add(new Option(team.name, team.id));
      });
    } else {
      homeSelect.disabled = true;
      awaySelect.disabled = true;
      homeSelect.add(new Option('Tidak ada tim di turnamen ini', ''));
      awaySelect.add(new Option('Tidak ada tim di turnamen ini', ''));
    }
  }


  document.addEventListener('DOMContentLoaded', function () {

    
    const matchesModal = document.getElementById("matchesModal");
    const closeMatchesBtn = document.getElementById("closeMatchesModal");
    
    closeMatchesBtn?.addEventListener("click", () => {
      matchesModal?.classList.add("hidden");
      matchesModal?.classList.remove("flex");
      
      const contentEl = document.getElementById("matchesModalContent");
      if (contentEl) {
        
        contentEl.innerHTML = `
          <div id="matchesLoadingSpinner" class="text-center py-20">
            <p class="text-lg text-gray-600">Memuat data...</p>
          </div>
        `;
      }
    });

    
    const addModal = document.getElementById("addMatchModal");
    const openAddBtn = document.getElementById("openAddMatchModal");
    const cancelAddBtn = document.getElementById("cancelAddMatch");
    const addForm = document.getElementById("addMatchForm");
    
    
    const addMatchTournamentSelect = document.getElementById("addMatchTournamentSelect");
    const addMatchHomeTeamSelect = document.getElementById("addMatchHomeTeamSelect");
    const addMatchAwayTeamSelect = document.getElementById("addMatchAwayTeamSelect");


    openAddBtn?.addEventListener("click", () => {
      addModal.classList.remove("hidden");
      addForm?.reset(); 
      
      
      addMatchHomeTeamSelect.innerHTML = '<option value="" disabled selected>Pilih turnamen dulu</option>';
      addMatchHomeTeamSelect.disabled = true;
      addMatchAwayTeamSelect.innerHTML = '<option value="" disabled selected>Pilih turnamen dulu</option>';
      addMatchAwayTeamSelect.disabled = true;
    });
    
    cancelAddBtn?.addEventListener("click", () => addModal.classList.add("hidden"));


    addMatchTournamentSelect?.addEventListener('change', function() {
      const selectedTournamentId = this.value;
      updateAddMatchTeamDropdowns(selectedTournamentId, addMatchHomeTeamSelect, addMatchAwayTeamSelect);
    });

    addForm?.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(addForm);
      const response = await fetch("{% url 'predictions:add_match' %}", {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN },
        body: formData
      });
      const data = await response.json();
      if (data.success) {
        showToast(data.message, 'success');
        addModal.classList.add("hidden");
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.message, 'error');
      }
    });

    // --- Modal edit skor ---
    const editModal = document.getElementById("editScoreModal");
    const editForm = document.getElementById("editScoreForm");
    const cancelEditBtn = document.getElementById("cancelEditScore");

    cancelEditBtn?.addEventListener("click", () => editModal.classList.add("hidden"));

    editForm?.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(editForm);
      const response = await fetch("{% url 'predictions:edit_match_score' %}", {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN },
        body: formData
      });
      const data = await response.json();
      if (data.success) {
        showToast(data.message, 'success');
        editModal.classList.add("hidden");
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.message, 'error');
      }
    });

    // --- Modal hapus prediction ---
    const deleteModal = document.getElementById("deletePredictionModal");
    const cancelDeleteBtn = document.getElementById("cancelDeletePrediction");
    const confirmDeleteBtn = document.getElementById("confirmDeletePrediction");
    let matchIdToDelete = null; 

    cancelDeleteBtn?.addEventListener("click", () => {
      deleteModal.classList.add("hidden");
      matchIdToDelete = null;
    });

    confirmDeleteBtn?.addEventListener("click", async () => {
      if (!matchIdToDelete) return;
      const response = await fetch("{% url 'predictions:delete_prediction' %}", {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN, "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ match_id: matchIdToDelete })
      });
      const data = await response.json();
      if (data.success) {
        showToast(data.message, 'success');
        deleteModal.classList.add("hidden");
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.message, 'error');
      }
    });

    
    document.body.addEventListener('click', async function(e) {
      
      
      if (e.target.matches('.team-btn')) {
        const btn = e.target;
        const response = await fetch("{% url 'predictions:submit_prediction' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ match_id: btn.dataset.matchId, team_id: btn.dataset.teamId })
        });
        const data = await response.json();
        if (data.success) showToast(data.message, 'success');
        else showToast(data.message, 'error');
      }

      
      if (e.target.matches('.edit-score-btn')) {
        const btn = e.target;
        const matchId = btn.dataset.matchId;
        const response = await fetch(`/predictions/get_match_scores/${matchId}/`);
        const data = await response.json();
        
        document.getElementById("editMatchId").value = matchId;
        document.getElementById("editHomeScore").value = data.home_score ?? 0;
        document.getElementById("editAwayScore").value = data.away_score ?? 0;

        editModal.classList.remove("hidden");
      }

      
      if (e.target.matches('.delete-prediction-btn')) {
        matchIdToDelete = e.target.dataset.matchId;
        deleteModal.classList.remove("hidden");
      }

      
      if (e.target.matches('#matchesModalContent .page-link')) {
        e.preventDefault();
        
        const url = e.target.getAttribute('href');
        if (!url) return;
        
        const contentEl = document.getElementById("matchesModalContent");
        if (!contentEl) return;


        contentEl.innerHTML = `
          <div id="matchesLoadingSpinner" class="text-center py-20">
            <p class="text-lg text-gray-600">Memuat data...</p>
          </div>
        `;

        try {
          const response = await fetch(url);
          const html = await response.text();
          contentEl.innerHTML = html;
          applyFunMessages(contentEl); 
        } catch (error) {
          contentEl.innerHTML = `<p class="text-center text-red-500">Gagal memuat halaman. Coba lagi.</p>`;
          console.error("Fetch pagination error:", error);
        }
      }
    

    });

    // Terapkan fun messages saat halaman pertama kali dimuat
    applyFunMessages();
  }); 

</script>
{% endblock javascript %}