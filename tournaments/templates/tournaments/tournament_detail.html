{% extends 'layout_navbar.html' %}
{% load static %}
{% load tz %}

{# Menerima 'tournament_id' dari context view 'tournament_detail_page' #}
{% block body_attributes %}data-tournament-id="{{ tournament_id }}"{% endblock body_attributes %}

{% block page_title %}Detail Turnamen{% endblock page_title %}

{% block main_content %}
{% timezone "Asia/Jakarta" %}
<div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">

    {# Link Kembali & Tombol Manajemen #}
    <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
        <a href="{% url 'tournaments:tournament_home' %}" class="inline-flex items-center text-sm text-custom-blue-300 hover:text-custom-blue-400 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Kembali ke Daftar Turnamen
        </a>
        <div id="management-buttons" class="flex gap-2">
            {# Tombol Edit/Delete akan diinjeksi oleh JS #}
        </div>
    </div>

    {# Indikator Loading #}
    <div id="loading-indicator" class="text-center p-10 text-custom-blue-300">
        <svg class="animate-spin h-8 w-8 text-custom-blue-300 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2">Memuat detail turnamen...</p>
    </div>

    {# Placeholder Pesan Error #}
    <div id="error-message" class="hidden text-center p-6 bg-red-50 text-red-700 rounded-lg shadow">
        Gagal memuat detail turnamen.
    </div>

    {#   Konten Placeholder (Awalnya tersembunyi)   #}
    <div id="tournament-content" class="hidden">
        <div id="tournament-banner-container" class="mb-6"></div>
        <h1 id="tournament-name" class="text-3xl md:text-4xl font-bold text-custom-blue-400 mb-2 break-words"></h1>

        <div class="flex flex-wrap items-center text-sm text-custom-blue-300 mb-4 space-x-4">
            <span><strong>Penyelenggara:</strong> <a id="organizer-link" href="#" class="hover:underline"></a></span>
            <span>|</span>
            <span><strong>Tanggal:</strong> <span id="tournament-dates"></span></span>
        </div>

        <div id="tournament-status-container" class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <span class="block text-sm font-semibold text-gray-700 mb-1">Status Pendaftaran</span>
                <span id="registration-status-badge" class="px-3 py-1 text-xs font-bold rounded-full"></span>
            </div>
            <div>
                <span class="block text-sm font-semibold text-gray-700 mb-1">Pemenang</span>
                <span id="winner-name-display" class="text-gray-900"></span>
            </div>
        </div>

        <p id="tournament-description" class="text-gray-700 mb-6 whitespace-pre-wrap break-words"></p>

        <div id="team-registration-container" class="my-4">
            </div>

        {#   Bagian Tim Peserta   #}
        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Tim Peserta</h2>
        <div id="participant-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
             {# Kartu tim peserta akan dimasukkan di sini oleh JavaScript #}
        </div>
        <p id="no-participants-message" class="hidden text-gray-500 col-span-full">Belum ada tim yang mendaftar.</p>

        {#   Bagian Leaderboard   #}
        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Leaderboard</h2>
        <div id="leaderboard-container" class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm mb-6 hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/12">Pos</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-4/12">Tim</th>
                        <th scope="col" title="Played" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">P</th>
                        <th scope="col" title="Wins" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">W</th>
                        <th scope="col" title="Draws" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">D</th>
                        <th scope="col" title="Losses" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">L</th>
                        <th scope="col" title="Goals For" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">GF</th>
                        <th scope="col" title="Goals Against" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">GA</th>
                        <th scope="col" title="Goal Difference" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">GD</th>
                        <th scope="col" title="Points" class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Pts</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200">
                    {# Leaderboard rows will be injected here by JS #}
                </tbody>
            </table>
        </div>
        <p id="no-leaderboard-message" class="hidden text-gray-500">Leaderboard akan tersedia setelah ada pertandingan yang selesai.</p>

        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Jadwal Pertandingan</h2>
        <div id="match-list" class="space-y-4">
            {# Jadwal pertandingan akan dimasukkan di sini oleh JavaScript #}
        </div>
        <p id="no-matches-message-display" class="hidden text-gray-500">Belum ada jadwal pertandingan.</p>
         <hr class="my-6 border-gray-200">
         <div class="flex flex-col sm:flex-row gap-4 mt-6">
             <a id="forum-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">Diskusi Forum</a>
             <a id="predictions-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">Lihat Prediksi</a>
         </div>
    </div> 
</div>

{#   MODAL EDIT TURNAMEN   #}
<div id="edit-tournament-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-custom-blue-400">Edit Turnamen</h2>
            <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto">
            <form id="edit-tournament-form" method="POST" class="space-y-4">
                {% csrf_token %}
                {# Field dasar turnamen #}
                <div>
                    <label for="id_name" class="block text-sm font-semibold text-gray-700 mb-1">Nama Turnamen <span class="text-red-500">*</span></label>
                    <input type="text" name="name" id="id_name" maxlength="255" required placeholder="Nama Turnamen">
                    <div id="error-edit-name" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                <div>
                    <label for="id_description" class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi</label>
                    <textarea name="description" id="id_description" rows="3" placeholder="Deskripsi singkat turnamen..."></textarea>
                    <div id="error-edit-description" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                 <div>
                    <label for="id_banner" class="block text-sm font-semibold text-gray-700 mb-1">URL Banner (Opsional)</label>
                    <input type="url" name="banner" id="id_banner" maxlength="500" placeholder="https://example.com/banner.jpg">
                    <div id="error-edit-banner" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                <div>
                    <label for="id_start_date" class="block text-sm font-semibold text-gray-700 mb-1">Tanggal Mulai <span class="text-red-500">*</span></label>
                    <input type="date" name="start_date" id="id_start_date" required>
                    <div id="error-edit-start_date" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                <div>
                    <label for="id_end_date" class="block text-sm font-semibold text-gray-700 mb-1">Tanggal Selesai <span class="text-red-500">*</span></label>
                    <input type="date" name="end_date" id="id_end_date" required>
                    <div id="error-edit-end_date" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>

                <div class="flex items-center">
                    {{ edit_form.registration_open }}
                    <label for="id_registration_open" class="ml-2 text-sm font-semibold text-gray-700">Buka Pendaftaran Tim</label>
                </div>
                <div id="error-edit-registration_open" class="text-red-500 text-sm mt-1 font-medium"></div>

                {#   Field Peserta (Searchable)   #}
                <div class="relative"> {# Use relative positioning for dropdown #}
                    <label for="participant-search-input" class="block text-sm font-semibold text-gray-700 mb-1">Cari Tim Peserta</label>
                    <input type="search" id="participant-search-input" placeholder="Ketik nama tim..."
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-custom-blue-300 focus:border-custom-blue-300">
                    <div id="participant-search-results" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden">
                        {# Hasil pencarian akan dimasukkan di sini oleh JS #}
                    </div>
                  {{ edit_form.participants }} {# Renders the <select multiple hidden> #}

                  <div id="selected-participants-display" class="mt-2 space-x-2 space-y-1">
                      {# Badge tim terpilih akan dimasukkan di sini oleh JS #}
                  </div>
                  <div id="error-edit-participants" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                 <div id="error-edit-non_field_errors" class="text-red-500 text-sm mt-1 font-medium"></div>

                 <div class="pt-4 mt-6 border-t border-gray-200">
                    <button type="submit" id="edit-submit-btn" class="w-full bg-custom-blue-400 text-white font-bold py-2.5 px-4 rounded-lg
                               hover:bg-custom-blue-300 focus:outline-none focus:ring-2
                               focus:ring-offset-2 focus:ring-custom-blue-300 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-wait">
                        Simpan Perubahan
                    </button>
                 </div>
            </form>
        </div>
    </div>
</div>
{#   End Modal Edit   #}

{#   MODAL KONFIRMASI HAPUS   #}
<div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
            <h2 class="text-xl font-bold text-red-600">Konfirmasi Penghapusan</h2>
            <button id="close-delete-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div class="p-6">
            <p id="delete-confirm-message" class="text-gray-700 mb-6">Apakah Anda yakin ingin menghapus turnamen ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    Batal
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-wait">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>
{#   End Modal Konfirmasi Hapus   #}

{#   MODAL KONFIRMASI HAPUS TIM (BY ADMIN)   #}
<div id="remove-team-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
            <h2 class="text-xl font-bold text-red-600">Konfirmasi Hapus Tim</h2>
            <button id="close-remove-team-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div class="p-6">
            <p id="remove-team-confirm-message" class="text-gray-700 mb-6">Apakah Anda yakin ingin menghapus tim ini dari turnamen?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-remove-team-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    Batal
                </button>
                <button id="confirm-remove-team-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-wait">
                    Ya, Hapus Tim
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DEBUG: DOMContentLoaded fired."); 

        const tournamentId = document.body.dataset.tournamentId;
        if (!tournamentId) {
            console.error("DEBUG: Tournament ID not found!");
            return;
        }
        console.log("DEBUG: Tournament ID:", tournamentId); 

        let currentTournamentData = null;

        // Elemen Halaman 
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const contentDiv = document.getElementById('tournament-content');
        const managementButtonsDiv = document.getElementById('management-buttons');
        const bannerContainer = document.getElementById('tournament-banner-container');
        const nameEl = document.getElementById('tournament-name');
        const organizerLink = document.getElementById('organizer-link');
        const datesEl = document.getElementById('tournament-dates');
        const descriptionEl = document.getElementById('tournament-description');
        const matchList = document.getElementById('match-list');
        const noMatchesMessageDisplay = document.getElementById('no-matches-message-display');
        const forumLink = document.getElementById('forum-link');
        const predictionsLink = document.getElementById('predictions-link');
        const participantList = document.getElementById('participant-list');
        const noParticipantsMessage = document.getElementById('no-participants-message');
        const registrationStatusBadge = document.getElementById('registration-status-badge');
        const winnerNameDisplay = document.getElementById('winner-name-display');
        const teamRegistrationContainer = document.getElementById('team-registration-container');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const noLeaderboardMessage = document.getElementById('no-leaderboard-message');

        // Elemen Modal Edit
        const editModal = document.getElementById('edit-tournament-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editForm = document.getElementById('edit-tournament-form');
        const editSubmitBtn = document.getElementById('edit-submit-btn');
        const participantsCheckboxContainer = document.getElementById('id_participants_container');
        const registrationOpenCheckbox = document.getElementById('id_registration_open');
        const participantSearchInput = document.getElementById('participant-search-input');
        const participantSearchResults = document.getElementById('participant-search-results');
        const selectedParticipantsDisplay = document.getElementById('selected-participants-display');
        const hiddenParticipantsSelect = document.getElementById('id_participants');

        // Elemen Modal Hapus
        const deleteModal = document.getElementById('delete-confirm-modal');
        const closeDeleteModalBtn = document.getElementById('close-delete-modal-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');

        // Elemen Modal Hapus Tim (Admin)
        const removeTeamModal = document.getElementById('remove-team-modal');
        const closeRemoveTeamModalBtn = document.getElementById('close-remove-team-modal-btn');
        const cancelRemoveTeamBtn = document.getElementById('cancel-remove-team-btn');
        const confirmRemoveTeamBtn = document.getElementById('confirm-remove-team-btn');
        const removeTeamConfirmMessage = document.getElementById('remove-team-confirm-message');

        const defaultBannerSvg = `<div class="w-full h-48 md:h-64 bg-custom-blue-100 rounded-lg flex items-center justify-center"><svg class="w-16 h-16 text-custom-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10m0-2.657A8 8 0 0121.657 15S21 13 19 12m0 6.657a8 8 0 01-11.314-11.314m1.414 1.414A6 6 0 0119 12m-2 2a6 6 0 01-5.586 5.586"></path></svg></div>`;
        const defaultTeamLogoSvg = `<svg class="w-full h-full text-custom-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>`;

        function safeGetElement(id, name) {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`DEBUG: Essential element "${name}" (#${id}) not found!`);
            }
            return el;
        }
         const essentialElements = [
             loadingIndicator, errorMessage, contentDiv, managementButtonsDiv, bannerContainer, nameEl, organizerLink, datesEl,
             descriptionEl, matchList, noMatchesMessageDisplay, forumLink, predictionsLink, participantList, noParticipantsMessage,
             registrationStatusBadge, winnerNameDisplay, teamRegistrationContainer
         ];
         if (essentialElements.some(el => !el)) {
              console.error("DEBUG: Stopping script - one or more essential page elements missing on initial load.");
              if(errorMessage) { errorMessage.textContent = 'Page structure error.'; errorMessage.classList.remove('hidden'); }
              if(loadingIndicator) loadingIndicator.classList.add('hidden');
              return; 
         }
         console.log("DEBUG: All essential page elements verified.");

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const fetchTeamResults = debounce(async (query) => {
            if (!participantSearchResults || query.length < 2) {
                if(participantSearchResults) participantSearchResults.classList.add('hidden');
                return;
            }
            console.log("DEBUG: Searching teams for:", query);

            const selectedIds = Array.from(hiddenParticipantsSelect.selectedOptions).map(opt => opt.value);

            try {
                let searchUrl = `/tournaments/search_teams/?q=${encodeURIComponent(query)}`;
                // selectedIds.forEach(id => searchUrl += `&exclude_ids[]=${id}`); // Optional exclude

                const response = await fetch(searchUrl);
                if (!response.ok) throw new Error('Search failed');
                const teams = await response.json();

                participantSearchResults.innerHTML = ''; 
                if (teams.length > 0) {
                    teams.forEach(team => {
                        if (!selectedIds.includes(team.id.toString())) {
                        const item = document.createElement('div');
                        item.textContent = team.name;
                        item.classList.add('px-3', 'py-2', 'hover:bg-custom-blue-100', 'cursor-pointer', 'text-sm');
                        item.dataset.teamId = team.id;
                        item.dataset.teamName = team.name;
                        item.addEventListener('click', handleTeamSelect);
                        participantSearchResults.appendChild(item);
                        }
                    });
                    if (participantSearchResults.children.length > 0) { 
                        participantSearchResults.classList.remove('hidden');
                    } else {
                        participantSearchResults.classList.add('hidden');
                    }
                } else {
                    participantSearchResults.classList.add('hidden');
                }
            } catch (error) {
                console.error("DEBUG: Error fetching team results:", error);
                participantSearchResults.classList.add('hidden');
            }
        }, 300); 

        function handleTeamSelect(event) {
            const teamId = event.target.dataset.teamId;
            const teamName = event.target.dataset.teamName;

            console.log("DEBUG: Selected team:", teamId, teamName);

            const option = hiddenParticipantsSelect.querySelector(`option[value="${teamId}"]`);
            if (option) {
                option.selected = true;
            } else {
                console.warn("DEBUG: Option for selected team not found in hidden select. Creating.");
                const newOption = new Option(teamName, teamId, false, true); 
                hiddenParticipantsSelect.appendChild(newOption);
            }


            addSelectedTeamBadge(teamId, teamName);

            if(participantSearchInput) participantSearchInput.value = '';
            if(participantSearchResults) participantSearchResults.classList.add('hidden');
        }

        function addSelectedTeamBadge(teamId, teamName) {
            if (!selectedParticipantsDisplay) return;
            if (selectedParticipantsDisplay.querySelector(`[data-team-id="${teamId}"]`)) return;

            const badge = document.createElement('span');
            badge.dataset.teamId = teamId;
            badge.classList.add('inline-flex', 'items-center', 'px-2.5', 'py-0.5', 'rounded-full', 'text-xs', 'font-medium', 'bg-custom-blue-100', 'text-custom-blue-800');
            badge.textContent = teamName;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;'; 
            removeBtn.classList.add('ml-1.5', 'text-custom-blue-400', 'hover:text-custom-blue-700', 'focus:outline-none');
            removeBtn.addEventListener('click', () => handleTeamRemove(teamId));

            badge.appendChild(removeBtn);
            selectedParticipantsDisplay.appendChild(badge);
        }

        function handleTeamRemove(teamId) {
            console.log("DEBUG: Removing team:", teamId);
            const option = hiddenParticipantsSelect.querySelector(`option[value="${teamId}"]`);
            if (option) {
                option.selected = false;
            }

            const badge = selectedParticipantsDisplay.querySelector(`[data-team-id="${teamId}"]`);
            if (badge) {
                badge.remove();
            }
        }
        function styleModalForm(formEl) {
             if (!formEl) return;
             try {
                 formEl.querySelectorAll('p').forEach(p => {
                     const isWrapper = p.querySelector('label') || p.querySelector('input, textarea, select');
                     if (isWrapper && !p.querySelector('div[id^="error-"]') && p.children.length <= 2) {
                         p.replaceWith(...p.childNodes);
                     }
                 });
                 formEl.querySelectorAll('label:not(#id_participants_container label):not([for="id_registration_open"])').forEach(label => label.classList.add('block', 'text-sm', 'font-semibold', 'text-gray-700', 'mb-1'));
                 formEl.querySelectorAll('input[type="text"], input[type="date"], input[type="url"], textarea').forEach(el => el.classList.add('block', 'w-full', 'px-3', 'py-2', 'mt-1', 'border', 'border-gray-300', 'rounded-md', 'shadow-sm', 'placeholder-gray-400', 'text-gray-900', 'focus:outline-none', 'focus:ring-2', 'focus:ring-custom-blue-300', 'focus:border-custom-blue-300', 'transition', 'duration-150', 'ease-in-out'));
                 formEl.querySelectorAll('.helptext').forEach(el => el.classList.add('hidden'));

                 if (participantsCheckboxContainer) {
                     const ul = participantsCheckboxContainer.querySelector('ul');
                     if (ul) {
                         const items = Array.from(ul.children); participantsCheckboxContainer.innerHTML = '';
                         items.forEach(li => {
                             const label = li.querySelector('label');
                             if (label) {
                                 label.classList.add('flex', 'items-center', 'text-sm', 'text-gray-700', 'cursor-pointer', 'hover:bg-gray-100', 'p-1', 'rounded');
                                 const input = label.querySelector('input[type="checkbox"]');
                                 if (input) { input.classList.add('h-4', 'w-4', 'text-custom-blue-400', 'border-gray-300', 'rounded', 'focus:ring-custom-blue-300', 'mr-2'); }
                             } participantsCheckboxContainer.appendChild(li);
                         });
                     } else { participantsCheckboxContainer.querySelectorAll('label').forEach(label => { /* Fallback */ }); }
                 }
                 if (registrationOpenCheckbox) { registrationOpenCheckbox.classList.add('h-4', 'w-4', 'text-custom-blue-400', 'border-gray-300', 'rounded', 'focus:ring-custom-blue-300'); }

                 formEl.querySelectorAll('input, textarea, select, #id_participants_container').forEach(el => {
                    let fieldName = el.id.startsWith('id_') ? el.id.substring(3) : el.name;
                    if (!fieldName || fieldName === 'csrfmiddlewaretoken') return;
                    let errorDivId = `error-edit-${fieldName}`;
                    if (el.id === 'id_participants_container') { fieldName = 'participants'; errorDivId = `error-edit-participants`; }
                    let errorDiv = document.getElementById(errorDivId);
                    if (!errorDiv) {
                        errorDiv = document.createElement('div'); errorDiv.id = errorDivId; errorDiv.className = 'text-red-500 text-sm mt-1 font-medium';
                        const parent = (el.id === 'id_registration_open') ? el.parentElement : el;
                        if (parent && parent.parentNode) { parent.parentNode.insertBefore(errorDiv, parent.nextSibling); }
                        else { console.warn("DEBUG: styleModalForm - Could not find parentNode for errorDiv:", el); }
                    }
                 });
                 console.log("DEBUG: styleModalForm finished.");
             } catch (e) { console.error("DEBUG: Error in styleModalForm:", e); }
        }

        function populatePage(data) {
            console.log("DEBUG: populatePage started.");
            currentTournamentData = data;
            try {
                styleModalForm(editForm); 

                console.log("DEBUG: Populating banner...");
                if (bannerContainer) {
                    if (data.banner_url) { bannerContainer.innerHTML = `<img src="${data.banner_url}" alt="Banner ${data.name}" class="w-full h-48 md:h-64 object-cover rounded-lg" onerror="console.warn('DEBUG: Banner image failed to load!'); this.parentElement.innerHTML = defaultBannerSvg;">`; }
                    else { bannerContainer.innerHTML = defaultBannerSvg; }
                }

                console.log("DEBUG: Populating basic info...");
                if (nameEl) nameEl.textContent = data.name;
                if (organizerLink) { organizerLink.textContent = data.organizer_username; organizerLink.href = data.organizer_profile_url;}
                if (datesEl) datesEl.textContent = `${data.start_date_formatted} - ${data.end_date_formatted}`;
                if (descriptionEl) descriptionEl.innerHTML = data.description ? data.description.replace(/\n/g, '<br>') : 'Tidak ada deskripsi.';

                console.log("DEBUG: Populating status...");
                if (registrationStatusBadge) {
                    if (data.registration_open) { registrationStatusBadge.textContent = 'Dibuka'; registrationStatusBadge.className = 'px-3 py-1 text-xs font-bold rounded-full bg-green-100 text-green-800'; }
                    else { registrationStatusBadge.textContent = 'Ditutup'; registrationStatusBadge.className = 'px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-800'; }
                }
                if (winnerNameDisplay) {
                    if (data.winner_name) { winnerNameDisplay.textContent = data.winner_name; winnerNameDisplay.classList.add('font-bold'); }
                    else { winnerNameDisplay.textContent = 'Belum ditentukan'; winnerNameDisplay.classList.remove('font-bold'); }
                }

                console.log("DEBUG: Populating participants...");
                if (participantList) {
                    participantList.innerHTML = ''; 
                    if (noParticipantsMessage) noParticipantsMessage.classList.add('hidden');

                    if (data.participants && Array.isArray(data.participants) && data.participants.length > 0) {
                        console.log(`DEBUG: Found ${data.participants.length} participants. Rendering...`);
                        let participantsHtmlContent = '';
                        data.participants.forEach((team) => {
                            const logoHtml = team.logo_url ? `<img src="${team.logo_url}" alt="Logo ${team.name}" class="h-16 w-auto object-contain mx-auto" onerror="console.warn('DEBUG: Logo failed to load for ${team.name}'); this.parentElement.innerHTML = defaultTeamLogoSvg;">` : `<div class="h-16 w-full flex items-center justify-center bg-gray-100 rounded-t-lg">${defaultTeamLogoSvg}</div>`;
                            let removeBtnHtml = '';
                            if (data.is_organizer_or_admin) {
                                removeBtnHtml = `
                                    <button 
                                        title="Hapus tim ${team.name}"
                                        class="open-remove-team-modal-btn absolute top-1 right-1 z-10 p-0.5 bg-red-100 text-red-600 rounded-full hover:bg-red-200 hover:text-red-700 opacity-60 group-hover:opacity-100 transition-opacity"
                                        data-team-id="${team.id}"
                                        data-team-name="${team.name}">
                                        <svg class="w-4 h-4 pointer-events-none" fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                `;
                            }

                            participantsHtmlContent += `
                                <div class="relative border border-gray-200 rounded-lg shadow-sm overflow-hidden flex flex-col items-center text-center bg-white hover:shadow transition-shadow duration-150 group">
                                    ${removeBtnHtml} 
                                    <div class="w-full h-20 flex items-center justify-center p-2 bg-gray-50 group-hover:bg-gray-100 transition-colors duration-150 border-b border-gray-100">
                                        ${logoHtml}
                                    </div>
                                    <p class="text-xs font-medium text-gray-700 p-2 w-full truncate">${team.name || 'N/A'}</p>
                                </div>
                            `;
                        });
                        participantList.innerHTML = participantsHtmlContent;
                        console.log("DEBUG: Finished rendering participants.");
                    } else {
                        console.log("DEBUG: No participants found.");
                        if (noParticipantsMessage) noParticipantsMessage.classList.remove('hidden');
                    }
                } else console.error("DEBUG: participantList element NOT FOUND!");

                console.log("DEBUG: Populating leaderboard...");
                if (leaderboardBody && noLeaderboardMessage && leaderboardContainer) {
                    leaderboardBody.innerHTML = ''; 
                    
                    if (data.leaderboard && Array.isArray(data.leaderboard) && data.leaderboard.length > 0 && data.leaderboard.some(t => t.played > 0)) {
                        noLeaderboardMessage.classList.add('hidden');
                        leaderboardContainer.classList.remove('hidden'); 
                        
                        let leaderboardHtmlContent = '';
                        data.leaderboard.forEach((team, index) => {
                            const logoHtml = team.team_logo 
                                ? `<img src="${team.team_logo}" alt="Logo ${team.team_name}" class="h-6 w-6 rounded-full object-cover mr-2 flex-shrink-0" onerror="console.warn('DEBUG: Logo failed to load for ${team.team_name}'); this.parentElement.innerHTML = defaultTeamLogoSvg.replace('class=\"w-full h-full', 'class=\"w-6 h-6');">`
                                : `<div class="h-6 w-6 rounded-full bg-gray-100 mr-2 flex-shrink-0 flex items-center justify-center">${defaultTeamLogoSvg.replace('class="w-full h-full', 'class="w-5 h-5"')}</div>`; // Sedikit lebih kecil untuk di dalam div

                            leaderboardHtmlContent += `
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${index + 1}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <div class="flex items-center">
                                            ${logoHtml}
                                            <span class="truncate" title="${team.team_name}">${team.team_name}</span>
                                        </div>
                                    </td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center">${team.played}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center">${team.wins}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center">${team.draws}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center">${team.losses}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center font-medium">${team.goals_for}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center">${team.goals_against}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-600 text-center">${team.goal_difference > 0 ? '+' : ''}${team.goal_difference}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900 text-center font-bold">${team.points}</td>
                                </tr>
                            `;
                        });
                        leaderboardBody.innerHTML = leaderboardHtmlContent;
                    } else {
                        console.log("DEBUG: No leaderboard data or no matches played.");
                        noLeaderboardMessage.classList.remove('hidden');
                        leaderboardContainer.classList.add('hidden'); // Sembunyikan tabel
                    }
                } else {
                    console.error("DEBUG: leaderboardBody, noLeaderboardMessage, or leaderboardContainer element NOT FOUND!");
                }

                console.log("DEBUG: Populating matches...");
                if (matchList) {
                    matchList.innerHTML = ''; 
                    const noMatchesMsgEl = noMatchesMessageDisplay;

                    if (data.matches && Array.isArray(data.matches) && data.matches.length > 0) {
                        console.log(`DEBUG: Found ${data.matches.length} matches. Rendering...`);
                        if (noMatchesMsgEl) noMatchesMsgEl.classList.add('hidden');
                        let matchesHtmlContent = '';
                        data.matches.forEach((match) => {
                            let matchDateFormatted = match.match_date_formatted || 'N/A';
                            if (!match.match_date_formatted && match.match_date) { try { let d=new Date(match.match_date.endsWith('Z') ? match.match_date : match.match_date + 'Z'); matchDateFormatted = d.toLocaleString('id-ID',{/*options*/}); } catch(e){console.warn('Match date format error',e);} }
                            const homeTeamName = match.home_team_name || 'N/A';
                            const awayTeamName = match.away_team_name || 'N/A';
                            const scoreDisplay = (match.home_score !== null && match.away_score !== null) ? `<span class="font-bold">${match.home_score} - ${match.away_score}</span>` : `<span class="text-sm ...">Belum Dimulai</span>`;
                            matchesHtmlContent += `<div class="p-4 border ..."><div ...><span ...>${homeTeamName}</span> vs <span ...>${awayTeamName}</span><p ...>${matchDateFormatted}</p></div><div ...>${scoreDisplay}</div></div>`;
                        });
                        matchList.innerHTML = matchesHtmlContent;
                        console.log("DEBUG: Finished rendering matches.");
                    } else {
                        console.log("DEBUG: No matches found.");
                        if (noMatchesMsgEl) noMatchesMsgEl.classList.remove('hidden');
                    }
                } else console.error("DEBUG: matchList element NOT FOUND!");

                // Links
                console.log("DEBUG: Populating links...");
                if (forumLink) forumLink.href = data.forum_url || '#';
                if (predictionsLink) predictionsLink.href = data.predictions_url || '#';

                // Management Buttons
                console.log("DEBUG: Populating management buttons...");
                if (managementButtonsDiv) {
                    managementButtonsDiv.innerHTML = '';
                    if (data.is_organizer_or_admin) {
                        console.log("DEBUG: User is organizer/admin, adding buttons.");
                        // Edit Button
                        const editButtonHtml = `<button id="open-edit-modal-btn" class="bg-custom-blue-300 text-white font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-400 transition-colors text-sm">Edit Turnamen</button>`;
                        managementButtonsDiv.insertAdjacentHTML('beforeend', editButtonHtml);
                        const editBtn = document.getElementById('open-edit-modal-btn');
                        if (editBtn && editModal) { 
                             console.log("DEBUG: Adding editBtn listener.");
                             editBtn.addEventListener('click', openEditModal);
                        } else console.warn("DEBUG: Edit button or modal not found for listener.");

                        // Delete Button
                        const deleteButtonHtml = `<button id="open-delete-modal-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">Hapus Turnamen</button>`;
                        managementButtonsDiv.insertAdjacentHTML('beforeend', deleteButtonHtml);
                        const openDeleteBtn = document.getElementById('open-delete-modal-btn');
                        if (openDeleteBtn && deleteModal) { 
                             console.log("DEBUG: Adding openDeleteBtn listener.");
                             openDeleteBtn.addEventListener('click', openDeleteModal);
                         } else console.warn("DEBUG: Delete button or modal not found for listener.");
                    } else { console.log("DEBUG: User is not organizer/admin."); }
                } else console.error("DEBUG: managementButtonsDiv element NOT FOUND!");


                console.log("DEBUG: Showing content div...");
                if (contentDiv) contentDiv.classList.remove('hidden');
                console.log("DEBUG: Calling checkCaptainStatus...");
                checkCaptainStatus(); 
                console.log("DEBUG: populatePage finished successfully."); 
            } catch (e) {
                console.error("DEBUG: CRITICAL Error inside populatePage:", e); 
                if(errorMessage){ errorMessage.textContent = `Error displaying page data: ${e.message}`; errorMessage.classList.remove('hidden'); }
            } finally {
                 if(loadingIndicator) loadingIndicator.classList.add('hidden');
                 console.log("DEBUG: populatePage finally block executed.");
            }
        }

        async function fetchTournamentDetails() {
            console.log("DEBUG: fetchTournamentDetails called."); 
            if(loadingIndicator) loadingIndicator.classList.remove('hidden'); 
            if(errorMessage) errorMessage.classList.add('hidden');
            if(contentDiv) contentDiv.classList.add('hidden'); 
            try {
                const response = await fetch(`/tournaments/json/${tournamentId}/`);
                console.log("DEBUG: Fetch response status:", response.status); 
                if (!response.ok) throw new Error(`Server error (Status: ${response.status})`);
                const data = await response.json();
                console.log("DEBUG: Fetched data:", JSON.stringify(data, null, 2)); 
                if (data.error) throw new Error(data.error);
                populatePage(data);
            } catch (error) {
                console.error("DEBUG: Error in fetchTournamentDetails:", error); 
                if(errorMessage) {
                    errorMessage.textContent = `Failed to load details: ${error.message}`;
                    errorMessage.classList.remove('hidden');
                }
                if (typeof showToast === 'function') showToast(`Failed to load details: ${error.message}`, 'error');
            } finally {
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
                console.log("DEBUG: fetchTournamentDetails finally block executed."); 
            }
        }

        async function checkCaptainStatus() {
            console.log("DEBUG: checkCaptainStatus called.");
            if (!teamRegistrationContainer) { console.warn("DEBUG: teamRegistrationContainer not found."); return; }
            teamRegistrationContainer.innerHTML = ''; 

            if (!currentTournamentData) {
                console.log("DEBUG: No data, skipping captain check.");
                return;
            }
            try {
                const response = await fetch(`/tournaments/captain_status/${tournamentId}/`);
                if (!response.ok) { console.warn("DEBUG: captain_status fetch failed with status:", response.status); return; }
                const data = await response.json();
                console.log("DEBUG: Captain status data:", data);

                if (data.can_register && data.eligible_teams && data.eligible_teams.length > 0) {
                     console.log("DEBUG: User can register, adding register buttons.");
                    data.eligible_teams.forEach(team => {
                        const buttonHtml = `
                        <button id="register-team-btn-${team.id}"
                                data-team-id="${team.id}"
                                class="register-team-btn w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg
                                     hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2
                                     focus:ring-green-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-wait mb-2">
                            Daftarkan Tim: ${team.name}
                        </button>`;
                        teamRegistrationContainer.insertAdjacentHTML('beforeend', buttonHtml);
                    });
                    document.querySelectorAll('.register-team-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const teamId = this.dataset.teamId;
                            handleTeamRegistration(teamId, this);
                        });
                    });
                }

                if (data.can_deregister && data.registered_teams && data.registered_teams.length > 0) {
                    console.log("DEBUG: User can de-register, adding de-register buttons.");
                    
                    let canDeregisterByRule = data.is_registration_open || (new Date(currentTournamentData.start_date_raw) > new Date());
                    let titleText = canDeregisterByRule ? "Batalkan pendaftaran tim Anda" : "Pendaftaran sudah ditutup / turnamen sudah dimulai";

                    data.registered_teams.forEach(team => {
                        const buttonHtml = `
                        <button id="deregister-team-btn-${team.id}"
                                data-team-id="${team.id}"
                                data-team-name="${team.name}"
                                title="${titleText}"
                                class="deregister-team-btn w-full sm:w-auto bg-red-600 text-white font-bold py-2 px-4 rounded-lg
                                     hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2
                                     focus:ring-red-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-wait mb-2"
                                ${!canDeregisterByRule ? 'disabled' : ''}>
                            Batal Mendaftar: ${team.name}
                        </button>`;
                        teamRegistrationContainer.insertAdjacentHTML('beforeend', buttonHtml);
                    });
                    
                    document.querySelectorAll('.deregister-team-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const teamId = this.dataset.teamId;
                            const teamName = this.dataset.teamName;
                            handleTeamDeregistration(teamId, teamName, this);
                        });
                    });
                }

            } catch (error) { console.error("DEBUG: Error checking captain status:", error); }
        }

        async function handleTeamRegistration(teamId, buttonEl) {
            console.log("DEBUG: handleTeamRegistration called for team ID:", teamId);
            if(!buttonEl) return; 
            buttonEl.disabled = true;
            buttonEl.textContent = 'Mendaftarkan...';
            const csrfToken = document.querySelector('#edit-tournament-form [name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) {
                 console.error("DEBUG: CSRF token not found for registration!");
                 if (typeof showToast === 'function') showToast('Kesalahan keamanan, muat ulang.', 'error');
                 buttonEl.disabled = false; buttonEl.textContent = 'Error: Reload'; return;
            }
            const formData = new FormData();
            formData.append('team_id', teamId); 
            try {
                const response = await fetch(`/tournaments/${tournamentId}/register_team/`, {
                     method: 'POST', headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }, body: formData
                 });
                const data = await response.json();
                 console.log("DEBUG: Registration response status:", response.status, "Data:", data);
                if (response.ok && data.status === 'success') {
                    if (typeof showToast === 'function') showToast(data.message, 'success');
                    fetchTournamentDetails(); 
                } else {
                    throw new Error(data.message || `Server error (${response.status})`);
                }
            } catch (error) {
                 console.error('DEBUG: Error registering team:', error);
                 if (typeof showToast === 'function') showToast(`Gagal mendaftar: ${error.message}`, 'error');
                 buttonEl.disabled = false; buttonEl.textContent = `Daftarkan Tim (Gagal)`; // Reset button text on error
             }
        }

        async function handleTeamDeregistration(teamId, teamName, buttonEl) {
            console.log("DEBUG: handleTeamDeregistration called for team ID:", teamId);

            if (!confirm(`Apakah Anda yakin ingin membatalkan pendaftaran tim "${teamName}" dari turnamen ini?`)) {
                return;
            }

            if(!buttonEl) return; 
            buttonEl.disabled = true;
            buttonEl.textContent = 'Membatalkan...';
            
            const csrfToken = document.querySelector('#edit-tournament-form [name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) {
                 console.error("DEBUG: CSRF token not found for de-registration!");
                 if (typeof showToast === 'function') showToast('Kesalahan keamanan, muat ulang.', 'error');
                 buttonEl.disabled = false; buttonEl.textContent = 'Error: Reload'; return;
            }
            
            try {
                const response = await fetch(`/tournaments/${tournamentId}/deregister_team/`, {
                     method: 'POST', 
                     headers: { 
                         'X-CSRFToken': csrfToken, 
                         'Accept': 'application/json' 
                     },
                 });
                const data = await response.json();
                 console.log("DEBUG: De-registration response status:", response.status, "Data:", data);
                
                if (response.ok && data.status === 'success') {
                    if (typeof showToast === 'function') showToast(data.message, 'success');
                    fetchTournamentDetails(); 
                } else {
                    throw new Error(data.message || `Server error (${response.status})`);
                }
            } catch (error) {
                 console.error('DEBUG: Error de-registering team:', error);
                 if (typeof showToast === 'function') showToast(`Gagal batal mendaftar: ${error.message}`, 'error');
                 buttonEl.disabled = false; 
                 buttonEl.textContent = `Batal Mendaftar: ${teamName}`; 
             }
        }

        // Modal Opening/Closing Functions 
        function openModal(modalEl) {
             if (!modalEl) { console.error("DEBUG: Attempted to open a null modal element."); return; }
             console.log("DEBUG: Opening modal:", modalEl.id);
             modalEl.classList.remove('hidden');
             requestAnimationFrame(() => {
                 modalEl.classList.remove('opacity-0');
                 const innerDiv = modalEl.querySelector('.transform'); 
                 if(innerDiv) innerDiv.classList.remove('scale-95');
             });
        }

        function closeModal(modalEl) {
            if (!modalEl) { console.error("DEBUG: Attempted to close a null modal element."); return; }
            console.log("DEBUG: Closing modal:", modalEl.id);
            modalEl.classList.add('opacity-0');
            const innerDiv = modalEl.querySelector('.transform');
            if(innerDiv) innerDiv.classList.add('scale-95');
            setTimeout(() => {
                modalEl.classList.add('hidden');
                const form = modalEl.querySelector('form');
                 if(form) {
                    form.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
                    form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
                 }
            }, 300); 
        }

        function openEditModal() {
            console.log("DEBUG: openEditModal called.");
            if (!currentTournamentData || !editForm || !hiddenParticipantsSelect || !selectedParticipantsDisplay || !participantSearchInput) {
                console.error("DEBUG: openEditModal - Missing required elements or data.");
                return;
            }

            editForm.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
            editForm.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
            if (participantsCheckboxContainer) participantsCheckboxContainer.classList.remove('border', 'border-red-500');


            document.getElementById('id_name').value = currentTournamentData.name || '';
            document.getElementById('id_description').value = currentTournamentData.description || '';
            document.getElementById('id_banner').value = currentTournamentData.banner_url || '';
            document.getElementById('id_start_date').value = currentTournamentData.start_date_raw || '';
            document.getElementById('id_end_date').value = currentTournamentData.end_date_raw || '';
            if (registrationOpenCheckbox) {
                registrationOpenCheckbox.checked = currentTournamentData.registration_open;
            }

            selectedParticipantsDisplay.innerHTML = ''; 
            Array.from(hiddenParticipantsSelect.options).forEach(opt => opt.selected = false);
            const noSelectedMsg = document.getElementById('no-selected-participants-msg'); 

            if (currentTournamentData.participants && Array.isArray(currentTournamentData.participants) && currentTournamentData.participants.length > 0) {
                 console.log("DEBUG: Pre-populating selected participants:", currentTournamentData.participants);
                 if (noSelectedMsg) noSelectedMsg.classList.add('hidden'); 

                 currentTournamentData.participants.forEach(team => {
                     const option = hiddenParticipantsSelect.querySelector(`option[value="${team.id}"]`);
                     if (option) {
                         option.selected = true; 
                         addSelectedTeamBadge(team.id, team.name);
                     } else {     
                         console.warn(`DEBUG: Option not found for pre-populating existing participant ID ${team.id} (${team.name}). This team might be missing from the form's initial queryset.`);
                         addSelectedTeamBadge(team.id, team.name);
                     }
                 });
            } else {
                 console.log("DEBUG: No participants to pre-populate.");
                 if (noSelectedMsg) noSelectedMsg.classList.remove('hidden');
            }

            participantSearchInput.value = '';
            if(participantSearchResults) participantSearchResults.classList.add('hidden');


            openModal(editModal); 
        }
        
        function closeEditModal() { closeModal(editModal); } 

        function openDeleteModal() {
            console.log("DEBUG: openDeleteModal called.");
            if (!currentTournamentData || !deleteConfirmMessage) return;
            const tournamentName = currentTournamentData.name || "turnamen ini";
            deleteConfirmMessage.textContent = `Apakah Anda yakin ingin menghapus turnamen "${tournamentName}"? Tindakan ini tidak dapat dibatalkan.`;
            if (confirmDeleteBtn) { confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Ya, Hapus'; }
            openModal(deleteModal); 
        }

        function closeDeleteModal() { closeModal(deleteModal); } 

        function openRemoveTeamModal(teamId, teamName) {
            console.log("DEBUG: openRemoveTeamModal called for:", teamId, teamName);
            if (!removeTeamModal || !removeTeamConfirmMessage || !confirmRemoveTeamBtn) return;
            
            removeTeamModal.dataset.teamId = teamId; 
            
            removeTeamConfirmMessage.textContent = `Apakah Anda yakin ingin menghapus tim "${teamName}" dari turnamen?`;
            confirmRemoveTeamBtn.disabled = false;
            confirmRemoveTeamBtn.textContent = 'Ya, Hapus Tim';
            openModal(removeTeamModal);
        }

        function closeRemoveTeamModal() { 
            closeModal(removeTeamModal); 
            if (removeTeamModal) removeTeamModal.dataset.teamId = ''; // Clear stored ID
        }

        // Attach Event Listeners 
        if (participantSearchInput) {
            participantSearchInput.addEventListener('input', (e) => fetchTeamResults(e.target.value));
            participantSearchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if(participantSearchResults) participantSearchResults.classList.add('hidden');
                }, 150); 
            });
            participantSearchInput.addEventListener('focus', (e) => {
                if(e.target.value.length >= 2) fetchTeamResults(e.target.value);
            });

        } else { console.warn("DEBUG: Participant search input not found."); }
        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
        if (editModal) editModal.addEventListener('click', (event) => { if (event.target === editModal) closeEditModal(); });
        if (editForm && editSubmitBtn) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                editSubmitBtn.disabled = true; editSubmitBtn.textContent = 'Menyimpan...';
                editForm.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
                editForm.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));

                const formData = new FormData(editForm);
                const csrfToken = formData.get('csrfmiddlewaretoken');
                try {
                    const response = await fetch(`/tournaments/edit/${tournamentId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }, body: formData });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        closeEditModal();
                        if (typeof showToast === 'function') showToast(data.message, 'success');
                        populatePage(data.tournament);
                    } else {
                         let generalErrorMessage = data.message || 'Validation error.';
                         if (data.errors) {
                             Object.keys(data.errors).forEach(fieldName => {
                                 const errorDivId = `error-edit-${fieldName === '__all__' ? 'non_field_errors' : fieldName}`;
                                 const errorDiv = document.getElementById(errorDivId);
                                 const fieldEl = document.getElementById(`id_${fieldName}`) || editForm.querySelector(`[name="${fieldName}"]`);
                                 if (errorDiv && data.errors[fieldName].length > 0) { errorDiv.textContent = data.errors[fieldName][0].message; }
                                 if (fieldEl && fieldName !== 'participants') { fieldEl.classList.add('border-red-500'); }
                                 else if (fieldName === 'participants' && participantsCheckboxContainer) { participantsCheckboxContainer.classList.add('border', 'border-red-500'); } // Highlight container
                                 if (fieldName === '__all__') { generalErrorMessage = data.errors[fieldName][0].message; }
                             });
                         }
                         if (typeof showToast === 'function') showToast(generalErrorMessage, 'error');
                    }
                } catch (error) {
                    console.error('DEBUG: Error submitting edit form:', error);
                    if (typeof showToast === 'function') showToast('Network error.', 'error');
                } finally {
                    editSubmitBtn.disabled = false; editSubmitBtn.textContent = 'Simpan Perubahan';
                }
            });
        } else { console.warn("DEBUG: Edit form or submit button not found for listener."); }

        // Remove Team Modal Listeners
        if (closeRemoveTeamModalBtn) closeRemoveTeamModalBtn.addEventListener('click', closeRemoveTeamModal);
        if (cancelRemoveTeamBtn) cancelRemoveTeamBtn.addEventListener('click', closeRemoveTeamModal);
        if (removeTeamModal) removeTeamModal.addEventListener('click', (event) => { if (event.target === removeTeamModal) closeRemoveTeamModal(); });
        
        if (confirmRemoveTeamBtn) {
             confirmRemoveTeamBtn.addEventListener('click', async () => {
                 const teamId = removeTeamModal.dataset.teamId;
                 if (!teamId) {
                     console.error("DEBUG: No teamId found on remove-team-modal!");
                     return;
                 }
                 
                 confirmRemoveTeamBtn.disabled = true; 
                 confirmRemoveTeamBtn.textContent = 'Menghapus...';
                 const csrfToken = document.querySelector('#edit-tournament-form [name=csrfmiddlewaretoken]')?.value;
                 if (!csrfToken) { 
                     console.error("DEBUG: CSRF token not found for remove team!");
                     if (typeof showToast === 'function') showToast('Kesalahan keamanan, muat ulang.', 'error');
                     confirmRemoveTeamBtn.disabled = false;
                     return; 
                 }

                 try {
                     const response = await fetch(`/tournaments/${tournamentId}/remove_team/${teamId}/`, { 
                         method: 'POST', 
                         headers: { 
                             'X-CSRFToken': csrfToken, 
                             'Accept': 'application/json' 
                         } 
                     });
                     const data = await response.json();
                     
                     if (response.ok && data.status === 'success') {
                         closeRemoveTeamModal();
                         if (typeof showToast === 'function') showToast(data.message, 'success');
                         fetchTournamentDetails(); // Refresh all page data
                     } else { 
                         throw new Error(data.message || 'Gagal menghapus tim.'); 
                     }
                 } catch (error) {
                     console.error("DEBUG: Error removing team:", error);
                     if (typeof showToast === 'function') showToast(`Error: ${error.message}`, 'error');
                     confirmRemoveTeamBtn.disabled = false; 
                     confirmRemoveTeamBtn.textContent = 'Ya, Hapus Tim';
                 }
             });
        } else { console.warn("DEBUG: Confirm remove team button not found for listener."); }

        // Delete Modal Listeners
        console.log("DEBUG: Attaching delete modal listeners..."); 
        if (closeDeleteModalBtn) closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        if (deleteModal) deleteModal.addEventListener('click', (event) => { if (event.target === deleteModal) closeDeleteModal(); });
        if (confirmDeleteBtn) {
             confirmDeleteBtn.addEventListener('click', async () => {
                 confirmDeleteBtn.disabled = true; confirmDeleteBtn.textContent = 'Menghapus...';
                 const csrfToken = document.querySelector('#edit-tournament-form [name=csrfmiddlewaretoken]')?.value; // Get token from edit form
                 if (!csrfToken) { /* ... CSRF error ... */ return; }
                 try {
                     const response = await fetch(`/tournaments/delete/${tournamentId}/`, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' } });
                     const data = await response.json();
                     if (response.ok && data.status === 'success') {
                         closeDeleteModal();
                         if (typeof showToast === 'function') showToast(data.message, 'success');
                         setTimeout(() => { window.location.href = data.redirect_url; }, 1500); // Redirect after delay
                     } else { throw new Error(data.message || 'Failed to delete.'); }
                 } catch (error) {
                     console.error("DEBUG: Error deleting tournament:", error);
                     if (typeof showToast === 'function') showToast(`Error: ${error.message}`, 'error');
                     confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Ya, Hapus';
                 }
             });
        } else { console.warn("DEBUG: Confirm delete button not found for listener."); }
        console.log("DEBUG: Delete modal listeners attached."); 

        if (participantList) {
            participantList.addEventListener('click', function(e) {
                const removeButton = e.target.closest('.open-remove-team-modal-btn');
                if (removeButton) {
                    e.stopPropagation(); 
                    
                    const teamId = removeButton.dataset.teamId;
                    const teamName = removeButton.dataset.teamName;

                    if (teamId && teamName) {
                        console.log("DEBUG: Delegated click caught for team:", teamId, teamName);
                        openRemoveTeamModal(teamId, teamName);
                    } else {
                        console.error("DEBUG: Delegated click caught, but teamId/teamName missing.");
                    }
                }
            });
        }
        fetchTournamentDetails();
    });
</script>
{% endtimezone %}
{% endblock main_content %}