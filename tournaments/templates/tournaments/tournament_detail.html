{% extends 'layout_navbar.html' %}
{% load static %}
{% load tz %}

{# Menerima 'tournament_id' dari context view 'tournament_detail_page' #}
{% block body_attributes %}data-tournament-id="{{ tournament_id }}"{% endblock body_attributes %}

{% block page_title %}Detail Turnamen{% endblock page_title %}

{% block main_content %}
{% timezone "Asia/Jakarta" %} 
<div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">

    {# Link Kembali & Tombol Manajemen #}
    <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
        <a href="{% url 'tournaments:tournament_home' %}" class="inline-flex items-center text-sm text-custom-blue-300 hover:text-custom-blue-400 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Kembali ke Daftar Turnamen
        </a>
        <div id="management-buttons" class="flex gap-2">
            {# Tombol Edit/Delete akan diinjeksi oleh JS #}
        </div>
    </div>

    {# Indikator Loading #}
    <div id="loading-indicator" class="text-center p-10 text-custom-blue-300">
        <svg class="animate-spin h-8 w-8 text-custom-blue-300 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2">Memuat detail turnamen...</p>
    </div>

    {# Placeholder Pesan Error #}
    <div id="error-message" class="hidden text-center p-6 bg-red-50 text-red-700 rounded-lg shadow">
        Gagal memuat detail turnamen.
    </div>

    {# --- Konten Placeholder (Awalnya tersembunyi) --- #}
    <div id="tournament-content" class="hidden">
        <div id="tournament-banner-container" class="mb-6"></div>
        <h1 id="tournament-name" class="text-3xl md:text-4xl font-bold text-custom-blue-400 mb-2 break-words"></h1>
        <div class="flex flex-wrap items-center text-sm text-custom-blue-300 mb-4 space-x-4">
            <span><strong>Penyelenggara:</strong> <a id="organizer-link" href="#" class="hover:underline"></a></span>
            <span>|</span>
            <span><strong>Tanggal:</strong> <span id="tournament-dates"></span></span>
        </div>
        <p id="tournament-description" class="text-gray-700 mb-6 whitespace-pre-wrap break-words"></p>
        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Jadwal Pertandingan</h2>
        <div id="match-list" class="space-y-4">
            <p id="no-matches-message" class="hidden text-gray-500">Belum ada jadwal pertandingan.</p>
        </div>
         <hr class="my-6 border-gray-200">
         <div class="flex flex-col sm:flex-row gap-4 mt-6">
             <a id="forum-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">Diskusi Forum</a>
             <a id="predictions-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">Lihat Prediksi</a>
         </div>
    </div> {# --- End #tournament-content --- #}
</div>

{# --- MODAL EDIT TURNAMEN --- #}
<div id="edit-tournament-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-custom-blue-400">Edit Turnamen</h2>
            <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto">
            <form id="edit-tournament-form" method="POST" class="space-y-4">
                {% csrf_token %}
                {{ edit_form.as_p }}
                
                 <div id="error-edit-non_field_errors" class="text-red-500 text-sm mt-1 font-medium"></div>
                 
                 <div class="pt-4 mt-6 border-t border-gray-200">
                    <button type="submit" id="edit-submit-btn" class="w-full bg-custom-blue-400 text-white font-bold py-2.5 px-4 rounded-lg
                               hover:bg-custom-blue-300 focus:outline-none focus:ring-2
                               focus:ring-offset-2 focus:ring-custom-blue-300 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-wait">
                        Simpan Perubahan
                    </button>
                 </div>
            </form>
        </div>
    </div>
</div>
{# --- End Modal Edit --- #}


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tournamentId = document.body.dataset.tournamentId;
        if (!tournamentId) {
            // ... (error handling jika ID tidak ada) ...
            console.error("Tournament ID not found on body tag.");
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
            if (errorMessage) {
                errorMessage.textContent = 'Error: ID Turnamen tidak ditemukan. Halaman tidak dapat dimuat.';
                errorMessage.classList.remove('hidden');
            }
            return;
        }

        let currentTournamentData = null;

        // --- Elemen Halaman ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const contentDiv = document.getElementById('tournament-content');
        const managementButtonsDiv = document.getElementById('management-buttons');
        const bannerContainer = document.getElementById('tournament-banner-container');
        const nameEl = document.getElementById('tournament-name');
        const organizerLink = document.getElementById('organizer-link');
        const datesEl = document.getElementById('tournament-dates');
        const descriptionEl = document.getElementById('tournament-description');
        const matchList = document.getElementById('match-list');
        const noMatchesMessage = document.getElementById('no-matches-message');
        const forumLink = document.getElementById('forum-link');
        const predictionsLink = document.getElementById('predictions-link');
        
        const defaultBannerSvg = `
            <div class="w-full h-48 md:h-64 bg-custom-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-16 h-16 text-custom-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10m0-2.657A8 8 0 0121.657 15S21 13 19 12m0 6.657a8 8 0 01-11.314-11.314m1.414 1.414A6 6 0 0119 12m-2 2a6 6 0 01-5.586 5.586"></path></svg>
            </div>`;

        // --- Elemen Modal Edit ---
        const editModal = document.getElementById('edit-tournament-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editForm = document.getElementById('edit-tournament-form');
        const editSubmitBtn = document.getElementById('edit-submit-btn');

        // --- Fungsi Helper untuk Styling Form ---
        function styleModalForm(formEl) {
             if (!formEl) return;
             
             // Hapus <p> wrapper dari Django
             formEl.querySelectorAll('p').forEach(p => {
                // Hati-hati agar tidak menghapus div error
                if (!p.querySelector('div[id^="error-"]')) {
                    p.replaceWith(...p.childNodes);
                }
             });
             
             formEl.querySelectorAll('label').forEach(label => {
                label.classList.add('block', 'text-sm', 'font-semibold', 'text-gray-700', 'mb-1');
             });

             // Tambahkan styling ke input
             formEl.querySelectorAll('input[type="text"], input[type="date"], input[type="url"], textarea').forEach(el => {
                el.classList.add(
                    'block', 'w-full', 'px-3', 'py-2', 'mt-1',
                    'border', 'border-gray-300', 'rounded-md', 'shadow-sm',
                    'placeholder-gray-400', 'text-gray-900',
                    'focus:outline-none', 'focus:ring-2', 'focus:ring-custom-blue-300', 'focus:border-custom-blue-300',
                    'transition', 'duration-150', 'ease-in-out'
                );
             });
             
             formEl.querySelectorAll('.helptext').forEach(el => el.classList.add('hidden'));

             // Siapkan div error
             formEl.querySelectorAll('input, textarea').forEach(el => {
                const fieldName = el.name;
                let errorDiv = document.getElementById(`error-edit-${fieldName}`);
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = `error-edit-${fieldName}`;
                    errorDiv.className = 'text-red-500 text-sm mt-1 font-medium';
                    // Sisipkan setelah elemen input/textarea
                    el.parentNode.insertBefore(errorDiv, el.nextSibling);
                }
             });
        }
        
        // --- Fungsi untuk Mengisi Halaman dengan Data ---
        function populatePage(data) {
            currentTournamentData = data; 
            
            // Terapkan styling ke form modal edit (saat pertama kali data dimuat)
            styleModalForm(editForm);

            // Banner
            if (data.banner_url) {
                 bannerContainer.innerHTML = `<img src="${data.banner_url}" alt="Banner ${data.name}" class="w-full h-48 md:h-64 object-cover rounded-lg" onerror="this.parentElement.innerHTML = defaultBannerSvg">`;
            } else {
                 bannerContainer.innerHTML = defaultBannerSvg;
            }
            // Info Dasar
            nameEl.textContent = data.name;
            organizerLink.textContent = data.organizer_username;
            organizerLink.href = data.organizer_profile_url;
            datesEl.textContent = `${data.start_date_formatted} - ${data.end_date_formatted}`;
            descriptionEl.innerHTML = data.description ? data.description.replace(/\n/g, '<br>') : 'Tidak ada deskripsi.';
            // Daftar Pertandingan
            matchList.innerHTML = ''; 
            if (data.matches && data.matches.length > 0) {
                noMatchesMessage.classList.add('hidden');
                data.matches.forEach(match => {
                    // Cek jika match_date adalah string, jika ya, parse dulu (walau view harusnya sudah format)
                    let matchDateFormatted = match.match_date_formatted;
                    if (!matchDateFormatted && match.match_date) {
                         // Fallback jika view 'edit_tournament' tidak memformat tanggal
                         try {
                            matchDateFormatted = new Date(match.match_date).toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
                         } catch(e) {
                            matchDateFormatted = match.match_date; // Tampilkan string mentah
                         }
                    }

                    const scoreDisplay = (match.home_score !== null && match.away_score !== null)
                        ? `<span class="font-bold">${match.home_score} - ${match.away_score}</span>`
                        : `<span class="text-sm font-normal text-custom-blue-200">Belum Dimulai</span>`;
                    
                    const matchHtml = `
                    <div class="p-4 border border-custom-blue-100 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-custom-blue-50/30">
                        <div class="flex-1 mb-2 sm:mb-0">
                            <span class="font-semibold text-custom-blue-400">${match.home_team__name || match.home_team_name}</span> <span class="text-gray-500"> vs </span> <span class="font-semibold text-custom-blue-400">${match.away_team__name || match.away_team_name}</span>
                            <p class="text-xs text-custom-blue-300 mt-1">${matchDateFormatted}</p>
                        </div>
                        <div class="text-lg text-custom-blue-400">${scoreDisplay}</div>
                    </div>`;
                    matchList.insertAdjacentHTML('beforeend', matchHtml);
                });
            } else {
                noMatchesMessage.classList.remove('hidden');
            }
            // Tautan
            forumLink.href = data.forum_url;
            predictionsLink.href = data.predictions_url;
            
            // Tombol Manajemen (Edit/Delete)
            managementButtonsDiv.innerHTML = ''; 
            if (data.is_organizer_or_admin) {
                const editButtonHtml = `
                    <button id="open-edit-modal-btn" class="bg-custom-blue-300 text-white font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-400 transition-colors text-sm">
                        Edit Turnamen
                    </button>`;
                managementButtonsDiv.insertAdjacentHTML('beforeend', editButtonHtml);
                
                // Tambahkan event listener ke tombol yang BARU dibuat
                document.getElementById('open-edit-modal-btn').addEventListener('click', openEditModal);
            }
            contentDiv.classList.remove('hidden');
        }

        // --- Fungsi Fetch Utama ---
        async function fetchTournamentDetails() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            contentDiv.classList.add('hidden');
            try {
                const response = await fetch(`/tournaments/json/${tournamentId}/`); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                populatePage(data);

            } catch (error) {
                console.error("Error fetching tournament details:", error);
                errorMessage.classList.remove('hidden');
                if (typeof showToast === 'function') showToast('Gagal memuat detail turnamen.', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- Logika Modal Edit ---
        function openEditModal() {
            if (!editModal || !currentTournamentData) return;
            
            // --- Pre-fill form (menggunakan ID default Django: id_namafield) ---
            document.getElementById('id_name').value = currentTournamentData.name || '';
            document.getElementById('id_description').value = currentTournamentData.description || '';
            document.getElementById('id_banner').value = currentTournamentData.banner_url || '';
            document.getElementById('id_start_date').value = currentTournamentData.start_date_raw || '';
            document.getElementById('id_end_date').value = currentTournamentData.end_date_raw || '';
            
            editModal.classList.remove('hidden');
            setTimeout(() => {
                editModal.classList.remove('opacity-0');
                editModal.querySelector('.transform').classList.remove('scale-95');
            }, 10);
        }
        
        function closeEditModal() {
            if (!editModal) return;
            editModal.classList.add('opacity-0');
            editModal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                editModal.classList.add('hidden');
                 // Bersihkan error
                 editForm.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
                 editForm.querySelectorAll('.border-red-500').forEach(el => {
                     el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                     el.classList.add('border-gray-300', 'focus:border-custom-blue-300', 'focus:ring-custom-blue-300');
                 });
            }, 300);
        }

        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
        if (editModal) editModal.addEventListener('click', (event) => { if (event.target === editModal) closeEditModal(); });

        // --- Handle Edit Form Submit ---
        if (editForm) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                editSubmitBtn.disabled = true;
                editSubmitBtn.textContent = 'Menyimpan...';

                // Bersihkan error sebelumnya
                editForm.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
                editForm.querySelectorAll('.border-red-500').forEach(el => {
                    el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    el.classList.add('border-gray-300', 'focus:border-custom-blue-300', 'focus:ring-custom-blue-300');
                });

                const formData = new FormData(editForm);
                const csrfToken = formData.get('csrfmiddlewaretoken');

                try {
                    const response = await fetch(`/tournaments/edit/${tournamentId}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                        body: formData
                    });
                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        closeEditModal();
                        if (typeof showToast === 'function') showToast(data.message, 'success');
                        
                        // Update halaman secara dinamis dengan data baru dari respons
                        populatePage(data.tournament); 
                        
                    } else {
                         let generalErrorMessage = data.message || 'Terjadi kesalahan validasi.';
                         if (data.errors) {
                             Object.keys(data.errors).forEach(fieldName => {
                                 // Target div error kustom yang kita buat
                                 // ID Field Django adalah 'id_namafield'
                                 const errorDiv = document.getElementById(`error-edit-${fieldName === '__all__' ? 'non_field_errors' : fieldName}`);
                                 const fieldEl = document.getElementById(`id_${fieldName}`);
                                 
                                 if (errorDiv && data.errors[fieldName].length > 0) {
                                     errorDiv.textContent = data.errors[fieldName][0].message;
                                 }
                                 if (fieldEl) {
                                     fieldEl.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                                     fieldEl.classList.remove('border-gray-300', 'focus:border-custom-blue-300', 'focus:ring-custom-blue-300');
                                 }
                                 if (fieldName === '__all__') {
                                     generalErrorMessage = data.errors[fieldName][0].message;
                                 }
                             });
                         }
                         if (typeof showToast === 'function') showToast(generalErrorMessage, 'error');
                    }
                } catch (error) {
                    console.error('Error submitting edit form:', error);
                    if (typeof showToast === 'function') showToast('Gagal terhubung ke server.', 'error');
                } finally {
                    editSubmitBtn.disabled = false;
                    editSubmitBtn.textContent = 'Simpan Perubahan';
                }
            });
        }

        // --- Panggil Fetch Awal ---
        fetchTournamentDetails();
    });
</script>
{% endtimezone %} 
{% endblock main_content %}

