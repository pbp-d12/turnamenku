{% extends 'layout_navbar.html' %}
{% load static %}
{% load tz %}

{# Menerima 'tournament_id' dari context view 'tournament_detail_page' #}
{% block body_attributes %}data-tournament-id="{{ tournament_id }}"{% endblock body_attributes %}

{% block page_title %}Detail Turnamen{% endblock page_title %}

{% block main_content %}
{% timezone "Asia/Jakarta" %}
<div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">

    {# Link Kembali & Tombol Manajemen #}
    <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
        <a href="{% url 'tournaments:tournament_home' %}" class="inline-flex items-center text-sm text-custom-blue-300 hover:text-custom-blue-400 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Kembali ke Daftar Turnamen
        </a>
        <div id="management-buttons" class="flex gap-2">
            {# Tombol Edit/Delete akan diinjeksi oleh JS #}
        </div>
    </div>

    {# Indikator Loading #}
    <div id="loading-indicator" class="text-center p-10 text-custom-blue-300">
        <svg class="animate-spin h-8 w-8 text-custom-blue-300 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2">Memuat detail turnamen...</p>
    </div>

    {# Placeholder Pesan Error #}
    <div id="error-message" class="hidden text-center p-6 bg-red-50 text-red-700 rounded-lg shadow">
        Gagal memuat detail turnamen.
    </div>

    {# --- Konten Placeholder (Awalnya tersembunyi) --- #}
    <div id="tournament-content" class="hidden">
        <div id="tournament-banner-container" class="mb-6"></div>
        <h1 id="tournament-name" class="text-3xl md:text-4xl font-bold text-custom-blue-400 mb-2 break-words"></h1>
        <div class="flex flex-wrap items-center text-sm text-custom-blue-300 mb-4 space-x-4">
            <span><strong>Penyelenggara:</strong> <a id="organizer-link" href="#" class="hover:underline"></a></span>
            <span>|</span>
            <span><strong>Tanggal:</strong> <span id="tournament-dates"></span></span>
        </div>
        <p id="tournament-description" class="text-gray-700 mb-6 whitespace-pre-wrap break-words"></p>

        {# --- ADDED: Participants Section --- #}
        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Tim Peserta</h2>
        <div id="participant-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
            <p id="no-participants-message" class="hidden text-gray-500 italic col-span-full">Belum ada tim peserta.</p>
             {# Participant cards will be inserted here by JS #}
        </div>
        {# ----------------------------------- #}

        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Jadwal Pertandingan</h2>
        <div id="match-list" class="space-y-4">
            <p id="no-matches-message" class="hidden text-gray-500">Belum ada jadwal pertandingan.</p>
        </div>
         <hr class="my-6 border-gray-200">
         <div class="flex flex-col sm:flex-row gap-4 mt-6">
             <a id="forum-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">Diskusi Forum</a>
             <a id="predictions-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">Lihat Prediksi</a>
         </div>
    </div> {# --- End #tournament-content --- #}
</div>

{# --- MODAL EDIT TURNAMEN --- #}
<div id="edit-tournament-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-custom-blue-400">Edit Turnamen</h2>
            <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto">
            <form id="edit-tournament-form" method="POST" class="space-y-4">
                {% csrf_token %}
                {# Fields akan di-prefill oleh JS, pastikan ID-nya benar #}
                <div>
                    <label for="id_name" class="block text-sm font-semibold text-gray-700 mb-1">Nama Turnamen <span class="text-red-500">*</span></label>
                    <input type="text" name="name" id="id_name" maxlength="255" required placeholder="Nama Turnamen">
                    <div id="error-edit-name" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                <div>
                    <label for="id_description" class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi</label>
                    <textarea name="description" id="id_description" rows="3" placeholder="Deskripsi singkat turnamen..."></textarea>
                    <div id="error-edit-description" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                 <div>
                    <label for="id_banner" class="block text-sm font-semibold text-gray-700 mb-1">URL Banner (Opsional)</label>
                    <input type="url" name="banner" id="id_banner" maxlength="500" placeholder="https://example.com/banner.jpg">
                    <div id="error-edit-banner" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                <div>
                    <label for="id_start_date" class="block text-sm font-semibold text-gray-700 mb-1">Tanggal Mulai <span class="text-red-500">*</span></label>
                    <input type="date" name="start_date" id="id_start_date" required>
                    <div id="error-edit-start_date" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>
                <div>
                    <label for="id_end_date" class="block text-sm font-semibold text-gray-700 mb-1">Tanggal Selesai <span class="text-red-500">*</span></label>
                    <input type="date" name="end_date" id="id_end_date" required>
                    <div id="error-edit-end_date" class="text-red-500 text-sm mt-1 font-medium"></div>
                </div>

                 {# --- ADDED: Placeholder for participants (future enhancement) --- #}
                 {# <div class="hidden"> #}
                 {#    <label for="id_participants" class="block text-sm font-semibold text-gray-700 mb-1">Peserta</label> #}
                 {#    <select multiple name="participants" id="id_participants"> #}
                 {#        Options filled dynamically or use a widget #}
                 {#    </select> #}
                 {#    <div id="error-edit-participants" class="text-red-500 text-sm mt-1 font-medium"></div> #}
                 {# </div> #}
                 {# ---------------------------------------------------------------- #}


                 <div id="error-edit-non_field_errors" class="text-red-500 text-sm mt-1 font-medium"></div>

                 <div class="pt-4 mt-6 border-t border-gray-200">
                    <button type="submit" id="edit-submit-btn" class="w-full bg-custom-blue-400 text-white font-bold py-2.5 px-4 rounded-lg
                               hover:bg-custom-blue-300 focus:outline-none focus:ring-2
                               focus:ring-offset-2 focus:ring-custom-blue-300 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-wait">
                        Simpan Perubahan
                    </button>
                 </div>
            </form>
        </div>
    </div>
</div>
{# --- End Modal Edit --- #}

{# --- MODAL KONFIRMASI HAPUS --- #}
<div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform scale-95 transition-all duration-300">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
            <h2 class="text-xl font-bold text-red-600">Konfirmasi Penghapusan</h2>
            <button id="close-delete-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div class="p-6">
            <p id="delete-confirm-message" class="text-gray-700 mb-6">Apakah Anda yakin ingin menghapus turnamen ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    Batal
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-wait">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>
{# --- End Modal Konfirmasi Hapus --- #}


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tournamentId = document.body.dataset.tournamentId;
        if (!tournamentId) {
            console.error("Tournament ID not found in body dataset!");
            // Display an error message to the user maybe
            return;
        }

        let currentTournamentData = null;

        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const contentDiv = document.getElementById('tournament-content');
        const managementButtonsDiv = document.getElementById('management-buttons');
        const bannerContainer = document.getElementById('tournament-banner-container');
        const nameEl = document.getElementById('tournament-name');
        const organizerLink = document.getElementById('organizer-link');
        const datesEl = document.getElementById('tournament-dates');
        const descriptionEl = document.getElementById('tournament-description');
        const matchList = document.getElementById('match-list');
        const noMatchesMessage = document.getElementById('no-matches-message');
        const forumLink = document.getElementById('forum-link');
        const predictionsLink = document.getElementById('predictions-link');
        const participantList = document.getElementById('participant-list');
        const noParticipantsMessage = document.getElementById('no-participants-message');
        // ------------------------------------

        const defaultBannerSvg = `
            <div class="w-full h-48 md:h-64 bg-custom-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-16 h-16 text-custom-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10m0-2.657A8 8 0 0121.657 15S21 13 19 12m0 6.657a8 8 0 01-11.314-11.314m1.414 1.414A6 6 0 0119 12m-2 2a6 6 0 01-5.586 5.586"></path></svg>
            </div>`;

        const defaultTeamLogoSvg = `<svg class="w-full h-full text-custom-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>`;

        // --- Elemen Modal Edit ---
        const editModal = document.getElementById('edit-tournament-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editForm = document.getElementById('edit-tournament-form');
        const editSubmitBtn = document.getElementById('edit-submit-btn');

        // --- Elemen Modal Hapus ---
        const deleteModal = document.getElementById('delete-confirm-modal');
        const closeDeleteModalBtn = document.getElementById('close-delete-modal-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');


        function styleModalForm(formEl) {
             if (!formEl) return;
             // Clear existing potentially problematic paragraph tags around fields first
             formEl.querySelectorAll('p').forEach(p => {
                 const containsLabel = p.querySelector('label');
                 const containsInput = p.querySelector('input, textarea, select');
                 const containsError = p.querySelector('div[id^="error-"]');
                 if ((containsLabel || containsInput) && !containsError && p.children.length <= 2) {
                     p.replaceWith(...p.childNodes); // Replace <p> with its children
                 }
             });
             formEl.querySelectorAll('label').forEach(label => {
                label.classList.add('block', 'text-sm', 'font-semibold', 'text-gray-700', 'mb-1');
             });
             formEl.querySelectorAll('input[type="text"], input[type="date"], input[type="url"], textarea').forEach(el => {
                el.classList.add(
                    'block', 'w-full', 'px-3', 'py-2', 'mt-1', 'border', 'border-gray-300', 'rounded-md', 'shadow-sm',
                    'placeholder-gray-400', 'text-gray-900',
                    'focus:outline-none', 'focus:ring-2', 'focus:ring-custom-blue-300', 'focus:border-custom-blue-300',
                    'transition', 'duration-150', 'ease-in-out'
                );
             });
             // Hide default help text if needed
             formEl.querySelectorAll('.helptext').forEach(el => el.classList.add('hidden'));

             // Ensure error divs exist
             formEl.querySelectorAll('input, textarea').forEach(el => {
                const fieldName = el.name;
                let errorDiv = document.getElementById(`error-edit-${fieldName}`);
                if (!errorDiv && fieldName) { // Check if fieldName is not empty
                    errorDiv = document.createElement('div');
                    errorDiv.id = `error-edit-${fieldName}`;
                    errorDiv.className = 'text-red-500 text-sm mt-1 font-medium';
                    // Insert after the input/textarea itself
                    el.parentNode.insertBefore(errorDiv, el.nextSibling);
                }
             });
        }

        // --- Fungsi untuk Mengisi Halaman dengan Data ---
        function populatePage(data) {
            currentTournamentData = data;
            styleModalForm(editForm);

            // Populate Banner
            if (data.banner_url) {
                 bannerContainer.innerHTML = `<img src="${data.banner_url}" alt="Banner ${data.name}" class="w-full h-48 md:h-64 object-cover rounded-lg" onerror="this.parentElement.innerHTML = defaultBannerSvg;">`;
            } else {
                 bannerContainer.innerHTML = defaultBannerSvg;
            }

            // Populate Basic Info
            nameEl.textContent = data.name;
            organizerLink.textContent = data.organizer_username;
            organizerLink.href = data.organizer_profile_url;
            datesEl.textContent = `${data.start_date_formatted} - ${data.end_date_formatted}`;
            descriptionEl.innerHTML = data.description ? data.description.replace(/\n/g, '<br>') : 'Tidak ada deskripsi.';

            // --- ADDED: Populate Participants ---
            participantList.innerHTML = ''; // Clear previous participants
            if (data.participants && data.participants.length > 0) {
                noParticipantsMessage.classList.add('hidden');
                data.participants.forEach(team => {
                    const logoHtml = team.logo_url
                        ? `<img src="${team.logo_url}" alt="Logo ${team.name}" class="w-full h-16 object-contain" onerror="this.parentElement.innerHTML = defaultTeamLogoSvg;">`
                        : `<div class="w-full h-16 flex items-center justify-center bg-gray-100 rounded-t-lg">${defaultTeamLogoSvg}</div>`;

                    const participantHtml = `
                    <div class="border border-gray-200 rounded-lg shadow-sm overflow-hidden flex flex-col items-center text-center">
                        <div class="w-full p-2 flex items-center justify-center h-20"> ${logoHtml}</div>
                        <p class="text-xs font-medium text-gray-700 p-2 truncate w-full bg-gray-50">${team.name}</p>
                    </div>`;
                    participantList.insertAdjacentHTML('beforeend', participantHtml);
                });
            } else {
                noParticipantsMessage.classList.remove('hidden');
            }
            // ------------------------------------

            // Populate Matches
            matchList.innerHTML = ''; // Clear previous matches
            if (data.matches && data.matches.length > 0) {
                noMatchesMessage.classList.add('hidden');
                data.matches.forEach(match => {
                    // Use match_date_formatted if available, otherwise format from match_date
                    let matchDateFormatted = match.match_date_formatted;
                    if (!matchDateFormatted && match.match_date) {
                         try { // Add try-catch for safety
                            // Ensure match.match_date is treated as UTC if it doesn't have timezone info
                            let matchDateObj = new Date(match.match_date.endsWith('Z') ? match.match_date : match.match_date + 'Z');
                            matchDateFormatted = matchDateObj.toLocaleString('id-ID', {
                                day: '2-digit', month: 'short', year: 'numeric',
                                hour: '2-digit', minute: '2-digit', timeZoneName: 'short'
                             });
                         } catch(e) {
                             console.error("Error formatting match date:", match.match_date, e);
                             matchDateFormatted = match.match_date; // Fallback
                         }
                    } else if (!matchDateFormatted) {
                        matchDateFormatted = 'Waktu tidak tersedia';
                    }

                    const homeTeamName = match.home_team__name || match.home_team_name || 'N/A';
                    const awayTeamName = match.away_team__name || match.away_team_name || 'N/A';

                    const scoreDisplay = (match.home_score !== null && match.away_score !== null)
                        ? `<span class="font-bold">${match.home_score} - ${match.away_score}</span>`
                        : `<span class="text-sm font-normal text-custom-blue-200">Belum Dimulai</span>`;

                    const matchHtml = `
                    <div class="p-4 border border-custom-blue-100 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-custom-blue-50/30">
                        <div class="flex-1 mb-2 sm:mb-0 text-center sm:text-left">
                            <span class="font-semibold text-custom-blue-400">${homeTeamName}</span>
                            <span class="text-gray-500 mx-1">vs</span>
                            <span class="font-semibold text-custom-blue-400">${awayTeamName}</span>
                            <p class="text-xs text-custom-blue-300 mt-1">${matchDateFormatted}</p>
                        </div>
                        <div class="text-lg text-custom-blue-400">${scoreDisplay}</div>
                    </div>`;
                    matchList.insertAdjacentHTML('beforeend', matchHtml);
                });
            } else {
                noMatchesMessage.classList.remove('hidden');
            }

            // Populate Links
            forumLink.href = data.forum_url;
            predictionsLink.href = data.predictions_url;

            // Populate Management Buttons
            managementButtonsDiv.innerHTML = ''; // Clear previous buttons
            if (data.is_organizer_or_admin) {
                const editButtonHtml = `<button id="open-edit-modal-btn" class="bg-custom-blue-300 text-white font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-400 transition-colors text-sm">Edit Turnamen</button>`;
                managementButtonsDiv.insertAdjacentHTML('beforeend', editButtonHtml);
                const editBtn = document.getElementById('open-edit-modal-btn');
                if (editBtn) editBtn.addEventListener('click', openEditModal);

                const deleteButtonHtml = `<button id="open-delete-modal-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">Hapus Turnamen</button>`;
                managementButtonsDiv.insertAdjacentHTML('beforeend', deleteButtonHtml);
                const openDeleteBtn = document.getElementById('open-delete-modal-btn');
                if (openDeleteBtn) openDeleteBtn.addEventListener('click', openDeleteModal);
            }

            contentDiv.classList.remove('hidden'); // Show content
        }

        async function fetchTournamentDetails() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            contentDiv.classList.add('hidden');
            try {
                const response = await fetch(`/tournaments/json/${tournamentId}/`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('Turnamen tidak ditemukan.');
                    throw new Error(`Gagal memuat data (Status: ${response.status})`);
                }
                const data = await response.json();
                if (data.error) throw new Error(data.error); // Handle errors returned in JSON
                populatePage(data);
            } catch (error) {
                console.error("Error fetching tournament details:", error);
                errorMessage.textContent = `Gagal memuat detail: ${error.message}`;
                errorMessage.classList.remove('hidden');
                if (typeof showToast === 'function') showToast(`Gagal memuat detail: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- Logika Modal Edit ---
        function openEditModal() {
            if (!editModal || !currentTournamentData) return;
            // Pre-fill form
            document.getElementById('id_name').value = currentTournamentData.name || '';
            document.getElementById('id_description').value = currentTournamentData.description || '';
            document.getElementById('id_banner').value = currentTournamentData.banner_url || '';
            document.getElementById('id_start_date').value = currentTournamentData.start_date_raw || '';
            document.getElementById('id_end_date').value = currentTournamentData.end_date_raw || '';

            editModal.classList.remove('hidden');
            setTimeout(() => {
                editModal.classList.remove('opacity-0');
                editModal.querySelector('.transform').classList.remove('scale-95');
            }, 10);
        }

        function closeEditModal() {
            if (!editModal) return;
            editModal.classList.add('opacity-0');
            editModal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                editModal.classList.add('hidden');
                 editForm.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
                 editForm.querySelectorAll('.border-red-500').forEach(el => {
                     el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                     el.classList.add('border-gray-300', 'focus:border-custom-blue-300', 'focus:ring-custom-blue-300');
                 });
            }, 300);
        }

        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
        if (editModal) editModal.addEventListener('click', (event) => { if (event.target === editModal) closeEditModal(); });

        if (editForm) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                editSubmitBtn.disabled = true;
                editSubmitBtn.textContent = 'Menyimpan...';

                editForm.querySelectorAll('[id^="error-edit-"]').forEach(el => el.textContent = '');
                editForm.querySelectorAll('.border-red-500').forEach(el => {
                     el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                     el.classList.add('border-gray-300', 'focus:border-custom-blue-300', 'focus:ring-custom-blue-300');
                });

                const formData = new FormData(editForm);
                const csrfToken = formData.get('csrfmiddlewaretoken');

                try {
                    const response = await fetch(`/tournaments/edit/${tournamentId}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        closeEditModal();
                        if (typeof showToast === 'function') showToast(data.message, 'success');
                        populatePage(data.tournament); // Update page content
                    } else {
                         let generalErrorMessage = data.message || 'Terjadi kesalahan validasi.';
                         if (data.errors) {
                             Object.keys(data.errors).forEach(fieldName => {
                                 const errorDivId = `error-edit-${fieldName === '__all__' ? 'non_field_errors' : fieldName}`;
                                 const errorDiv = document.getElementById(errorDivId);
                                 const fieldElId = `id_${fieldName}`;
                                 const fieldEl = document.getElementById(fieldElId);

                                 if (errorDiv && data.errors[fieldName].length > 0) {
                                     errorDiv.textContent = data.errors[fieldName][0].message; // Display first message
                                 }
                                 if (fieldEl) {
                                     fieldEl.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                                     fieldEl.classList.remove('border-gray-300', 'focus:border-custom-blue-300', 'focus:ring-custom-blue-300');
                                 }
                                 if (fieldName === '__all__' && errorDiv) { // Ensure non_field_errors div exists
                                     generalErrorMessage = data.errors[fieldName][0].message;
                                 } else if (fieldName === '__all__') {
                                     // Fallback if the specific non_field_errors div is missing
                                     generalErrorMessage = data.errors[fieldName][0].message;
                                 }
                             });
                         }
                         if (typeof showToast === 'function') showToast(generalErrorMessage, 'error');
                    }
                } catch (error) {
                    console.error('Error submitting edit form:', error);
                    if (typeof showToast === 'function') showToast('Gagal terhubung ke server.', 'error');
                }
                finally {
                    editSubmitBtn.disabled = false;
                    editSubmitBtn.textContent = 'Simpan Perubahan';
                }
            });
        }

        // --- Logika Modal Hapus ---
        function openDeleteModal() {
            if (!deleteModal || !currentTournamentData) return;
            const tournamentName = currentTournamentData.name || "turnamen ini";
            deleteConfirmMessage.textContent = `Apakah Anda yakin ingin menghapus turnamen "${tournamentName}"? Tindakan ini tidak dapat dibatalkan.`;
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = 'Ya, Hapus';
            confirmDeleteBtn.classList.remove('opacity-50', 'cursor-wait');

            deleteModal.classList.remove('hidden');
            setTimeout(() => {
                deleteModal.classList.remove('opacity-0');
                deleteModal.querySelector('.transform').classList.remove('scale-95');
            }, 10);
        }
        function closeDeleteModal() {
            if (!deleteModal) return;
            deleteModal.classList.add('opacity-0');
            deleteModal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
            }, 300);
        }
        if (closeDeleteModalBtn) closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        if (deleteModal) deleteModal.addEventListener('click', (event) => { if (event.target === deleteModal) closeDeleteModal(); });
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', async () => {
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = 'Menghapus...';
                confirmDeleteBtn.classList.add('opacity-50', 'cursor-wait');
                const csrfTokenInput = document.querySelector('#edit-tournament-form [name=csrfmiddlewaretoken]');
                if (!csrfTokenInput) {
                     console.error("CSRF token not found!");
                     if (typeof showToast === 'function') showToast('Kesalahan: Token keamanan tidak ditemukan.', 'error');
                     confirmDeleteBtn.disabled = false;
                     confirmDeleteBtn.textContent = 'Ya, Hapus';
                     confirmDeleteBtn.classList.remove('opacity-50', 'cursor-wait');
                     return;
                }
                const csrfToken = csrfTokenInput.value;
                try {
                    const response = await fetch(`/tournaments/delete/${tournamentId}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        closeDeleteModal();
                        if (typeof showToast === 'function') showToast(data.message, 'success');
                        setTimeout(() => { window.location.href = data.redirect_url; }, 1500);
                    } else {
                        throw new Error(data.message || 'Gagal menghapus turnamen.');
                    }
                } catch (error) {
                    console.error("Error deleting tournament:", error);
                    if (typeof showToast === 'function') showToast(error.message || 'Terjadi kesalahan jaringan saat menghapus.', 'error');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'Ya, Hapus';
                    confirmDeleteBtn.classList.remove('opacity-50', 'cursor-wait');
                }
            });
        }

        fetchTournamentDetails();
    });
</script>
{% endtimezone %}
{% endblock main_content %}