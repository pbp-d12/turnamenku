{% extends 'layout_navbar.html' %}
{% load static %}
{% load tz %}

{# Menerima 'tournament_id' dari context view 'tournament_detail_page' #}
{% block body_attributes %}data-tournament-id="{{ tournament_id }}"{% endblock body_attributes %}

{% block page_title %}Detail Turnamen{% endblock page_title %}

{% block main_content %}
{% timezone "Asia/Jakarta" %}
<div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">

    {# Link Kembali #}
    <div class="mb-4">
        <a href="{% url 'tournaments:tournament_home' %}" class="inline-flex items-center text-sm text-custom-blue-300 hover:text-custom-blue-400 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Kembali ke Daftar Turnamen
        </a>
    </div>

    {# Indikator Loading #}
    <div id="loading-indicator" class="text-center p-10 text-custom-blue-300">
        <svg class="animate-spin h-8 w-8 text-custom-blue-300 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2">Memuat detail turnamen...</p>
    </div>

    {# Placeholder Pesan Error #}
    <div id="error-message" class="hidden text-center p-6 bg-red-50 text-red-700 rounded-lg shadow">
        Gagal memuat detail turnamen.
    </div>

    {# --- Konten Placeholder (Awalnya tersembunyi) --- #}
    <div id="tournament-content" class="hidden">
        {# Placeholder Banner Turnamen #}
        <div id="tournament-banner-container" class="mb-6">
             {# Banner <img> atau <div> placeholder akan diinjeksi di sini oleh JS #}
        </div>

        {# Info Placeholder Turnamen #}
        <h1 id="tournament-name" class="text-3xl md:text-4xl font-bold text-custom-blue-400 mb-2"></h1>
        <div class="flex flex-wrap items-center text-sm text-custom-blue-300 mb-4 space-x-4">
            <span>
                <strong>Penyelenggara:</strong>
                <a id="organizer-link" href="#" class="hover:underline"></a>
            </span>
            <span>|</span>
            <span><strong>Tanggal:</strong> <span id="tournament-dates"></span></span>
        </div>

        {# Placeholder Deskripsi #}
        <p id="tournament-description" class="text-gray-700 mb-6"></p>

        {# Bagian Pertandingan #}
        <hr class="my-6 border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Jadwal Pertandingan</h2>
        <div id="match-list" class="space-y-4">
            {# Item pertandingan akan diinjeksi di sini oleh JS #}
            <p id="no-matches-message" class="hidden text-gray-500">Belum ada jadwal pertandingan.</p>
        </div>

        {# Tautan ke App Lain #}
         <hr class="my-6 border-gray-200">
         <div class="flex flex-col sm:flex-row gap-4 mt-6">
             <a id="forum-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">
                 Diskusi Forum
             </a>
             <a id="predictions-link" href="#" class="flex-1 text-center bg-custom-blue-100 text-custom-blue-400 font-semibold py-2 px-4 rounded-lg hover:bg-custom-blue-200 transition-colors">
                 Lihat Prediksi
             </a>
         </div>
    </div> {# --- End #tournament-content --- #}
</div>
{% endtimezone %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tournamentId = document.body.dataset.tournamentId;
        if (!tournamentId) {
            console.error("Tournament ID not found on body tag.");
            return;
        }

        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const contentDiv = document.getElementById('tournament-content');

        // Elemen Placeholder
        const bannerContainer = document.getElementById('tournament-banner-container');
        const nameEl = document.getElementById('tournament-name');
        const organizerLink = document.getElementById('organizer-link');
        const datesEl = document.getElementById('tournament-dates');
        const descriptionEl = document.getElementById('tournament-description');
        const matchList = document.getElementById('match-list');
        const noMatchesMessage = document.getElementById('no-matches-message');
        const forumLink = document.getElementById('forum-link');
        const predictionsLink = document.getElementById('predictions-link');
        
        const defaultBannerSvg = `
            <div class="w-full h-48 md:h-64 bg-custom-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-16 h-16 text-custom-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10m0-2.657A8 8 0 0121.657 15S21 13 19 12m0 6.657a8 8 0 01-11.314-11.314m1.414 1.414A6 6 0 0119 12m-2 2a6 6 0 01-5.586 5.586"></path></svg>
            </div>`;

        async function fetchTournamentDetails() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            contentDiv.classList.add('hidden');

            try {
                // Menggunakan URL JSON yang benar
                const response = await fetch(`/tournaments/json/${tournamentId}/`); 

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                // --- Isi Banner ---
                // DIUBAH: Logika banner sekarang hanya mengecek jika data.banner_url ada (truthy)
                if (data.banner_url) {
                     bannerContainer.innerHTML = `<img src="${data.banner_url}" alt="Banner ${data.name}" class="w-full h-48 md:h-64 object-cover rounded-lg" onerror="this.replaceWith(this.ownerDocument.createRange().createContextualFragment(defaultBannerSvg))">`;
                } else {
                     bannerContainer.innerHTML = defaultBannerSvg;
                }

                // --- Isi Info Dasar ---
                nameEl.textContent = data.name;
                organizerLink.textContent = data.organizer_username;
                organizerLink.href = data.organizer_profile_url;
                datesEl.textContent = `${data.start_date_formatted} - ${data.end_date_formatted}`;
                descriptionEl.innerHTML = data.description ? data.description.replace(/\n/g, '<br>') : 'Tidak ada deskripsi.';

                // --- Isi Daftar Pertandingan ---
                matchList.innerHTML = ''; // Bersihkan list
                if (data.matches && data.matches.length > 0) {
                    noMatchesMessage.classList.add('hidden');
                    data.matches.forEach(match => {
                        const scoreDisplay = match.is_finished
                            ? `<span class="font-bold">${match.home_score} - ${match.away_score}</span>`
                            : `<span class="text-sm font-normal text-custom-blue-200">Belum Dimulai</span>`;

                        const matchHtml = `
                        <div class="p-4 border border-custom-blue-100 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-custom-blue-50/30">
                            <div class="flex-1 mb-2 sm:mb-0">
                                <span class="font-semibold text-custom-blue-400">${match.home_team_name}</span>
                                <span class="text-gray-500"> vs </span>
                                <span class="font-semibold text-custom-blue-400">${match.away_team_name}</span>
                                <p class="text-xs text-custom-blue-300 mt-1">${match.match_date_formatted}</p>
                            </div>
                            <div class="text-lg text-custom-blue-400">
                                ${scoreDisplay}
                            </div>
                        </div>
                        `;
                        matchList.insertAdjacentHTML('beforeend', matchHtml);
                    });
                } else {
                    noMatchesMessage.classList.remove('hidden'); // Tampilkan pesan 'tidak ada pertandingan'
                }

                // --- Isi Tautan ---
                forumLink.href = data.forum_url;
                predictionsLink.href = data.predictions_url;

                // --- Tampilkan Konten ---
                contentDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching tournament details:", error);
                errorMessage.classList.remove('hidden');
                if (typeof showToast === 'function') {
                    showToast('Gagal memuat detail turnamen.', 'error');
                }
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Panggil fetch saat halaman dimuat
        fetchTournamentDetails();
    });
</script>
{% endblock main_content %}
